<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Confetti Animator</title>
  <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
  <style>
    /* VARIABLES */
    :root {
      --primary: #1890FF; --primary-hover: #40a9ff;
      --background: #FFFFFF; --foreground: #0f172a;
      --muted: #f1f5f9; --muted-darker: #e2e8f0; --muted-foreground: #64748b;
      --border: #e2e8f0; --radius: 8px;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --slider-track: #E5E7EB; --switch-bg: #E5E7EB;
      --handle-color: #1890FF; --control-color: #FF4D4F;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background-color: var(--background); color: var(--foreground); height: 100vh; display: flex; flex-direction: column; }

    /* --- GLOBAL INPUT TWEAKS --- */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; text-align: center; }

    /* LAYOUT */
    .header { height: 56px; display: flex; justify-content: space-between; align-items: center; padding: 0 24px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .title { font-weight: 600; font-size: 16px; display: flex; align-items: center; gap: 8px; }
    .close-btn { cursor: pointer; color: var(--muted-foreground); padding: 4px; }
    .main-layout { flex: 1; display: flex; overflow: hidden; position: relative; }
    .settings-panel { width: 440px; padding: 24px; border-right: 1px solid var(--border); overflow-y: auto; display: flex; flex-direction: column; gap: 24px; }
    .preview-panel { flex: 1; padding: 24px; background-color: #fafafa; display: flex; flex-direction: column; }

    /* COMMON COMPONENTS */
    .tabs-list { display: flex; background-color: var(--muted); padding: 4px; border-radius: var(--radius); }
    .tab-trigger { flex: 1; text-align: center; padding: 6px; font-size: 12px; font-weight: 500; border-radius: calc(var(--radius) - 2px); cursor: pointer; color: var(--muted-foreground); transition: all 0.2s; position: relative; }
    .tab-trigger[data-state="active"] { background-color: var(--background); color: var(--foreground); box-shadow: var(--shadow-sm); }
    
    .tab-trigger.disabled { opacity: 0.5; cursor: not-allowed; }
    .color-item-row.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }

    [data-tooltip]:hover::after {
        content: attr(data-tooltip);
        position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%);
        background: #1e293b; color: white; padding: 4px 8px; border-radius: 4px;
        font-size: 11px; white-space: nowrap; pointer-events: none; z-index: 100;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .label { font-size: 14px; font-weight: 500; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
    .slider-container { position: relative; height: 36px; background-color: var(--slider-track); border-radius: var(--radius); overflow: hidden; }
    .slider-fill { position: absolute; height: 100%; background-color: var(--primary); border-radius: var(--radius) 0 0 var(--radius); transition: width 0.1s ease-out; }
    .slider-value-input { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-weight: 600; font-size: 14px; color: var(--foreground); pointer-events: auto; z-index: 10; border: 1px solid transparent; background: transparent; width: 60px; text-align: right; padding: 4px; border-radius: 4px; outline: none; font-family: inherit; transition: all 0.2s; }
    .slider-input { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; margin: 0; z-index: 3; }
    .slider-labels-row { display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: var(--muted-foreground); }
    
    .toggle-row-container { display: flex; flex-direction: column; gap: 12px; }
    .toggle-row { display: flex; justify-content: space-between; align-items: center; height: 36px; }
    .toggle-label { font-size: 14px; font-weight: 500; }
    .switch { position: relative; display: inline-block; width: 36px; height: 20px; flex-shrink: 0; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .switch-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--switch-bg); transition: .4s; border-radius: 20px; }
    .switch-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: var(--shadow-sm); }
    input:checked + .switch-slider { background-color: var(--primary); }
    input:checked + .switch-slider:before { transform: translateX(16px); }

    .section-divider { height: 1px; background-color: var(--border); border: none; margin: 0; width: 100%; }
    .section-disabled { opacity: 0.4; pointer-events: none; filter: grayscale(100%); transition: all 0.3s; }
    .color-header-box { display: flex; justify-content: space-between; align-items: center; background-color: var(--muted); padding: 8px 12px; border-radius: var(--radius); margin-bottom: 8px; height: 40px; box-sizing: border-box; }
    .color-count-text { font-size: 14px; font-weight: 500; }
    
    .icon-btn-flat { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; color: var(--foreground); cursor: pointer; padding: 0; border-radius: 4px; transition: background-color 0.2s; }
    .icon-btn-flat:hover:not(:disabled) { background-color: var(--muted-darker); }
    .icon-btn-flat:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .color-list-container { display: flex; flex-direction: column; gap: 12px; }
    .color-toggle-row { display: flex; align-items: center; justify-content: space-between; }
    .color-toggle-label { display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; }
    .rainbow-icon { width: 24px; height: 24px; border-radius: 6px; background: linear-gradient(135deg, #FFD700, #FF8C00, #FF6B6B, #1890FF); }
    .scrollable-grid-container { max-height: 120px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius); background-color: transparent; padding: 8px; margin-top: 8px; }
    .color-item-row { display: flex; align-items: center; gap: 12px; transition: opacity 0.3s; padding: 4px 0; }
    .color-preview-sq { width: 24px; height: 24px; border-radius: 6px; border: 1px solid var(--border); box-sizing: border-box; cursor: pointer; }
    .color-hex-text { flex: 1; font-size: 14px; font-weight: 500; font-variant-numeric: tabular-nums; }
    .color-percent-input { width: 48px; font-size: 14px; font-weight: 500; font-family: inherit; color: var(--foreground); border: 1px solid transparent; background: transparent; border-radius: 4px; padding: 2px 4px; }
    
    /* SHAPES */
    .shape-tabs { display: flex; gap: 16px; border-bottom: 1px solid var(--border); margin-bottom: 24px; align-items: center; justify-content: space-between; }
    .shape-tabs-triggers { display: flex; gap: 16px; }
    .shape-tab-trigger { padding: 8px 0; font-size: 14px; font-weight: 500; color: var(--muted-foreground); cursor: pointer; position: relative; transition: color 0.2s; }
    .shape-tab-trigger[data-state="active"] { color: var(--primary); }
    .shape-tab-trigger[data-state="active"]::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background-color: var(--primary); }
    .selector-grid { display: flex; gap: 8px; flex-wrap: nowrap; align-items: center; width: 100%; }
    .selector-item { flex: 1; height: 40px; min-width: 0; display: flex; align-items: center; justify-content: center; border: 2px solid var(--border); border-radius: var(--radius); color: var(--muted-foreground); cursor: pointer; position: relative; background: var(--background); transition: all 0.2s; flex-shrink: 0; }
    .selector-item[data-state="selected"] { border-color: var(--primary); color: var(--primary); background-color: #f0f9ff; }
    .selector-check { position: absolute; top: -6px; right: -6px; width: 18px; height: 18px; background: var(--primary); border-radius: 50%; border: 2px solid var(--background); display: none; align-items: center; justify-content: center; color: white; }
    .selector-item[data-state="selected"] .selector-check { display: flex; }
    .vertical-divider { width: 1px; height: 40px; background-color: var(--border); flex-shrink: 0; flex-grow: 0; }
    .custom-shape-btn { flex: 2; padding: 0 4px; gap: 6px; font-size: 13px; font-weight: 500; white-space: nowrap; }
    .emoji-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; }
    .emoji-item { width: 40px; height: 40px; font-size: 24px; display: flex; align-items: center; justify-content: center; border: 1px solid transparent; border-radius: var(--radius); cursor: pointer; transition: all 0.2s; }
    .emoji-item[data-state="selected"] { background-color: #f0f9ff; border-color: var(--primary); }

    /* CUSTOM SHAPE EDITOR POPOVER */
    .custom-shape-popover { position: fixed; top: 50%; left: 65%; transform: translate(-50%, -50%); width: 380px; min-height: 500px; background: var(--background); border-radius: 12px; box-shadow: var(--shadow-md); padding: 20px; z-index: 20; display: none; flex-direction: column; border: 1px solid var(--border); box-sizing: border-box; justify-content: space-between; }
    .cs-canvas-container { width: 320px; height: 320px; background-color: var(--muted); border: 1px solid var(--border); border-radius: var(--radius); margin: 16px auto; position: relative; background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; flex-shrink: 0; }
    #csEditorSvg { width: 100%; height: 100%; overflow: visible; }
    .cs-anchor { fill: var(--handle-color); stroke: white; stroke-width: 2px; cursor: grab; }
    .cs-control { fill: var(--control-color); stroke: white; stroke-width: 2px; cursor: grab; }
    .cs-connector { stroke: var(--muted-foreground); stroke-width: 1px; stroke-dasharray: 4 4; pointer-events: none; }
    .cs-path-preview { fill: var(--primary); opacity: 0.8; stroke: var(--primary-hover); stroke-width: 2px; pointer-events: none; }
    .cs-reset-icon { position: absolute; top: 8px; right: 8px; background-color: var(--background); border: 1px solid var(--border); border-radius: 4px; padding: 4px; cursor: pointer; color: var(--muted-foreground); display: none; }
    #csSaveBtn { flex-shrink: 0; width: 100%; }

    /* FOOTER & PREVIEW */
    .footer { display: flex; margin-top: -8px; padding-top: 0; }
    .btn { height: 44px; border-radius: var(--radius); font-weight: 600; font-size: 14px; cursor: pointer; border: none; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; }
    .btn-primary { flex: 3; background-color: var(--primary); color: white; }
    .btn-primary:hover { background-color: var(--primary-hover); }
    .btn-outline { flex: 1; background-color: transparent; border: 1px solid var(--border); color: var(--foreground); }
    .btn-outline:hover { background-color: var(--muted); }
    .preview-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
    .preview-canvas { flex: 1; background: var(--background); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 16px; overflow: hidden; background-image: radial-gradient(circle, #e2e8f0 1px, transparent 1px); background-size: 20px 20px; display: flex; align-items: center; justify-content: center; color: var(--muted-foreground); position: relative; }
    #panzoomContainer { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; cursor: grab; }
    #previewSvg { max-width: 100%; max-height: 100%; pointer-events: none; }
    .preview-footer { display: flex; }
    .number-input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .number-input-field { width: 64px; height: 32px; padding: 0 8px; border: 1px solid var(--border); border-radius: var(--radius); background-color: var(--muted); color: var(--foreground); font-size: 13px; font-weight: 600; text-align: center; outline: none; transition: border-color 0.2s; }
    .grouped-settings-box { border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; display: flex; flex-direction: column; gap: 12px; }
    .grouped-settings-box .number-input-row { margin-bottom: 0; }

    /* -------------------------------- */
    /* --- UPDATED COLOR PICKER STYLES --- */
    .color-picker-popover {
        position: absolute; top: 0; left: 0; width: 320px;
        background: var(--background); border-radius: 12px;
        box-shadow: var(--shadow-md); padding: 20px; z-index: 10;
        display: none; border: 1px solid var(--border); box-sizing: border-box;
        flex-direction: column; 
        min-height: auto;
        max-height: 85vh; /* Safety limit */
    }
    
    /* --- NEW MINI POPOVER STYLE --- */
    .mini-color-popover {
        position: fixed;
        z-index: 100;
        background: var(--background);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-md);
        border-radius: 12px;
        padding: 12px;
        width: 260px;
        display: none;
    }
    /* Compact shared picker styles when inside mini popover */
    .mini-color-popover .cp-inputs-row { margin-bottom: 0; }
    .mini-color-popover .cp-sat-bright-area { height: 160px; }
    
    #miniSaveBtn { margin-top: 12px; width: 100%; height: 32px; font-size: 13px; }
    /* ------------------------------ */

    .cp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-weight: 600; flex-shrink: 0; }
    
    /* Left Aligned Tabs */
    .cp-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 16px; flex-shrink: 0; justify-content: flex-start; gap: 8px; }
    .cp-tab { text-align: center; padding: 10px 16px; cursor: pointer; color: var(--muted-foreground); font-weight: 500; font-size: 14px; border-bottom: 2px solid transparent; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
    .cp-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .cp-tab svg path { fill: currentColor; }

    /* SHARED PICKER CONTROLS */
    .cp-content-scrollable { flex: 1; overflow-y: auto; margin-bottom: 16px; padding-right: 4px; -ms-overflow-style: none; scrollbar-width: none; }
    .cp-content-scrollable::-webkit-scrollbar { display: none; }
    .cp-sat-bright-area { width: 100%; height: 200px; border-radius: 8px; position: relative; background: linear-gradient(to top, #000, transparent), linear-gradient(to right, #fff, transparent); background-color: red; cursor: crosshair; margin-bottom: 16px; flex-shrink: 0; }
    .cp-sb-selector { position: absolute; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.5); transform: translate(-8px, -8px); top: 0%; left: 100%; pointer-events: none; }
    .cp-sliders { display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px; flex-shrink: 0; }
    .cp-slider-track { width: 100%; height: 16px; border-radius: 8px; position: relative; cursor: pointer; }
    .cp-hue-slider { background: linear-gradient(to right, red, yellow, green, cyan, blue, magenta, red); }
    .cp-alpha-slider { background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 10px 10px; background-position: 0 0, 0 5px, 5px -5px, -5px 0px; }
    .cp-alpha-slider-bar { position: absolute; top:0; left:0; width: 100%; height: 100%; border-radius: 8px; background: linear-gradient(to right, transparent, red); pointer-events: none;}
    .cp-slider-thumb { position: absolute; top: 50%; width: 20px; height: 20px; background: white; border-radius: 50%; box-shadow: var(--shadow-sm); transform: translate(-10px, -50%); pointer-events: none; border: 1px solid var(--border); }
    .cp-inputs-row { display: flex; gap: 8px; margin-bottom: 16px; flex-shrink: 0; }
    .cp-input-wrapper { display: flex; align-items: center; background: var(--muted); border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px; height: 36px; box-sizing: border-box; }
    
    /* MODIFIED: Divider for Hex Input */
    .cp-hex-wrapper span { border-right: 1px solid var(--border); padding-right: 8px; margin-right: 8px; color: var(--muted-foreground); font-size: 13px; font-weight: 500; height: 20px; display: flex; align-items: center; }
    
    .cp-input-field { border: none; background: transparent; outline: none; font-family: inherit; font-weight: 500; font-size: 14px; color: var(--foreground); flex: 1; width: 100%; }
    .cp-hex-wrapper { flex: 2; } .cp-alpha-wrapper { flex: 1; }
    .cp-swatches-section { flex-shrink: 0; }
    .cp-swatch-grid { display: flex; flex-wrap: wrap; gap: 10px; }
    .cp-swatch { width: 24px; height: 24px; border-radius: 6px; cursor: pointer; border: 1px solid var(--border); box-sizing: border-box; }
    
    /* LINEAR UI */
    #cpLinearContent { display: none; flex-direction: column; gap: 16px; }
    .linear-controls-row { display: flex; justify-content: space-between; align-items: center; }
    .custom-dropdown { position: relative; }
    .dropdown-trigger { border: 1px solid var(--border); border-radius: 6px; padding: 6px 12px; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px; background: white; cursor: pointer; }
    .dropdown-content { position: absolute; top: 100%; left: 0; width: 140px; background: white; border: 1px solid var(--border); border-radius: 6px; box-shadow: var(--shadow-md); display: none; flex-direction: column; z-index: 20; margin-top: 4px; overflow: hidden; }
    .dropdown-content.show { display: flex; }
    .dropdown-item { padding: 8px 12px; font-size: 14px; cursor: pointer; transition: background 0.2s; }
    .dropdown-item.selected { background: #f0f9ff; color: var(--primary); }
    .linear-actions { display: flex; gap: 4px; }

    /* GRADIENT SLIDER FIXED */
    /* MODIFIED: Cursor crosshair added to indicate click-to-add */
    .gradient-slider-container { position: relative; height: 120px; display: flex; align-items: center; overflow: visible; margin: 0 18px 40px 18px; cursor: crosshair; }
    .gradient-bar { width: 100%; height: 100%; border-radius: 8px; background: linear-gradient(90deg, #D966FF 0%, #823D99 100%); position: relative; }
    
    /* MODIFIED: Rotated handles (180deg) to point upwards into the bottom of the bar */
    .gradient-handle { position: absolute; top: 100%; margin-top: 2px; width: 28px; height: 31px; cursor: grab; transform: translateX(-50%) rotate(180deg); z-index: 10; overflow: visible; }
    .gradient-handle svg { width: 100%; height: 100%; drop-shadow: 0 -2px 2px rgba(0,0,0,0.2); }
    .gradient-handle.active svg path { stroke: var(--primary) !important; stroke-width: 3px !important; z-index: 20; }
    .gradient-handle:active { cursor: grabbing; }

    /* STOPS LIST LAYOUT */
    .stops-section { display: flex; flex-direction: column; gap: 8px; }
    .stops-header { display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 14px; }
    .stops-list { display: flex; flex-direction: column; gap: 8px; }
    .stop-row { display: flex; align-items: center; gap: 12px; }
    .stop-row.active .stop-data-group { border-color: var(--primary); }
    
    /* MODIFIED: Tighter width (52px) and gap for Stop Input */
    .stop-pos-group { background: var(--muted); border: 1px solid var(--border); border-radius: 6px; width: 52px; padding: 0 4px 0 0; display: flex; align-items: center; justify-content: center; height: 32px; gap: 2px; }
    .stop-pos-input { width: 100%; background: transparent; border: none; outline: none; font-size: 13px; font-weight: 500; text-align: right; color: var(--foreground); padding-right: 0; }
    
    .stop-data-group { flex: 1; display: flex; align-items: center; gap: 8px; background: var(--muted); border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px; height: 32px; transition: border-color 0.2s; }
    .stop-swatch { width: 20px; height: 20px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; }
    .stop-hex { flex: 1; background: transparent; border: none; outline: none; font-size: 13px; font-weight: 500; text-transform: uppercase; width: 50px; }
    
    /* MODIFIED: Added padding right for % icon spacing */
    .stop-opacity-group { display: flex; align-items: center; gap: 2px; border-left: 1px solid #ddd; padding-left: 8px; padding-right: 8px; }
    .stop-opacity { width: 28px; background: transparent; border: none; outline: none; font-size: 13px; }
    
    .stop-remove-btn { background: transparent; border: none; cursor: pointer; padding: 0; display: flex; align-items: center; color: #888; margin-left: 4px; }
    .stop-remove-btn:hover { color: #d00; }

    /* Button Fix */
    #cpAddConfirmBtn { flex-shrink: 0; height: 46px; min-height: 46px; font-size: 14px; font-weight: 600; flex-grow: 0; margin-top: auto; }

  </style>
</head>
<body>

  <div id="hiddenPickerStorage" style="display: none;"></div>
  
  <div id="miniColorPopover" class="mini-color-popover">
      <button id="miniSaveBtn" class="btn btn-primary" onclick="event.stopPropagation(); closeMiniPopover()">Save</button>
  </div>

  <div class="header">
    <div class="title"><span>ðŸŽ‰</span> Confetti Animator</div>
    <div class="close-btn" id="closeBtn">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </div>
  </div>

  <div class="main-layout">
<div class="settings-panel">
    <div class="tabs-list" style="margin-bottom: -4px;"><div class="tab-trigger" data-state="active" style="font-size: 14px; padding: 8px;">Free Fall</div><div class="tab-trigger disabled" data-tooltip="Coming soon!" style="font-size: 14px; padding: 8px;">Impact Fall</div></div>
    <div style="margin-bottom: 4px; margin-top: 0px;"><div class="shape-tabs"><div class="shape-tabs-triggers"><div class="shape-tab-trigger" data-target="preset" data-state="active">Shapes</div><div class="shape-tab-trigger" data-target="emoji">Emoji</div></div></div><div id="presetShapesContainer" style="display: block;"><div class="selector-grid id-shape-selector"><div class="selector-item" data-state="selected" data-value="rectangle"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="7" width="18" height="10" rx="2"/></svg><div class="selector-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div></div><div class="selector-item" data-value="square"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2"/></svg><div class="selector-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div></div><div class="selector-item" data-state="selected" data-value="circle"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/></svg><div class="selector-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div></div><div class="selector-item" data-state="selected" data-value="star"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg><div class="selector-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div></div><div class="selector-item" data-value="wave"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16.625 18C17.6917 15.3333 16.7583 14.2667 13.825 14.8C11.1583 15.6 10.3583 14.6667 11.425 12C12.7583 9.33333 11.9583 8.4 9.025 9.2C6.09167 10 5.29167 8.93333 6.625 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg><div class="selector-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div></div><div class="vertical-divider"></div><div class="selector-item custom-shape-btn" id="customShapeBtn" data-value="custom"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_2154_386615)"><path d="M21 8.25V15.75M5.25 2.824L18.75 5.524M3 18.75V5.25M18.75 18.476L5.25 21.176M0.75 0.75H5.25V5.25H0.75V0.75ZM18.75 3.75H23.25V8.25H18.75V3.75ZM18.75 15.75H23.25V20.25H18.75V15.75ZM0.75 18.75H5.25V23.25H0.75V18.75Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></g><defs><clipPath id="clip0_2154_386615"><rect width="24" height="24" fill="white"/></clipPath></defs></svg><span>Custom</span><div class="selector-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div></div></div></div><div id="emojiShapesContainer" style="display: none;"><div class="scrollable-grid-container"><div class="emoji-grid" id="emojiGrid"></div></div></div></div>
    <hr style="border: 0; border-top: 1px solid #E2E8F0; margin: 0 0 12px 0;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;"><div><div class="label">Randomize Particles</div><div class="slider-container"><div class="slider-fill" id="randomFill" style="width: 60%;"></div><input type="text" class="slider-value-input" id="randomValueInput" value="60%"><input type="range" id="randomInput" class="slider-input" min="0" max="100" value="60"></div><div class="slider-labels-row"><span>Uniform</span><span>Chaotic</span></div></div><div><div class="label">Particle Amount</div><div class="slider-container"><div class="slider-fill" id="amountFill" style="width: 20%;"></div><input type="text" class="slider-value-input" id="amountValueInput" value="20%"><input type="range" id="amountInput" class="slider-input" min="0" max="100" value="20"></div><div class="slider-labels-row"><span>Less</span><span>More</span></div></div></div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;"><div><div class="label">Particle Size</div><div class="slider-container"><div class="slider-fill" id="zoomFill" style="width: 20%;"></div><input type="text" class="slider-value-input" id="zoomValueInput" value="x1.0"><input type="range" id="zoomInput" class="slider-input" min="0" max="50" value="10"></div><div class="slider-labels-row"><span>x0.0</span><span>x5.0</span></div></div><div></div></div>
    <div class="toggle-row-container"><div class="toggle-row"><span class="toggle-label">Randomize Size</span><label class="switch"><input type="checkbox" id="checkSize" checked><span class="switch-slider"></span></label></div><div class="toggle-row"><span class="toggle-label">Randomize Rotation</span><label class="switch"><input type="checkbox" id="checkRotation" checked><span class="switch-slider"></span></label></div></div>
    <hr style="border: 0; border-top: 1px solid #E2E8F0; margin: 8px 0 0 0;">
    <div id="particleColorSection"><div class="label" style="margin-top: 4px; margin-bottom: 24px;">Confetti Color</div><div class="color-toggle-row" style="margin-bottom: 12px;"><div class="color-toggle-label"><div class="rainbow-icon"></div><span>Multi-color</span></div><label class="switch"><input type="checkbox" id="multiColorSwitch"><span class="switch-slider"></span></label></div><div class="color-header-box"><span class="color-count-text" id="colorCounter">0 Colors</span><button class="icon-btn-flat" id="addColorBtn"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button></div><div class="color-list-container"><div class="scrollable-grid-container"><div id="colorRowsContainer" style="display: flex; flex-direction: column; gap: 8px;"></div></div></div></div>
    <hr style="border: 0; border-top: 1px solid #E2E8F0; margin: 8px 0 0 0;">
    <div style="margin-top: 8px;"><div class="label" style="margin-bottom: 24px;">Animation Settings</div><div class="grouped-settings-box" style="padding: 10px; gap: 8px;"><div class="number-input-row"><span class="toggle-label">Animation Delay (ms)</span><input type="number" id="frameDelayInput" class="number-input-field" value="75" min="1"></div><div class="number-input-row"><span class="toggle-label">Frame Count (Min 1)</span><input type="number" id="frameCountInput" class="number-input-field" value="10" min="1"></div></div></div>
    <hr class="section-divider"><div class="footer"><button id="resetBtn" class="btn btn-outline">Reset</button></div>
</div>
    
    <div class="preview-panel">
        <div class="preview-title">Preview</div>
        <div class="preview-canvas">
            <div id="panzoomContainer">
                 <svg id="previewSvg" width="100%" height="100%" viewBox="0 0 1440 1080" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet"></svg>
            </div>
        </div>
        <div class="preview-footer"><button id="generateBtn" class="btn btn-primary">Generate Confetti</button></div>
    </div>
  </div> 
  
  <div id="colorPickerPopover" class="color-picker-popover">
      <div class="cp-header">
          <span id="cpHeaderTitle">Add Color</span>
          <button id="cpCloseBtn" class="icon-btn-flat">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
      </div>
      
      <div class="cp-tabs">
          <div class="cp-tab active" data-tab="solid" onclick="switchColorTab('solid')">
              <svg width="18" height="18" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16.2256 0C19.111 0.000212537 21.45 2.34021 21.4502 5.22559V16.2256C21.45 19.111 19.111 21.45 16.2256 21.4502H5.22559C2.34021 21.45 0.000211419 19.111 0 16.2256V5.22559C0.000211139 2.34021 2.34021 0.000211141 5.22559 0H16.2256ZM5.22559 1.65039C3.25148 1.6506 1.6506 3.25148 1.65039 5.22559V16.2256C1.6506 18.1997 3.25148 19.7996 5.22559 19.7998H16.2256C18.1997 19.7996 19.7996 18.1997 19.7998 16.2256V5.22559C19.7996 3.25148 18.1997 1.6506 16.2256 1.65039H5.22559ZM16.2256 3.02539C17.4406 3.02539 18.4258 4.01056 18.4258 5.22559V16.2256C18.4258 17.4406 17.4406 18.4258 16.2256 18.4258H5.22559C4.01057 18.4258 3.0254 17.4406 3.02539 16.2256V5.22559C3.02539 4.01056 4.01056 3.02539 5.22559 3.02539H16.2256Z" fill="currentColor"/></svg>
              <span>Solid</span>
          </div>
          <div class="cp-tab" data-tab="linear" onclick="switchColorTab('linear')">
              <svg width="18" height="18" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16.2256 0C19.111 0.000212537 21.45 2.34021 21.4502 5.22559V16.2256C21.45 19.111 19.111 21.45 16.2256 21.4502H5.22559C2.34021 21.45 0.000211419 19.111 0 16.2256V5.22559C0.000211139 2.34021 2.3402 0.000207855 5.22559 0H16.2256ZM5.22559 1.65039C3.25148 1.6506 1.6506 3.25148 1.65039 5.22559V16.2256C1.6506 18.1997 3.25147 19.7996 5.22559 19.7998H16.2256C18.1997 19.7996 19.7996 18.1997 19.7998 16.2256V5.22559C19.7996 3.25148 18.1997 1.6506 16.2256 1.65039H5.22559ZM4.55762 13.3975C5.40525 13.3975 6.0896 14.0811 6.08984 14.9287C6.08984 15.7765 5.4054 16.4609 4.55762 16.4609C3.70988 16.4609 3.02539 15.7765 3.02539 14.9287C3.02563 14.0812 3.71003 13.3975 4.55762 13.3975ZM8.64355 13.9082C9.20514 13.9083 9.6648 14.3672 9.66504 14.9287C9.66504 15.4905 9.20529 15.9501 8.64355 15.9502C8.08177 15.9502 7.62207 15.4905 7.62207 14.9287C7.62231 14.3671 8.08192 13.9082 8.64355 13.9082ZM12.7295 13.9082C13.291 13.9084 13.7507 14.3672 13.751 14.9287C13.751 15.4904 13.2911 15.95 12.7295 15.9502C12.1677 15.9502 11.708 15.4905 11.708 14.9287C11.7083 14.3671 12.1679 13.9082 12.7295 13.9082ZM16.8145 14.418C17.1003 14.418 17.325 14.6429 17.3252 14.9287C17.3252 15.2147 17.1005 15.4395 16.8145 15.4395C16.5286 15.4392 16.3037 15.2146 16.3037 14.9287C16.3039 14.6431 16.5288 14.4182 16.8145 14.418ZM4.55762 9.31152C5.4054 9.31152 6.08984 9.99596 6.08984 10.8438C6.08968 11.6914 5.4053 12.376 4.55762 12.376C3.70998 12.3759 3.02556 11.6914 3.02539 10.8438C3.02539 9.996 3.70988 9.31158 4.55762 9.31152ZM8.64355 9.82227C9.20529 9.82233 9.66504 10.282 9.66504 10.8438C9.66487 11.4054 9.20518 11.8652 8.64355 11.8652C8.08187 11.8652 7.62224 11.4054 7.62207 10.8438C7.62207 10.282 8.08177 9.82227 8.64355 9.82227ZM12.7295 9.82227C13.2911 9.82245 13.751 10.2821 13.751 10.8438C13.7508 11.4053 13.291 11.865 12.7295 11.8652C12.1678 11.8652 11.7082 11.4054 11.708 10.8438C11.708 10.282 12.1677 9.82227 12.7295 9.82227ZM16.8145 10.333C17.1005 10.333 17.3252 10.5577 17.3252 10.8438C17.325 11.1296 17.1004 11.3545 16.8145 11.3545C16.5288 11.3543 16.3039 11.1295 16.3037 10.8438C16.3037 10.5579 16.5286 10.3332 16.8145 10.333ZM4.55762 5.22559C5.4054 5.22559 6.08984 5.91003 6.08984 6.75781C6.0898 7.60556 5.40538 8.29004 4.55762 8.29004C3.70991 8.28998 3.02544 7.60552 3.02539 6.75781C3.02539 5.91006 3.70988 5.22564 4.55762 5.22559ZM8.64355 5.73633C9.20529 5.73639 9.66504 6.19607 9.66504 6.75781C9.66499 7.31952 9.20526 7.77923 8.64355 7.7793C8.0818 7.7793 7.62212 7.31956 7.62207 6.75781C7.62207 6.19603 8.08177 5.73633 8.64355 5.73633ZM12.7295 5.73633C13.2911 5.73651 13.751 6.19614 13.751 6.75781C13.7509 7.31945 13.2911 7.77911 12.7295 7.7793C12.1677 7.7793 11.7081 7.31956 11.708 6.75781C11.708 6.19603 12.1677 5.73633 12.7295 5.73633ZM16.8145 6.24707C17.1005 6.24707 17.3252 6.47181 17.3252 6.75781C17.3252 7.04377 17.1004 7.26855 16.8145 7.26855C16.5287 7.26834 16.3038 7.04364 16.3037 6.75781C16.3037 6.47195 16.5286 6.24729 16.8145 6.24707Z" fill="currentColor"/></svg>
              <span>Linear</span>
          </div>
      </div>

      <div class="cp-content-scrollable">
          
          <div id="cpSolidContent">
              <div id="sharedPicker">
                  <div class="cp-sat-bright-area" id="cpSatBrightArea"><div class="cp-sb-selector" id="cpSbSelector"></div></div>
                  <div class="cp-sliders"><div class="cp-slider-track cp-hue-slider" id="cpHueSlider"><div class="cp-slider-thumb" id="cpHueThumb"></div></div><div class="cp-slider-track cp-alpha-slider" id="cpAlphaSlider"><div class="cp-alpha-slider-bar" id="cpAlphaBar"></div><div class="cp-slider-thumb" id="cpAlphaThumb"></div></div></div>
                  <div class="cp-inputs-row"><div class="cp-input-wrapper cp-hex-wrapper"><span>Hex</span><input type="text" id="cpHexInput" class="cp-input-field" value="FF0000" maxlength="6"></div><div class="cp-input-wrapper cp-alpha-wrapper"><input type="number" id="cpAlphaInput" class="cp-input-field" value="100" min="0" max="100"><span>%</span></div></div>
              </div>
              <div class="cp-swatches-section"><div class="label" style="margin-bottom: 8px;">Preset Colors</div><div class="cp-swatch-grid" id="cpSwatchGrid"></div></div>
          </div>

          <div id="cpLinearContent">
              <div class="linear-controls-row">
                  <div class="custom-dropdown" id="linearTypeDropdown">
                      <div class="dropdown-trigger" onclick="toggleLinearDropdown()">
                          <span id="linearTypeLabel">Linear</span> 
                          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                      </div>
                      <div class="dropdown-content" id="linearDropdownContent">
                          <div class="dropdown-item selected" onclick="selectLinearType('Linear')">Linear</div>
                          <div class="dropdown-item" onclick="selectLinearType('Radial')">Radial</div>
                          <div class="dropdown-item" onclick="selectLinearType('Angular')">Angular</div>
                          <div class="dropdown-item" onclick="selectLinearType('Diamond')">Diamond</div>
                      </div>
                  </div>
                  <div class="linear-actions">
                      <button class="icon-btn-flat" id="flipHorizontalBtn" title="Flip Horizontal">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.28 10.45L21 6.72998L17.28 3.01001" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 6.72998H21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M6.71997 13.55L3 17.27L6.71997 20.99" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 17.27H3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                      </button>
                      <button class="icon-btn-flat" id="flipVerticalBtn" title="Flip Vertical">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.25 22H11.75C15.5 22 17 20.5 17 16.75V12.25C17 8.5 15.5 7 11.75 7H7.25C3.5 7 2 8.5 2 12.25V16.75C2 20.5 3.5 22 7.25 22Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 9C22 5.13 18.87 2 15 2L16.05 3.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                      </button>
                  </div>
              </div>
              
              <div class="gradient-slider-container" id="gradientSliderContainer">
                  <div class="gradient-bar" id="gradientBar"></div>
                  </div>

              <div class="stops-section">
                  <div class="stops-header">
                      <span>Stops</span>
                      <button class="icon-btn-flat" id="addStopBtn" title="Add Stop">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                      </button>
                  </div>
                  <div class="stops-list" id="stopsListContainer">
                      </div>
              </div>
          </div>

      </div> 
      <button id="cpAddConfirmBtn" class="btn btn-primary" style="width: 100%;">Add Color</button>
  </div>

  <div id="customShapePopover" class="custom-shape-popover">
      <div class="cp-header"><span>Custom Shape Editor</span><button id="csCloseBtn" class="icon-btn-flat"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div style="font-size: 12px; color: var(--muted-foreground); margin-bottom: 8px;">Drag points to customize shape.</div><div class="cs-canvas-container"><svg id="csEditorSvg" viewBox="0 0 320 320" xmlns="http://www.w3.org/2000/svg"></svg><div id="csResetIcon" class="cs-reset-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg></div></div><button id="csSaveBtn" class="btn btn-primary">Save Shape</button>
  </div>

  <script>
    // --- (Globals & Previous Logic Unchanged) ---
    const previewSvg = document.getElementById('previewSvg');
    const panzoomContainer = document.getElementById('panzoomContainer');
    const customShapeBtn = document.getElementById('customShapeBtn');
    const customShapePopover = document.getElementById('customShapePopover');
    const csCloseBtn = document.getElementById('csCloseBtn');
    const csSaveBtn = document.getElementById('csSaveBtn');
    const csEditorSvg = document.getElementById('csEditorSvg');
    const csResetIcon = document.getElementById('csResetIcon');
    const presetShapesContainer = document.getElementById('presetShapesContainer');
    const emojiShapesContainer = document.getElementById('emojiShapesContainer');
    const particleColorSection = document.getElementById('particleColorSection');
    const emojiGrid = document.getElementById('emojiGrid');

    let previewParticles = []; let panzoomInstance; let selectedEmoji = null; let activeShapeTab = 'preset'; let finalCustomShapePathStr = ""; let csHistory = []; let selectedEmojis = [];

    // --- HELPER UTILS ---
    function createSvgElement(type, attributes) { const el = document.createElementNS("http://www.w3.org/2000/svg", type); for (const key in attributes) el.setAttribute(key, attributes[key]); return el; }
    function hexToRgb(hex) { const res = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return res ? { r: parseInt(res[1], 16), g: parseInt(res[2], 16), b: parseInt(res[3], 16) } : null; }
    function rgbToHex(r, g, b) { return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase(); }
    
    // --- GRADIENT STATE ---
    let gradientStops = [
        { percent: 0, color: '#D966FF', alpha: 1 },
        { percent: 100, color: '#823D99', alpha: 1 }
    ];
    let isVerticalFlip = false; 
    let activeStopIndex = 0; 

    // --- SETUP SLIDERS (Unchanged) ---
    function setupSlider(sliderInputId, fillId, textInputId, format, regenerateOnChange = true) {
      const sliderInput = document.getElementById(sliderInputId); const fill = document.getElementById(fillId); const textInput = document.getElementById(textInputId);
      const min = parseFloat(sliderInput.min) || 0; const max = parseFloat(sliderInput.max) || 100;
      function updateFromSlider() {
        let val = parseFloat(sliderInput.value); const percent = ((val - min) / (max - min)) * 100; fill.style.width = `${percent}%`;
        if (format === 'percent') { textInput.value = `${Math.round(val)}%`; } else if (format === 'zoom') { textInput.value = `x${(val / 10).toFixed(1)}`; }
        if (!regenerateOnChange) { triggerPreviewUpdate(true, 'scale'); } else { triggerPreviewUpdate(false); }
      }
      function updateFromText() {
          let rawValue = textInput.value; let numericValue;
          if (format === 'percent') { rawValue = rawValue.replace(/[^0-9.]/g, ''); numericValue = parseFloat(rawValue); } else if (format === 'zoom') { rawValue = rawValue.replace(/[^0-9.]/g, ''); numericValue = parseFloat(rawValue); if (!isNaN(numericValue)) { numericValue = Math.round(numericValue * 10); } }
          if (isNaN(numericValue)) { numericValue = parseFloat(sliderInput.value); } else { numericValue = Math.max(min, Math.min(max, numericValue)); }
          sliderInput.value = numericValue; updateFromSlider(); 
      }
      function triggerPreviewUpdate(keepPositions, changeType) { updatePreview(keepPositions, changeType); }
      sliderInput.addEventListener('input', updateFromSlider); textInput.addEventListener('change', updateFromText); textInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') { e.target.blur(); } });
    }
    setupSlider('randomInput', 'randomFill', 'randomValueInput', 'percent', true); setupSlider('amountInput', 'amountFill', 'amountValueInput', 'percent', true); setupSlider('zoomInput', 'zoomFill', 'zoomValueInput', 'zoom', false);

    document.querySelectorAll('.tabs-list .tab-trigger:not(.disabled)').forEach(tab => { tab.addEventListener('click', () => { document.querySelectorAll('.tabs-list .tab-trigger').forEach(t => t.removeAttribute('data-state')); tab.setAttribute('data-state', 'active'); updatePreview(false); }); });
    document.getElementById('checkSize').addEventListener('change', () => updatePreview(true, 'scale')); document.getElementById('checkRotation').addEventListener('change', () => updatePreview(true, 'rotation'));

    let colorState = { isMultiColor: false, colors: [] }; let editingColorIndex = -1;
    const multiColorSwitch = document.getElementById('multiColorSwitch'); const colorRowsContainer = document.getElementById('colorRowsContainer'); const colorCounter = document.getElementById('colorCounter'); const addColorBtn = document.getElementById('addColorBtn');

    function renderColorList() {
        if (colorState.isMultiColor) { colorCounter.textContent = "Multi-color"; } else { colorCounter.textContent = `${colorState.colors.length} Colors`; }
        addColorBtn.disabled = colorState.isMultiColor; colorRowsContainer.innerHTML = '';
        colorState.colors.forEach((colorData, index) => {
            const row = document.createElement('div'); row.className = `color-item-row ${colorState.isMultiColor ? 'disabled' : ''}`;
            // Handle display logic for Linear vs Solid in the LIST
            let hexDisplay = "";
            let opacityDisplay = "";
            let bgStyle = "";
            
            if (colorData.type === 'linear') {
                hexDisplay = "Linear Gradient";
                // --- NEW LOGIC: Default to first stop's alpha for display ---
                opacityDisplay = colorData.stops.length > 0 ? Math.round(colorData.stops[0].alpha * 100) : "100";
                // create CSS gradient string for preview
                const stops = colorData.stops;
                const sorted = [...stops].sort((a,b)=>a.percent-b.percent);
                // MODIFIED: Use 0deg for vertical, 90deg for horizontal (default)
                const angle = colorData.isVertical ? '0deg' : '90deg';
                const css = `linear-gradient(${angle}, ${sorted.map(s => `${s.color} ${s.percent}%`).join(', ')})`;
                bgStyle = `background: ${css};`;
            } else {
                hexDisplay = hslToHex(colorData.h, colorData.s, colorData.l);
                opacityDisplay = Math.round(colorData.a * 100);
                bgStyle = `background-color: ${hexDisplay}; opacity: ${colorData.a};`;
            }

            // --- UPDATED HTML: Removed disabled attribute for linear type inputs ---
            row.innerHTML = `<div class="color-preview-sq" style="${bgStyle}"></div><span class="color-hex-text">${hexDisplay}</span><div style="display: flex; align-items: center; margin-right: 8px;"><input type="number" class="color-percent-input" data-index="${index}" value="${opacityDisplay}" min="0" max="100" ${colorState.isMultiColor ? 'disabled' : ''}><span style="margin-left: 4px; color: var(--muted-foreground); font-size: 14px;">%</span></div><button class="icon-btn-flat delete-color-btn" data-index="${index}" ${colorState.isMultiColor ? 'disabled' : ''}><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg></button>`;
            
            const previewSq = row.querySelector('.color-preview-sq'); 
            previewSq.addEventListener('click', () => { 
                if (colorState.isMultiColor) return; 
                // Logic to open edit for this color
                // Ideally checks type and opens correct tab. For now assuming solid edit flow or recreating gradient logic is complex.
                // Just opening popover
                openPopoverToEdit(index, previewSq); 
            });
            
            // --- NEW LOGIC: Handle opacity change for BOTH solid and linear ---
            const percentInput = row.querySelector('.color-percent-input'); 
            percentInput.addEventListener('change', (e) => { 
                let newVal = parseInt(e.target.value); 
                if (isNaN(newVal)) newVal = 100; 
                newVal = Math.max(0, Math.min(100, newVal)); 
                e.target.value = newVal; 
                
                if (colorData.type === 'linear') {
                    // Update ALL stops alpha to this new value
                    colorState.colors[index].stops.forEach(s => s.alpha = newVal / 100);
                } else {
                    colorState.colors[index].a = newVal / 100; 
                }
                renderColorList(); 
                updatePreview(true, 'color'); 
            });

            const deleteBtn = row.querySelector('.delete-color-btn'); 
            deleteBtn.addEventListener('click', () => { if (colorState.isMultiColor) return; if (editingColorIndex === index) { editingColorIndex = -1; closePopover(); } colorState.colors.splice(index, 1); renderColorList(); updatePreview(true, 'color'); });
            colorRowsContainer.prepend(row);
        });
    }
    multiColorSwitch.addEventListener('change', (e) => { colorState.isMultiColor = e.target.checked; if (colorState.isMultiColor) { closePopover(); editingColorIndex = -1; } renderColorList(); updatePreview(true, 'color'); });

    // --- POP OVER LOGIC (Updated) ---
    const popover = document.getElementById('colorPickerPopover'); const cpCloseBtn = document.getElementById('cpCloseBtn'); const cpAddConfirmBtn = document.getElementById('cpAddConfirmBtn'); const cpHeaderTitle = document.getElementById('cpHeaderTitle');
    
    // --- TAB LOGIC ---
    let currentTab = 'solid';
    window.switchColorTab = function(tabName) {
        currentTab = tabName;
        document.querySelectorAll('.cp-tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.cp-tab[data-tab="${tabName}"]`).classList.add('active');
        
        const sharedPicker = document.getElementById('sharedPicker');
        
        if (tabName === 'solid') {
            document.getElementById('cpSolidContent').style.display = 'block';
            document.getElementById('cpLinearContent').style.display = 'none';
            // CLOSE MINI IF OPEN
            document.getElementById('miniColorPopover').style.display = 'none';
            // MOVE PICKER BACK TO SOLID CONTENT
            const swatchGrid = document.getElementById('cpSwatchGrid');
            if (swatchGrid && swatchGrid.parentElement) {
                swatchGrid.parentElement.parentElement.insertBefore(sharedPicker, swatchGrid.parentElement);
            }
        } else {
            document.getElementById('cpSolidContent').style.display = 'none';
            document.getElementById('cpLinearContent').style.display = 'flex';
            
            // HIDE FROM MAIN FLOW (Move to storage)
            document.getElementById('hiddenPickerStorage').appendChild(sharedPicker);
            
            updateGradientVisuals(); 
        }
    }

    // --- LINEAR UI LOGIC ---
    function toggleLinearDropdown() {
        document.getElementById('linearDropdownContent').classList.toggle('show');
    }
    window.toggleLinearDropdown = toggleLinearDropdown;
    
    function selectLinearType(type) {
        document.getElementById('linearTypeLabel').textContent = type;
        document.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('selected'));
        document.getElementById('linearDropdownContent').classList.remove('show');
    }
    window.selectLinearType = selectLinearType;

    // --- GRADIENT SLIDER LOGIC ---
    const gradientSliderContainer = document.getElementById('gradientSliderContainer');
    const gradientBar = document.getElementById('gradientBar');
    const stopsListContainer = document.getElementById('stopsListContainer');
    
    let draggingHandleIndex = null;

    function renderHandles() {
        // Clear handles (keeping bar)
        const handles = gradientSliderContainer.querySelectorAll('.gradient-handle');
        handles.forEach(h => h.remove());

        gradientStops.forEach((stop, index) => {
            const handle = document.createElement('div');
            handle.className = 'gradient-handle';
            if (index === activeStopIndex) handle.classList.add('active');
            handle.style.left = `${stop.percent}%`;
            handle.innerHTML = `<svg viewBox="0 0 28 31" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.5 4.5C1.5 2.84315 2.84315 1.5 4.5 1.5H23.5C25.1569 1.5 26.5 2.84315 26.5 4.5V21.5C26.5 23.1569 25.1569 24.5 23.5 24.5H20.8526C19.8857 24.5 18.978 24.9661 18.4146 25.7519L16.6805 28.1702C15.5617 29.7306 13.2856 29.8529 12.006 28.4216L9.39447 25.5005C8.82534 24.8639 8.01187 24.5 7.15794 24.5H4.5C2.84315 24.5 1.5 23.1569 1.5 21.5V4.5Z" fill="${stop.color}" stroke="${index === activeStopIndex ? '#1890FF' : 'transparent'}" stroke-width="3"/></svg>`;
            
            handle.addEventListener('mousedown', (e) => onHandleMouseDown(e, index));
            handle.addEventListener('click', (e) => { e.stopPropagation(); setActiveStop(index); });
            gradientSliderContainer.appendChild(handle);
        });
    }

    function updateGradientVisuals() {
    renderHandles();
    const sorted = [...gradientStops].sort((a,b) => a.percent - b.percent);
    const stops = sorted.map(s => { const rgb = hexToRgb(s.color); return `rgba(${rgb.r},${rgb.g},${rgb.b},${s.alpha}) ${s.percent}%`; });
    gradientBar.style.background = `linear-gradient(${isVerticalFlip ? '0deg' : '90deg'}, ${stops.join(', ')})`;
    renderStopsList();
}

    function setActiveStop(index) {
        activeStopIndex = index;
        
        // SYNC MAIN PICKER TO ACTIVE STOP
        const activeStop = gradientStops[index];
        const hsl = hexToHsl(activeStop.color);
        pickerHSLA = { h: hsl.h, s: hsl.s, l: hsl.l, a: activeStop.alpha };
        updatePickerVisuals(); // Update visual sliders
        
        updateGradientVisuals();
    }

    // LISTENER for Main Picker Change (Slider drags)
    // We hook into the updatePickerVisuals cycle essentially by observing when pickerHSLA changes via mouse events
    // But updatePickerVisuals is UI only. We need a function that applies pickerHSLA back to data.
    function applyPickerToActive() {
        if (currentTab === 'linear') {
            const hex = hslToHex(pickerHSLA.h, pickerHSLA.s, pickerHSLA.l);
            gradientStops[activeStopIndex].color = hex;
            gradientStops[activeStopIndex].alpha = pickerHSLA.a;
            updateGradientVisuals();
        }
    }

    function updateStopPosition(e, index) {
        let val = parseInt(e.target.value);
        if (isNaN(val)) val = 0;
        val = Math.max(0, Math.min(100, val));
        
        // Get the active object BEFORE sort
        const activeObj = gradientStops[activeStopIndex];
        
        // Update
        gradientStops[index].percent = val;
        
        // Sort
        gradientStops.sort((a,b) => a.percent - b.percent);
        
        // Re-find Active Index
        activeStopIndex = gradientStops.indexOf(activeObj);
        
        updateGradientVisuals();
    }

    // --- MINI POPOVER FUNCTIONS (UPDATED POSITIONING & STACK BEHAVIOR) ---
    function openMiniColorPopover(e, idx) {
        setActiveStop(idx);
        const popover = document.getElementById('miniColorPopover');
        const sharedPicker = document.getElementById('sharedPicker');
        
        // Move picker to mini popover BEFORE "Save" button
        popover.insertBefore(sharedPicker, document.getElementById('miniSaveBtn'));
        popover.style.display = 'block';

        // --- POSITIONING LOGIC ---
        // 1. Get Main Popover Rect
        const mainPopover = document.getElementById('colorPickerPopover');
        const mainRect = mainPopover.getBoundingClientRect();
        
        // 2. Calculate Position (Left side, aligned bottom)
        const miniWidth = 286; // 260 width + 24 padding + 2 border
        const miniHeight = 300; // approx height
        const gap = 12;

        let left = mainRect.left - miniWidth - gap;
        let top = mainRect.bottom - miniHeight; // align bottom edges

        // 3. Viewport Safety Check
        if (left < 10) left = mainRect.right + gap; // Flip to right if no space on left
        if (top < 10) top = 10;
        
        popover.style.top = `${top}px`;
        popover.style.left = `${left}px`;

        // MODIFIED: Remove main listener temporarily so clicking outside doesn't close main popover
        document.removeEventListener('click', closePopoverOnClickOutside);
        
        // Delay Adding Mini Click Listener
        setTimeout(() => document.addEventListener('click', closeMiniPopoverOnClickOutside), 0);
    }

    function closeMiniPopover() {
        const popover = document.getElementById('miniColorPopover');
        popover.style.display = 'none';
        document.removeEventListener('click', closeMiniPopoverOnClickOutside);
        
        // Move picker back to storage so it doesn't get lost
        document.getElementById('hiddenPickerStorage').appendChild(document.getElementById('sharedPicker'));
        
        // MODIFIED: Re-attach main listener after a tiny delay so it doesn't fire immediately
        setTimeout(() => document.addEventListener('click', closePopoverOnClickOutside), 10);
    }
    
    // Global exposure for the button onclick
    window.closeMiniPopover = closeMiniPopover;

    function closeMiniPopoverOnClickOutside(e) {
        const popover = document.getElementById('miniColorPopover');
        // Close if click outside mini popover AND not on a swatch
        if (!popover.contains(e.target) && !e.target.classList.contains('stop-swatch')) {
            closeMiniPopover();
        }
    }

    function renderStopsList() {
        stopsListContainer.innerHTML = '';
        gradientStops.forEach((stop, idx) => {
            const div = document.createElement('div'); 
            div.className = 'stop-row';
            if (idx === activeStopIndex) div.classList.add('active');
            
            // New Layout with EDITABLE Position
            div.innerHTML = `
                <div class="stop-pos-group">
                    <input class="stop-pos-input" type="number" min="0" max="100" value="${Math.round(stop.percent)}">%
                </div>
                <div class="stop-data-group" onclick="setActiveStop(${idx})">
                    <div class="stop-swatch" style="background-color: ${stop.color};"></div>
                    <input class="stop-hex" value="${stop.color.replace('#','')}" maxlength="6"> 
                    <div class="stop-opacity-group">
                        <input class="stop-opacity" type="number" min="0" max="100" value="${Math.round(stop.alpha * 100)}" data-idx="${idx}">%
                    </div>
                    <button class="stop-remove-btn" onclick="event.stopPropagation(); removeGradientStop(${idx})">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    </button>
                </div>
            `;
            
            // Attach Swatch Click Listener
            const swatch = div.querySelector('.stop-swatch');
            swatch.addEventListener('click', (e) => {
                e.stopPropagation();
                openMiniColorPopover(e, idx);
            });

            // Attach Position Change Listener
            const posInput = div.querySelector('.stop-pos-input');
            posInput.addEventListener('change', (e) => updateStopPosition(e, idx));
            posInput.addEventListener('click', (e) => e.stopPropagation()); 

            // Attach HEX Change Listener (New Editable)
            const hexInput = div.querySelector('.stop-hex');
            hexInput.addEventListener('change', (e) => {
                let val = e.target.value.trim();
                // Basic validation
                if (/^[0-9A-Fa-f]{6}$/.test(val)) {
                    gradientStops[idx].color = '#' + val.toUpperCase();
                    updateGradientVisuals();
                    if(idx === activeStopIndex) {
                        const hsl = hexToHsl('#' + val);
                        pickerHSLA.h = hsl.h; pickerHSLA.s = hsl.s; pickerHSLA.l = hsl.l;
                        updatePickerVisuals();
                    }
                } else {
                    e.target.value = gradientStops[idx].color.replace('#',''); // revert on error
                }
            });
            hexInput.addEventListener('click', (e) => e.stopPropagation()); // prevent row activation if clicking to type

            // Add Opacity listener
            const opInput = div.querySelector('.stop-opacity');
            opInput.addEventListener('change', (e) => {
                let val = parseInt(e.target.value);
                if(isNaN(val)) val = 100;
                val = Math.max(0, Math.min(100, val));
                gradientStops[idx].alpha = val / 100;
                updateGradientVisuals();
                // Also update main picker if this is active
                if(idx === activeStopIndex) {
                    pickerHSLA.a = val / 100;
                    updatePickerVisuals();
                }
            });
            opInput.addEventListener('click', (e) => e.stopPropagation());

            stopsListContainer.appendChild(div);
        });
    }

    // --- CLICK TO ADD STOP (NEW LOGIC) ---
    gradientSliderContainer.addEventListener('click', (e) => {
        // Handle stop propagation prevents this from firing if a handle is clicked,
        // but double check target just in case
        if (e.target.closest('.gradient-handle')) return;

        const rect = gradientSliderContainer.getBoundingClientRect();
        const offsetX = e.clientX - rect.left;
        let percent = (offsetX / rect.width) * 100;
        percent = Math.max(0, Math.min(100, percent));
        
        addStopAtPercent(percent);
    });

    function addStopAtPercent(percent) {
        // Sort current stops to find neighbors
        const sorted = [...gradientStops].sort((a,b) => a.percent - b.percent);
        
        // Find neighbors
        let start = sorted[0];
        let end = sorted[sorted.length - 1];
        
        for (let i = 0; i < sorted.length - 1; i++) {
            if (percent >= sorted[i].percent && percent <= sorted[i+1].percent) {
                start = sorted[i];
                end = sorted[i+1];
                break;
            }
        }
        
        // Interpolate Color
        let newColor = '#FF0000';
        let newAlpha = 1;

        if (start && end && start !== end) {
            const range = end.percent - start.percent;
            const ratio = range === 0 ? 0 : (percent - start.percent) / range;
            
            const c1 = hexToRgb(start.color);
            const c2 = hexToRgb(end.color);
            
            if (c1 && c2) {
                const r = Math.round(c1.r + (c2.r - c1.r) * ratio);
                const g = Math.round(c1.g + (c2.g - c1.g) * ratio);
                const b = Math.round(c1.b + (c2.b - c1.b) * ratio);
                newColor = rgbToHex(r,g,b);
            }
            newAlpha = start.alpha + (end.alpha - start.alpha) * ratio;
        } else if (start) {
             newColor = start.color;
             newAlpha = start.alpha;
        }

        const newStop = { percent: percent, color: newColor, alpha: newAlpha };
        gradientStops.push(newStop);
        gradientStops.sort((a,b) => a.percent - b.percent);
        activeStopIndex = gradientStops.indexOf(newStop);
        
        updateGradientVisuals();
        setActiveStop(activeStopIndex);
    }


    // MODIFIED: Re-written Add Stop Logic for Safety and Real-time Update
    document.getElementById('addStopBtn').addEventListener('click', () => {
        // Create a copy for sorting calculation
        const sorted = [...gradientStops].map((s, i) => ({...s, origIndex: i})).sort((a,b) => a.percent - b.percent);
        
        let newStop = null;

        if (sorted.length < 2) {
            // Fallback for edge cases
            newStop = { percent: 50, color: '#FF0000', alpha: 1 };
        } else {
            // Find biggest gap
            let maxGap = 0;
            let gapIndex = 0;
            for(let i = 0; i < sorted.length - 1; i++) {
                const gap = sorted[i+1].percent - sorted[i].percent;
                if(gap > maxGap) { maxGap = gap; gapIndex = i; }
            }
            
            const start = sorted[gapIndex];
            const end = sorted[gapIndex+1];
            
            const newPercent = start.percent + (maxGap / 2);
            
            // Safe interpolation
            let newColor = '#FF0000'; // Default fallback
            try {
                const c1 = hexToRgb(start.color);
                const c2 = hexToRgb(end.color);
                if (c1 && c2) {
                    const r = Math.round((c1.r + c2.r)/2);
                    const g = Math.round((c1.g + c2.g)/2);
                    const b = Math.round((c1.b + c2.b)/2);
                    newColor = rgbToHex(r,g,b);
                }
            } catch(e) { console.log('Color parsing error', e); }
            
            const newAlpha = (start.alpha + end.alpha) / 2;
            
            newStop = { percent: newPercent, color: newColor, alpha: newAlpha };
        }
        
        if (newStop) {
            gradientStops.push(newStop);
            // Sort main array
            gradientStops.sort((a,b) => a.percent - b.percent);
            
            // Update Active Index to the newly created stop
            activeStopIndex = gradientStops.indexOf(newStop);
            
            // Force Render
            updateGradientVisuals();
            setActiveStop(activeStopIndex);
        }
    });

    window.removeGradientStop = function(index) {
        if (gradientStops.length <= 2) return; 
        gradientStops.splice(index, 1);
        if (activeStopIndex >= gradientStops.length) activeStopIndex = gradientStops.length - 1;
        updateGradientVisuals();
    }

    function onHandleMouseDown(e, index) {
        draggingHandleIndex = index;
        setActiveStop(index);
        document.addEventListener('mousemove', onHandleDrag);
        document.addEventListener('mouseup', onHandleStopDrag);
        e.preventDefault(); 
    }

    function onHandleDrag(e) {
        if (draggingHandleIndex === null) return;
        const rect = gradientSliderContainer.getBoundingClientRect();
        const trackWidth = rect.width;
        const offsetX = e.clientX - rect.left;
        
        let percent = (offsetX / trackWidth) * 100;
        percent = Math.max(0, Math.min(100, percent));
        
        gradientStops[draggingHandleIndex].percent = percent;
        updateGradientVisuals();
    }

    function onHandleStopDrag() {
        draggingHandleIndex = null;
        document.removeEventListener('mousemove', onHandleDrag);
        document.removeEventListener('mouseup', onHandleStopDrag);
    }

    document.getElementById('flipHorizontalBtn').addEventListener('click', () => {
        gradientStops.forEach(stop => { stop.percent = 100 - stop.percent; });
        updateGradientVisuals();
    });

    document.getElementById('flipVerticalBtn').addEventListener('click', () => { isVerticalFlip = !isVerticalFlip; updateGradientVisuals(); });


    // --- CONFIRM COLOR (Updated) ---
    function confirmAddColor() {
        if (currentTab === 'solid') {
            const newColorData = { h: pickerHSLA.h, s: pickerHSLA.s, l: pickerHSLA.l, a: pickerHSLA.a, type: 'solid' };
            if (editingColorIndex > -1) { colorState.colors[editingColorIndex] = newColorData; } else { colorState.colors.push(newColorData); }
        } else {
            // Linear Gradient
            // We need to pass all stops
            const newColorData = {
                type: 'linear',
                isVertical: isVerticalFlip,
                stops: JSON.parse(JSON.stringify(gradientStops)) // deep copy
            };
            // Note: Gradient editing index support is complex, assuming new add for now unless editing index was linear type
            // If editingColorIndex > -1, we overwrite
            if (editingColorIndex > -1) { colorState.colors[editingColorIndex] = newColorData; } else { colorState.colors.push(newColorData); }
        }
        renderColorList();
        updatePreview(true, 'color'); 
        closePopover();

        // --- RESET GRADIENT STATE (ADDED) ---
        gradientStops = [
            { percent: 0, color: '#D966FF', alpha: 1 },
            { percent: 100, color: '#823D99', alpha: 1 }
        ];
        isVerticalFlip = false;
        activeStopIndex = 0;

        // Reset Picker to default start color of the new default gradient
        const defaultHsl = hexToHsl(gradientStops[0].color);
        pickerHSLA = { h: defaultHsl.h, s: defaultHsl.s, l: defaultHsl.l, a: 1.0 };
        
        // Refresh Visuals so defaults are shown next time
        updateGradientVisuals();
        updatePickerVisuals();
    }

    // --- (Existing Solid Logic Variables & Listeners) ---
    const cpSatBrightArea = document.getElementById('cpSatBrightArea'); const cpSbSelector = document.getElementById('cpSbSelector'); const cpHueSlider = document.getElementById('cpHueSlider'); const cpHueThumb = document.getElementById('cpHueThumb'); const cpAlphaSlider = document.getElementById('cpAlphaSlider'); const cpAlphaThumb = document.getElementById('cpAlphaThumb'); const cpAlphaBar = document.getElementById('cpAlphaBar'); const cpHexInput = document.getElementById('cpHexInput'); const cpAlphaInput = document.getElementById('cpAlphaInput');
    let isDraggingSB = false; let isDraggingHue = false; let isDraggingAlpha = false;

    function updatePickerVisuals() {
        // Shared visual update for sliders
        cpSatBrightArea.style.backgroundColor = `hsl(${pickerHSLA.h}, 100%, 50%)`;
        const hsv = hslToHsv(pickerHSLA.h, pickerHSLA.s, pickerHSLA.l);
        cpSbSelector.style.left = `${hsv.s}%`; cpSbSelector.style.top = `${100 - hsv.v}%`;
        cpHueThumb.style.left = `${(pickerHSLA.h / 360) * 100}%`;
        cpAlphaThumb.style.left = `${pickerHSLA.a * 100}%`;
        const baseHex = hslToHex(pickerHSLA.h, pickerHSLA.s, pickerHSLA.l);
        cpAlphaBar.style.background = `linear-gradient(to right, transparent, ${baseHex})`;
        cpHexInput.value = baseHex.substring(1); cpAlphaInput.value = Math.round(pickerHSLA.a * 100);
    }

    // MAIN LISTENER MODIFICATIONS FOR SYNC
    function onPickerChange() {
        updatePickerVisuals();
        // Propagate to Linear Active Stop if needed
        applyPickerToActive();
    }

    cpSatBrightArea.addEventListener('mousedown', (e) => { isDraggingSB = true; updateSBFromEvent(e); });
    document.addEventListener('mousemove', (e) => { if(isDraggingSB) updateSBFromEvent(e); if(isDraggingHue) updateHueFromEvent(e); if(isDraggingAlpha) updateAlphaFromEvent(e); });
    document.addEventListener('mouseup', () => { isDraggingSB = false; isDraggingHue = false; isDraggingAlpha = false; });

    function updateSBFromEvent(e) { const rect = cpSatBrightArea.getBoundingClientRect(); let x = Math.max(0, Math.min(e.clientX - rect.left, rect.width)); let y = Math.max(0, Math.min(e.clientY - rect.top, rect.height)); const newHSL = hsvToHsl(pickerHSLA.h, (x / rect.width) * 100, 100 - ((y / rect.height) * 100)); pickerHSLA.s = newHSL.s; pickerHSLA.l = newHSL.l; onPickerChange(); }
    cpHueSlider.addEventListener('mousedown', (e) => { isDraggingHue = true; updateHueFromEvent(e); });
    function updateHueFromEvent(e) { const rect = cpHueSlider.getBoundingClientRect(); let x = Math.max(0, Math.min(e.clientX - rect.left, rect.width)); pickerHSLA.h = (x / rect.width) * 360; onPickerChange(); }
    cpAlphaSlider.addEventListener('mousedown', (e) => { isDraggingAlpha = true; updateAlphaFromEvent(e); });
    function updateAlphaFromEvent(e) { const rect = cpAlphaSlider.getBoundingClientRect(); let x = Math.max(0, Math.min(e.clientX - rect.left, rect.width)); pickerHSLA.a = x / rect.width; onPickerChange(); }
    cpHexInput.addEventListener('input', (e) => { let hex = e.target.value; if (hex.length === 6 && /^[0-9A-Fa-f]{6}$/.test(hex)) { const hsl = hexToHsl("#" + hex); pickerHSLA.h = hsl.h; pickerHSLA.s = hsl.s; pickerHSLA.l = hsl.l; onPickerChange(); } });
    cpAlphaInput.addEventListener('input', (e) => { let val = parseInt(e.target.value); if (!isNaN(val)) { val = Math.max(0, Math.min(100, val)); pickerHSLA.a = val / 100; onPickerChange(); } });

    const presetColors = ['#FF3B30', '#FF9500', '#FFCC00', '#4CD964', '#5AC8FA', '#007AFF', '#5856D6', '#FF2D55', '#8E8E93', '#C7C7CC', '#D1D1D6', '#E5E5EA', '#F2F2F7', '#FFFFFF', '#000000'];
    const cpSwatchGrid = document.getElementById('cpSwatchGrid');
    presetColors.forEach(hex => { const swatch = document.createElement('div'); swatch.className = 'cp-swatch'; swatch.style.backgroundColor = hex; swatch.addEventListener('click', () => { setPickerColorFromHex(hex); }); cpSwatchGrid.appendChild(swatch); });
    function setPickerColorFromHex(hex) { const hsl = hexToHsl(hex); pickerHSLA.h = hsl.h; pickerHSLA.s = hsl.s; pickerHSLA.l = hsl.l; pickerHSLA.a = 1.0; onPickerChange(); }

    function openPopoverToEdit(index, triggerElement) { 
        editingColorIndex = index; 
        const colorToEdit = colorState.colors[index]; 
        
        if (colorToEdit.type === 'linear') {
            // LOAD LINEAR STATE
            gradientStops = JSON.parse(JSON.stringify(colorToEdit.stops));
            isVerticalFlip = colorToEdit.isVertical;
            activeStopIndex = 0;
            // Visual Update for Button
            document.getElementById('flipVerticalBtn').style.backgroundColor = 'transparent';
            switchColorTab('linear'); // Switch to linear UI
            setActiveStop(0); // Trigger sync
        } else {
            // LOAD SOLID STATE
            pickerHSLA = { h: colorToEdit.h, s: colorToEdit.s, l: colorToEdit.l, a: colorToEdit.a };
            updatePickerVisuals(); 
            switchColorTab('solid');
        }
        
        cpHeaderTitle.textContent = "Edit Color"; 
        cpAddConfirmBtn.textContent = "Save Color"; 
        openPopover(triggerElement); 
    }
    function openPopover(triggerElement = addColorBtn) { if (colorState.isMultiColor) return; popover.style.visibility = 'hidden'; popover.style.display = 'flex'; if(editingColorIndex === -1) switchColorTab('solid'); const btnRect = triggerElement.getBoundingClientRect(); const popoverRect = popover.getBoundingClientRect(); const leftPos = btnRect.right + 12; const btnCenterY = btnRect.top + (btnRect.height / 2); let topPos = btnCenterY - (popoverRect.height / 2); const padding = 10; topPos = Math.max(padding, topPos); const maxTop = window.innerHeight - popoverRect.height - padding; topPos = Math.min(topPos, maxTop); popover.style.left = `${leftPos}px`; popover.style.top = `${topPos}px`; popover.style.visibility = 'visible'; currentTriggerElement = triggerElement; document.addEventListener('click', closePopoverOnClickOutside); }
    let currentTriggerElement = null;
    function closePopover() { popover.style.display = 'none'; document.removeEventListener('click', closePopoverOnClickOutside); currentTriggerElement = null; editingColorIndex = -1; }
    function closePopoverOnClickOutside(event) { const isClickInsidePopover = popover.contains(event.target); const isClickOnTrigger = currentTriggerElement && currentTriggerElement.contains(event.target); if (!isClickInsidePopover && !isClickOnTrigger && popover.style.display === 'flex') { closePopover(); } }
    
   addColorBtn.addEventListener('click', () => { editingColorIndex = -1; pickerHSLA = { h: 0, s: 100, l: 50, a: 1 }; gradientStops = [{ percent: 0, color: '#D966FF', alpha: 1 }, { percent: 100, color: '#823D99', alpha: 1 }]; isVerticalFlip = false; activeStopIndex = 0; updatePickerVisuals(); updateGradientVisuals(); cpHeaderTitle.textContent = "Add Color"; cpAddConfirmBtn.textContent = "Add Color"; openPopover(addColorBtn); });
   cpCloseBtn.addEventListener('click', closePopover); cpAddConfirmBtn.addEventListener('click', confirmAddColor);

    // --- UTILS (HSL/HSV) ---
    function hslToHex(h, s, l) { l /= 100; const a = s * Math.min(l, 1 - l) / 100; const f = n => { const k = (n + h / 30) % 12; const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1); return Math.round(255 * color).toString(16).padStart(2, '0'); }; return `#${f(0)}${f(8)}${f(4)}`.toUpperCase(); }
    function hexToHsl(hex) { let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); if (!result) return { h: 0, s: 0, l: 0 }; let r = parseInt(result[1], 16) / 255; let g = parseInt(result[2], 16) / 255; let b = parseInt(result[3], 16) / 255; const max = Math.max(r, g, b), min = Math.min(r, g, b); let h, s, l = (max + min) / 2; if (max === min) { h = s = 0; } else { const d = max - min; s = l > 0.5 ? d / (2 - max - min) : d / (max + min); switch (max) { case r: h = (g - b) / d + (g < b ? 6 : 0); break; case g: h = (b - r) / d + 2; break; case b: h = (r - g) / d + 4; break; } h *= 60; } return { h: h, s: s * 100, l: l * 100 }; }
    function hsvToHsl(h, s, v) { s /= 100; v /= 100; let l = (2 - s) * v / 2; if (l !== 0) { if (l === 1) { s = 0; } else if (l < 0.5) { s = s * v / (l * 2); } else { s = s * v / (2 - l * 2); } } return { h: h, s: s * 100, l: l * 100 }; }
    function hslToHsv(h, s, l) { s /= 100; l /= 100; let v = l + s * Math.min(l, 1 - l); let sv = l === 0 ? 0 : 2 * (1 - l / v); return { h: h, s: sv * 100, v: v * 100 }; }

    // --- SHAPE TABS & LOGIC ---
    document.querySelectorAll('.shape-tab-trigger').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.shape-tab-trigger').forEach(t => t.removeAttribute('data-state'));
            tab.setAttribute('data-state', 'active');
            activeShapeTab = tab.getAttribute('data-target');
            if (activeShapeTab === 'preset') {
                presetShapesContainer.style.display = 'block';
                emojiShapesContainer.style.display = 'none';
                particleColorSection.classList.remove('section-disabled');
            } else {
                presetShapesContainer.style.display = 'none';
                emojiShapesContainer.style.display = 'block';
                particleColorSection.classList.add('section-disabled');
            }
            updatePreview(false); 
        });
    });

    document.querySelectorAll('.id-shape-selector .selector-item').forEach(item => {
       item.addEventListener('click', () => {
           const val = item.getAttribute('data-value');
           if (val === 'custom') return; 
           const currentState = item.getAttribute('data-state');
           item.setAttribute('data-state', currentState === 'selected' ? '' : 'selected');
           updatePreview(false);
       });
    });

    const modernEmojis = ['ðŸ˜€', 'ðŸ˜ƒ', 'ðŸ˜„', 'ðŸ˜', 'ðŸ˜†', 'ðŸ˜…', 'ðŸ˜‚', 'ðŸ¤£', 'ðŸ¥²', 'â˜ºï¸', 'ðŸ˜Š', 'ðŸ˜‡', 'ðŸ™‚', 'ðŸ™ƒ', 'ðŸ˜‰', 'ðŸ˜Œ', 'ðŸ˜', 'ðŸ¥°', 'ðŸ˜˜', 'ðŸ˜—', 'ðŸ˜™', 'ðŸ˜š', 'ðŸ˜‹', 'ðŸ˜›', 'ðŸ˜›', 'ðŸ˜›', 'ðŸ˜', 'ðŸ˜œ', 'ðŸ¤ª', 'ðŸ¤¨', 'ðŸ§', 'ðŸ¤“', 'ðŸ˜Ž', 'ðŸ¥¸', 'ðŸ¤©', 'ðŸ¥³', 'ðŸ˜', 'ðŸ˜’', 'ðŸ˜ž', 'ðŸ˜”', 'ðŸ˜Ÿ', 'ðŸ˜•', 'ðŸ™', 'â˜¹ï¸', 'ðŸ˜£', 'ðŸ˜–', 'ðŸ˜«', 'ðŸ˜©', 'ðŸ¥º', 'ðŸ˜¢', 'ðŸ˜­', 'ðŸ˜¤', 'ðŸ˜ ', 'ðŸ˜¡', 'ðŸ¤¬', 'ðŸ¤¯', 'ðŸ˜³', 'ðŸ¥µ', 'ðŸ¥¶', 'ðŸ˜±', 'ðŸ˜¨', 'ðŸ˜°', 'ðŸ˜¥', 'ðŸ˜“', 'ðŸ¤—', 'ðŸ¤”', 'ðŸ¤­', 'ðŸ¤«', 'ðŸ¤¥', 'ðŸ˜¶', 'ðŸ˜', 'ðŸ˜‘', 'ðŸ˜¬', 'ðŸ™„', 'ðŸ˜¯', 'ðŸ˜¯', 'ðŸ˜¦', 'ðŸ˜§', 'ðŸ˜®', 'ðŸ˜²', 'ðŸ¥±', 'ðŸ˜´', 'ðŸ¤¤', 'ðŸ˜ª', 'ðŸ˜µ', 'ðŸ¤', 'ðŸ¥´', 'ðŸ¤¢', 'ðŸ¤®', 'ðŸ¤§', 'ðŸ˜·', 'ðŸ’¤', 'ðŸ¤’', 'ðŸ¤•', 'ðŸ¤‘', 'ðŸ¤ ', 'ðŸ˜ˆ', 'ðŸ‘¿', 'ðŸ‘¹', 'ðŸ‘º', 'ðŸ¤¡', 'ðŸ’©', 'ðŸ‘»', 'ðŸ’€', 'â˜ ï¸', 'ðŸ‘½', 'ðŸ‘¾', 'ðŸ¤–', 'ðŸŽƒ', 'ðŸ˜º', 'ðŸ˜º', 'ðŸ˜¸', 'ðŸ˜¹', 'ðŸ˜»', 'ðŸ˜¼', 'ðŸ˜½', 'ðŸ™€', 'ðŸ˜¿', 'ðŸ˜¾'];
    
    modernEmojis.forEach(emojiChar => {
        const emojiItem = document.createElement('div');
        emojiItem.className = 'emoji-item';
        emojiItem.textContent = emojiChar;
        emojiItem.addEventListener('click', () => {
            const index = selectedEmojis.indexOf(emojiChar);
            if (index > -1) {
                selectedEmojis.splice(index, 1);
                emojiItem.removeAttribute('data-state');
            } else {
                selectedEmojis.push(emojiChar);
                emojiItem.setAttribute('data-state', 'selected');
            }
            updatePreview(false);
        });
        emojiGrid.appendChild(emojiItem);
    });

    // --- CUSTOM SHAPE EDITOR ---
    const initialCsState = { anchors: [{x: 60, y: 60}, {x: 260, y: 60}, {x: 260, y: 260}, {x: 60, y: 260}], controls: [{dx: 0, dy: -30}, {dx: -30, dy: 0}, {dx: 30, dy: 0}, {dx: 0, dy: -30}, {dx: 0, dy: 30}, {dx: 30, dy: 0}, {dx: -30, dy: 0}, {dx: 0, dy: 30}] };
    let csState = JSON.parse(JSON.stringify(initialCsState));
    let draggingElement = null;
    let dragStartIndex = -1; 

    function renderEditorCanvas() {
        csEditorSvg.innerHTML = ''; 
        const a = csState.anchors; const c = csState.controls;
        let d = `M ${a[0].x},${a[0].y} `;
        d += `C ${a[0].x + c[0].dx},${a[0].y + c[0].dy} ${a[1].x + c[3].dx},${a[1].y + c[3].dy} ${a[1].x},${a[1].y} `;
        d += `C ${a[1].x + c[2].dx},${a[1].y + c[2].dy} ${a[2].x + c[5].dx},${a[2].y + c[5].dy} ${a[2].x},${a[2].y} `;
        d += `C ${a[2].x + c[4].dx},${a[2].y + c[4].dy} ${a[3].x + c[7].dx},${a[3].y + c[7].dy} ${a[3].x},${a[3].y} `;
        d += `C ${a[3].x + c[6].dx},${a[3].y + c[6].dy} ${a[0].x + c[1].dx},${a[0].y + c[1].dy} ${a[0].x},${a[0].y} Z`;
        const pathPreview = createSvgElement('path', { d: d, class: 'cs-path-preview' });
        csEditorSvg.appendChild(pathPreview);
        const drawCircle = (x, y, cls, idx, type) => { const circle = createSvgElement('circle', { cx: x, cy: y, r: 6, class: cls }); circle.addEventListener('mousedown', (e) => startDrag(e, idx, type)); return circle; };
        const drawLine = (x1, y1, x2, y2) => createSvgElement('line', { x1, y1, x2, y2, class: 'cs-connector' });
        csEditorSvg.appendChild(drawLine(a[0].x, a[0].y, a[0].x + c[0].dx, a[0].y + c[0].dy));
        csEditorSvg.appendChild(drawLine(a[0].x, a[0].y, a[0].x + c[1].dx, a[0].y + c[1].dy));
        csEditorSvg.appendChild(drawLine(a[1].x, a[1].y, a[1].x + c[2].dx, a[1].y + c[2].dy));
        csEditorSvg.appendChild(drawLine(a[1].x, a[1].y, a[1].x + c[3].dx, a[1].y + c[3].dy));
        csEditorSvg.appendChild(drawLine(a[2].x, a[2].y, a[2].x + c[4].dx, a[2].y + c[4].dy));
        csEditorSvg.appendChild(drawLine(a[2].x, a[2].y, a[2].x + c[5].dx, a[2].y + c[5].dy));
        csEditorSvg.appendChild(drawLine(a[3].x, a[3].y, a[3].x + c[6].dx, a[3].y + c[6].dy));
        csEditorSvg.appendChild(drawLine(a[3].x, a[3].y, a[3].x + c[7].dx, a[3].y + c[7].dy));
        c.forEach((ctrl, i) => { const anchorIdx = Math.floor(i / 2); const absX = a[anchorIdx].x + ctrl.dx; const absY = a[anchorIdx].y + ctrl.dy; csEditorSvg.appendChild(drawCircle(absX, absY, 'cs-control', i, 'control')); });
        a.forEach((p, i) => { csEditorSvg.appendChild(drawCircle(p.x, p.y, 'cs-anchor', i, 'anchor')); });
    }

    function startDrag(e, index, type) { csHistory.push(JSON.parse(JSON.stringify(csState))); draggingElement = type; dragStartIndex = index; document.addEventListener('mousemove', onDrag); document.addEventListener('mouseup', stopDrag); }
    function onDrag(e) { if (!draggingElement) return; const rect = csEditorSvg.getBoundingClientRect(); const x = Math.max(0, Math.min(320, e.clientX - rect.left)); const y = Math.max(0, Math.min(320, e.clientY - rect.top)); if (draggingElement === 'anchor') { csState.anchors[dragStartIndex] = {x, y}; } else if (draggingElement === 'control') { const anchorIdx = Math.floor(dragStartIndex / 2); const anchor = csState.anchors[anchorIdx]; csState.controls[dragStartIndex] = { dx: x - anchor.x, dy: y - anchor.y }; } renderEditorCanvas(); }
    function stopDrag() { draggingElement = null; dragStartIndex = -1; document.removeEventListener('mousemove', onDrag); document.removeEventListener('mouseup', stopDrag); }
    function undoShape() { if (csHistory.length > 0) { csState = csHistory.pop(); renderEditorCanvas(); } }
    document.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z' && !e.shiftKey) { if (customShapePopover.style.display === 'flex') { e.preventDefault(); undoShape(); } } });
    customShapeBtn.addEventListener('click', () => { customShapePopover.style.display = 'flex'; renderEditorCanvas(); });
    csCloseBtn.addEventListener('click', () => { customShapePopover.style.display = 'none'; });
    csSaveBtn.addEventListener('click', () => { const previewPath = csEditorSvg.querySelector('.cs-path-preview'); if (previewPath) { finalCustomShapePathStr = previewPath.getAttribute('d'); customShapeBtn.setAttribute('data-state', 'selected'); document.querySelectorAll('.id-shape-selector .selector-item:not(#customShapeBtn)').forEach(item => { item.removeAttribute('data-state'); }); csResetIcon.style.display = 'block'; } customShapePopover.style.display = 'none'; updatePreview(false); });
    csResetIcon.addEventListener('click', () => { csState = JSON.parse(JSON.stringify(initialCsState)); csHistory = []; renderEditorCanvas(); customShapeBtn.removeAttribute('data-state'); finalCustomShapePathStr = ""; csResetIcon.style.display = 'none'; customShapePopover.style.display = 'none'; updatePreview(false); });

    function getSettings() {
        let selectedShapes = []; let currentSelectedEmoji = null; let customPath = null;
        if (activeShapeTab === 'preset') { selectedShapes = Array.from(document.querySelectorAll('.id-shape-selector .selector-item[data-state="selected"]:not(#customShapeBtn)')).map(el => el.getAttribute('data-value')); if (customShapeBtn.getAttribute('data-state') === 'selected') { selectedShapes.push('custom'); customPath = finalCustomShapePathStr; } } else { currentSelectedEmoji = selectedEmoji; }
        return {
            shapeTab: activeShapeTab, selectedShapes: selectedShapes, selectedEmojis: selectedEmojis, customShapePath: customPath, 
            randomness: parseInt(document.getElementById('randomInput').value), amount: parseInt(document.getElementById('amountInput').value), zoom: parseInt(document.getElementById('zoomInput').value),
            randomizeSize: document.getElementById('checkSize').checked, randomizeRotation: document.getElementById('checkRotation').checked,
            colorData: { isMultiColor: colorState.isMultiColor, customColors: colorState.colors },
            frameCount: parseInt(document.getElementById('frameCountInput').value) || 1, frameDelay: parseInt(document.getElementById('frameDelayInput').value) || 50
        };
    }
    document.getElementById('closeBtn').addEventListener('click', () => parent.postMessage({ pluginMessage: { type: 'close-plugin' } }, '*'));
    document.getElementById('generateBtn').addEventListener('click', () => { const settings = getSettings(); if (settings.amount === 0) { parent.postMessage({ pluginMessage: { type: 'generate-empty-frame' } }, '*'); } else { parent.postMessage({ pluginMessage: { type: 'generate-confetti', settings: settings } }, '*'); } });
    function resetPluginState() { document.getElementById('randomInput').value = 60; document.getElementById('amountInput').value = 20; document.getElementById('zoomInput').value = 10; document.getElementById('checkSize').checked = true; document.getElementById('checkRotation').checked = true; colorState = { isMultiColor: false, colors: [] }; multiColorSwitch.checked = false; renderColorList(); editingColorIndex = -1; document.querySelector('.shape-tab-trigger[data-target="preset"]').click(); document.querySelectorAll('.id-shape-selector .selector-item').forEach(item => { const val = item.getAttribute('data-value'); if(val === 'rectangle' || val === 'circle' || val === 'star') { item.setAttribute('data-state', 'selected'); } else { item.removeAttribute('data-state'); } }); csState = JSON.parse(JSON.stringify(initialCsState)); customShapeBtn.removeAttribute('data-state'); finalCustomShapePathStr = ""; csResetIcon.style.display = 'none'; selectedEmojis = []; document.querySelectorAll('.emoji-item').forEach(i => i.removeAttribute('data-state')); if (emojiGrid.firstChild) { selectedEmojis.push(modernEmojis[0]); emojiGrid.firstChild.setAttribute('data-state', 'selected'); } document.getElementById('frameCountInput').value = 10; document.getElementById('frameDelayInput').value = 75; document.getElementById('randomInput').dispatchEvent(new Event('input')); document.getElementById('amountInput').dispatchEvent(new Event('input')); document.getElementById('zoomInput').dispatchEvent(new Event('input')); updatePreview(false); if (panzoomInstance) panzoomInstance.reset(); }
    document.getElementById('resetBtn').addEventListener('click', resetPluginState);
    function renderPreview() { const settings = getSettings(); previewSvg.innerHTML = ''; const defs = createSvgElement('defs', {}); previewSvg.appendChild(defs); const globalZoom = settings.zoom / 10; previewParticles.forEach((p, index) => { let el; const baseSize = 24; const finalScale = p.scale * globalZoom; const transformStr = `translate(${p.x}, ${p.y}) rotate(${p.rotation}) scale(${finalScale})`; if (p.isEmoji) { el = createSvgElement('text', { x: 0, y: 0, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': baseSize + 'px', 'font-family': '"Apple Color Emoji", "Segoe UI Emoji", NotoColorEmoji, "Noto Color Emoji", sans-serif', 'transform': `translate(${p.x}, ${p.y}) scale(${finalScale})` }); el.textContent = p.shapeType; } else { let fill; let opacity = 1; if (!p.color) { fill = '#CBD5E1'; } else if (p.color.type === 'linear') { const gradId = `p_grad_${index}`; const gradient = createSvgElement('linearGradient', { id: gradId, x1: '0%', y1: '0%', x2: p.color.isVertical ? '0%' : '100%', y2: p.color.isVertical ? '100%' : '0%' }); p.color.gradientStops.forEach(stop => { const r = Math.round(stop.color.r * 255); const g = Math.round(stop.color.g * 255); const b = Math.round(stop.color.b * 255); const stopEl = createSvgElement('stop', { offset: `${stop.position * 100}%`, 'stop-color': `rgb(${r},${g},${b})`, 'stop-opacity': stop.color.a }); gradient.appendChild(stopEl); }); defs.appendChild(gradient); fill = `url(#${gradId})`; } else { const r = Math.round(p.color.r * 255); const g = Math.round(p.color.g * 255); const b = Math.round(p.color.b * 255); fill = `rgb(${r}, ${g}, ${b})`; opacity = p.color.a !== undefined ? p.color.a : 1; } const commonAttrs = { fill: fill, 'fill-opacity': opacity, 'transform': transformStr }; if (p.shapeType === 'custom' && p.customPathData) { const pathScale = baseSize / 320; el = createSvgElement('path', { d: p.customPathData, transform: `${transformStr} scale(${pathScale}) translate(-160, -160)`, fill: fill, 'fill-opacity': opacity }); } else if (p.shapeType === 'rectangle') { el = createSvgElement('rect', { x: -(baseSize * 1.33) / 2, y: -baseSize / 2, width: baseSize * 1.33, height: baseSize, rx: 2, ...commonAttrs }); } else if (p.shapeType === 'square') { el = createSvgElement('rect', { x: -baseSize / 2, y: -baseSize / 2, width: baseSize, height: baseSize, rx: 2, ...commonAttrs }); } else if (p.shapeType === 'circle') { el = createSvgElement('circle', { cx: 0, cy: 0, r: baseSize / 2, ...commonAttrs }); } else if (p.shapeType === 'star') { const points = "0,-12 3.5,-3.5 12,-3.5 5,2.5 8,11 0,6 -8,11 -5,2.5 -12,-3.5 -3.5,-3.5"; el = createSvgElement('polygon', { points: points, ...commonAttrs }); } else if (p.shapeType === 'wave') { el = createSvgElement('path', { d: "M16.625 18C17.6917 15.3333 16.7583 14.2667 13.825 14.8C11.1583 15.6 10.3583 14.6667 11.425 12C12.7583 9.33333 11.9583 8.4 9.025 9.2C6.09167 10 5.29167 8.93333 6.625 6", stroke: fill, 'stroke-width': 2, 'stroke-linecap': 'round', fill: 'none', 'fill-opacity': 0, 'stroke-opacity': opacity, transform: `${transformStr} translate(-12, -12)` }); } } if(el) previewSvg.appendChild(el); }); }
    function updatePreview(keepPositions, changeType) { const settings = getSettings(); if (settings.amount === 0) { previewParticles = []; renderPreview(); return; } parent.postMessage({ pluginMessage: { type: 'preview-confetti', settings: settings, keepPositions: keepPositions, changeType: changeType } }, '*'); }
    window.onmessage = (event) => { const msg = event.data.pluginMessage; if (msg && msg.type === 'preview-data') { previewParticles = msg.particles; renderPreview(); } };
    panzoomInstance = Panzoom(panzoomContainer, { maxScale: 5, minScale: 0.1, contain: 'outside', startScale: 1 });
    panzoomContainer.parentElement.addEventListener('wheel', panzoomInstance.zoomWithWheel);
    if (emojiGrid.firstChild) { emojiGrid.firstChild.click(); }
    setTimeout(() => { resetPluginState(); }, 250);
  </script>
</body>
</html>