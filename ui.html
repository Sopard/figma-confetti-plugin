<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Confetti Animator</title>
  <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
  <style>
    /* VARIABLES - DEFAULT (LIGHT) */
    :root {
      --primary: #1890FF; --primary-hover: #40a9ff;
      --background: #FFFFFF; --foreground: #0f172a;
      --muted: #E9EAEB; --muted-darker: #e2e8f0; --muted-foreground: #64748b;
      --border: #e2e8f0; --radius: 8px;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --slider-track: #E5E7EB; --switch-bg: #E5E7EB;
      --handle-color: #1890FF; --control-color: #FF4D4F;
      --preview-panel-bg: #fafafa;
      --canvas-bg: #FFFFFF;
      --canvas-dot: #e2e8f0;
      --cs-canvas-bg: #E9EAEB;
      --cs-stripe: #ccc;
      --tab-inactive-svg: #E5E5EA;
      --tab-active-bg: #FFFFFF;
      --tab-active-text: #0f172a;
      --stop-swatch-border: rgba(0,0,0,0.1);
      --stop-remove-hover: #d00;
      --dropdown-bg: white;
      --dropdown-hover: #E9EAEB;
      --dropdown-selected: #f0f9ff;
      --tag-bg: #E6F7FF; 
      --tag-text: #1890FF;
      --tag-border: #91D5FF;
      --scrollbar-thumb: #C1C1C1;
    }

    /* VARIABLES - AUTOMATIC DARK THEME */
    @media (prefers-color-scheme: dark) {
      :root {
        --background: #1e1e1e; --foreground: #FFFFFF;
        --muted: #2b2b2b; --muted-darker: #3b3b3b; --muted-foreground: #a1a1a1;
        --border: #333333;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.5);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.7), 0 2px 4px -2px rgb(0 0 0 / 0.5);
        --slider-track: #333333; --switch-bg: #333333;
        --preview-panel-bg: #121212;
        --canvas-bg: #1a1a1a;
        --canvas-dot: #333;
        --cs-canvas-bg: #000;
        --cs-stripe: #111;
        --tab-inactive-svg: #444;
        --tab-active-bg: #454545;
        --tab-active-text: #FFFFFF;
        --stop-swatch-border: rgba(255,255,255,0.1);
        --stop-remove-hover: #f44;
        --dropdown-bg: #2b2b2b;
        --dropdown-hover: #3b3b3b;
        --dropdown-selected: #1e3a5f;
        --tag-bg: #111d2c; 
        --tag-text: #1890FF;
        --tag-border: #153450;
        --scrollbar-thumb: #484848;
      }
    }

    /* THEME-MATCHED SCROLLBARS */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
    ::-webkit-scrollbar-thumb:hover { background: var(--muted-foreground); background-clip: content-box; }

    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background-color: var(--background); color: var(--foreground); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    .recommended-tag { font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 4px; background-color: var(--tag-bg); color: var(--tag-text); border: 1px solid var(--tag-border); text-transform: uppercase; margin-left: 8px; display: inline-block; vertical-align: middle; line-height: 1; }

    /* LOADER STYLING */
    .loader {
      display: none; width: 16px; height: 16px; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; margin-left: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .btn-loading .loader { display: block; }
    .btn:disabled { opacity: 0.7; cursor: not-allowed; }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; text-align: center; }

    .header { height: 56px; display: flex; justify-content: flex-end; align-items: center; padding: 0 24px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .main-layout { flex: 1; display: flex; overflow: hidden; position: relative; }
    .settings-panel { width: 440px; padding: 24px; border-right: 1px solid var(--border); overflow-y: auto; display: flex; flex-direction: column; gap: 24px; }
    .preview-panel { flex: 1; padding: 24px; background-color: var(--preview-panel-bg); display: flex; flex-direction: column; }

    /* HOW IT WORKS HEADER BTN */
    .how-it-works-link { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; color: var(--muted-foreground); text-decoration: none; cursor: pointer; transition: color 0.2s; }
    .how-it-works-link:hover { color: var(--primary); }

    /* FULL OVERLAY */
    .full-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--background); z-index: 1000; display: none; flex-direction: column; padding: 0; box-sizing: border-box; overflow-y: auto; }
    .full-overlay.show { display: flex; }
    .overlay-header { height: 56px; display: flex; align-items: center; padding: 0 24px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .overlay-content { max-width: 600px; margin: 0 auto; width: 100%; padding: 40px; }
    .overlay-title { font-size: 24px; font-weight: 700; margin-bottom: 24px; }
    
    /* YOUTUBE VIDEO STYLING */
.video-container {
  position: relative;
  width: 100%;
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 32px;
  cursor: pointer;
  border: 1px solid var(--border);
  transition: transform 0.2s;
}

.video-container:hover {
  transform: scale(1.02);
}

.video-container img {
  width: 100%;
  display: block;
}

/* Play Button Overlay */
.play-overlay {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.7);
  width: 60px;
  height: 40px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
}

    .instruction-step { margin-bottom: 24px; }
    .instruction-step h3 { font-size: 16px; margin-bottom: 8px; color: var(--primary); }
    .instruction-step p { font-size: 14px; line-height: 1.6; color: var(--muted-foreground); margin: 0; }

    /* ATTRIBUTION BOTTOM */
    .attribution-bottom { margin-top: auto; padding: 24px 0 8px 0; display: flex; justify-content: space-between; align-items: center; }
    .credit-link { font-size: 13px; color: var(--muted-foreground); text-decoration: none; transition: color 0.2s; }
    .credit-link:hover { color: var(--primary); }

    .tabs-list { display: flex; background-color: var(--muted); padding: 4px; border-radius: var(--radius); position: relative; }
    .tab-trigger { flex: 1; text-align: center; padding: 6px; font-size: 12px; font-weight: 500; border-radius: calc(var(--radius) - 2px); cursor: pointer; color: var(--muted-foreground); transition: all 0.2s; position: relative; }
    .tab-trigger[data-state="active"] { background-color: var(--tab-active-bg); color: var(--tab-active-text); box-shadow: var(--shadow-sm); }
    .tab-trigger.disabled { opacity: 0.8; cursor: not-allowed; color: var(--muted-foreground); background-color: var(--muted); }
    
    .premium-icon { position: absolute; top: 0px; right: 0px; pointer-events: none; }
    .color-item-row.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }

   /* TOOLTIP IMPLEMENTATION */
    [data-tooltip] {
      position: relative;
    }

    [data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    [data-tooltip]:hover::after {
      opacity: 1;
    }

    /* Adjust position for Emojis/Flags to prevent clipping */
    .emoji-grid [data-tooltip]::after, 
    .id-shape-selector [data-tooltip]::after {
      bottom: auto;
      top: 110%;
    }

    .label { font-size: 14px; font-weight: 500; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
    .slider-container { position: relative; height: 36px; background-color: var(--slider-track); border-radius: var(--radius); overflow: hidden; }
    .slider-fill { position: absolute; height: 100%; background-color: var(--primary); border-radius: var(--radius) 0 0 var(--radius); transition: width 0.1s ease-out; }
    .slider-value-input { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-weight: 600; font-size: 14px; color: var(--foreground); pointer-events: auto; z-index: 10; border: 1px solid transparent; background: transparent; width: 60px; text-align: right; padding: 4px; border-radius: 4px; outline: none; font-family: inherit; transition: all 0.2s; }
    .slider-input { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; margin: 0; z-index: 3; }
    .slider-labels-row { display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: var(--muted-foreground); }
    
    .toggle-row-container { display: flex; flex-direction: column; gap: 12px; }
    .toggle-row { display: flex; justify-content: space-between; align-items: center; height: 36px; }
    .toggle-label { font-size: 14px; font-weight: 500; }
    .switch { position: relative; display: inline-block; width: 36px; height: 20px; flex-shrink: 0; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .switch-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--switch-bg); transition: .4s; border-radius: 20px; }
    .switch-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: var(--shadow-sm); }
    input:checked + .switch-slider { background-color: var(--primary); }
    input:checked + .switch-slider:before { transform: translateX(16px); }

    .section-divider { height: 1px; background-color: var(--border); border: none; margin: 0; width: 100%; }
    .color-header-box { display: flex; justify-content: space-between; align-items: center; background-color: var(--muted); padding: 8px 12px; border-radius: var(--radius); margin-bottom: 8px; height: 40px; box-sizing: border-box; }
    .color-count-text { font-size: 14px; font-weight: 500; }
    
    .icon-btn-flat { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; color: var(--foreground); cursor: pointer; padding: 0; border-radius: 4px; transition: background-color 0.2s; }
    .icon-btn-flat:hover:not(:disabled) { background-color: var(--muted-darker); }
    .icon-btn-flat:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .color-list-container { display: flex; flex-direction: column; gap: 12px; }
    .color-toggle-row { display: flex; align-items: center; justify-content: space-between; }
    .color-toggle-label { display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; }
    .rainbow-icon { width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; }
    .scrollable-grid-container { max-height: 120px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius); background-color: transparent; padding: 8px; margin-top: 8px; position: relative; }
    .color-item-row { display: flex; align-items: center; gap: 12px; transition: opacity 0.3s; padding: 4px 0; }
    .color-preview-sq { width: 24px; height: 24px; border-radius: 6px; border: 1px solid var(--border); box-sizing: border-box; cursor: pointer; }
    .color-hex-text { flex: 1; font-size: 14px; font-weight: 500; font-variant-numeric: tabular-nums; }
    .color-percent-input { width: 48px; font-size: 14px; font-weight: 500; font-family: inherit; color: var(--foreground); border: 1px solid transparent; background: transparent; border-radius: 4px; padding: 2px 4px; }
    
    .shape-tabs { display: flex; gap: 16px; border-bottom: 1px solid var(--border); margin-bottom: 24px; align-items: center; justify-content: space-between; }
    .shape-tabs-triggers { display: flex; gap: 16px; }
    .shape-tab-trigger { padding: 8px 0; font-size: 14px; font-weight: 500; color: var(--muted-foreground); cursor: pointer; position: relative; transition: color 0.2s; }
    .shape-tab-trigger[data-state="active"] { color: var(--primary); }
    .shape-tab-trigger[data-state="active"]::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background-color: var(--primary); }
    .selector-grid { display: flex; gap: 8px; flex-wrap: nowrap; align-items: center; width: 100%; }
    .selector-item { flex: 1; height: 40px; min-width: 0; display: flex; align-items: center; justify-content: center; border: 2px solid var(--border); border-radius: var(--radius); color: var(--muted-foreground); cursor: pointer; position: relative; background: var(--muted); transition: all 0.2s; flex-shrink: 0; }
    .selector-item[data-state="selected"] { border-color: var(--primary); color: var(--primary); background-color: var(--muted-darker); }
    .selector-check { position: absolute; top: -6px; right: -6px; width: 18px; height: 18px; background: var(--primary); border-radius: 50%; border: 2px solid var(--background); display: none; align-items: center; justify-content: center; color: white; }
    .selector-item[data-state="selected"] .selector-check { display: flex; }
    .vertical-divider { width: 1px; height: 40px; background-color: var(--border); flex-shrink: 0; flex-grow: 0; }
    .custom-shape-btn { flex: 2; padding: 0 4px; gap: 6px; font-size: 13px; font-weight: 500; white-space: nowrap; }
    .emoji-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; }
    .emoji-item, .flag-item { width: 40px; height: 40px; font-size: 24px; display: flex; align-items: center; justify-content: center; border: 1px solid transparent; border-radius: var(--radius); cursor: pointer; transition: all 0.2s; position: relative; }
    .emoji-item[data-state="selected"], .flag-item[data-state="selected"] { background-color: var(--muted-darker); border-color: var(--primary); }
    .flag-item img { width: 80%; height: 80%; object-fit: contain; }

    .custom-shape-popover { position: fixed; top: 50%; left: 65%; transform: translate(-50%, -50%); width: 380px; min-height: 500px; background: var(--background); border-radius: 12px; box-shadow: var(--shadow-md); padding: 20px; z-index: 20; display: none; flex-direction: column; border: 1px solid var(--border); box-sizing: border-box; justify-content: space-between; }
    .cs-canvas-container { width: 320px; height: 320px; background-color: var(--cs-canvas-bg); border: 1px solid var(--border); border-radius: var(--radius); margin: 16px auto; position: relative; background-image: linear-gradient(45deg, var(--cs-stripe) 25%, transparent 25%), linear-gradient(-45deg, var(--cs-stripe) 25%, transparent 25%), linear-gradient(45deg, transparent 75%, var(--cs-stripe) 75%), linear-gradient(-45deg, transparent 75%, var(--cs-stripe) 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; flex-shrink: 0; }
    #csEditorSvg { width: 100%; height: 100%; overflow: visible; }
    .cs-anchor { fill: var(--handle-color); stroke: white; stroke-width: 2px; cursor: grab; }
    .cs-control { fill: var(--control-color); stroke: white; stroke-width: 2px; cursor: grab; }
    .cs-connector { stroke: var(--muted-foreground); stroke-width: 1px; stroke-dasharray: 4 4; pointer-events: none; }
    .cs-path-preview { fill: var(--primary); opacity: 0.8; stroke: var(--primary-hover); stroke-width: 2px; pointer-events: none; }
    .cs-reset-icon { position: absolute; top: 8px; right: 8px; background-color: var(--background); border: 1px solid var(--border); border-radius: 4px; padding: 4px; cursor: pointer; color: var(--muted-foreground); display: none; }
    #csSaveBtn { flex-shrink: 0; width: 100%; }

    .footer { display: flex; margin-top: -18px; padding-top: 0; }
    .btn { height: 44px; border-radius: var(--radius); font-weight: 600; font-size: 14px; cursor: pointer; border: none; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; }
    .btn-primary { flex: 3; background-color: var(--primary); color: white; }
    .btn-primary:hover { background-color: var(--primary-hover); }
    .btn-outline { flex: 1; background-color: transparent; border: 1px solid var(--border); color: var(--foreground); }
    .btn-outline:hover { background-color: var(--muted); }
    .preview-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
    .preview-canvas { flex: 1; background: var(--canvas-bg); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 16px; overflow: hidden; background-image: radial-gradient(circle, var(--canvas-dot) 1px, transparent 1px); background-size: 20px 20px; display: flex; align-items: center; justify-content: center; color: var(--muted-foreground); position: relative; }
    #panzoomContainer { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; cursor: grab; }
    #previewSvg { max-width: 100%; max-height: 100%; pointer-events: none; }
    .preview-footer { display: flex; }
    .number-input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .number-input-field { width: 64px; height: 32px; padding: 0 8px; border: 1px solid var(--border); border-radius: var(--radius); background-color: var(--muted); color: var(--foreground); font-size: 13px; font-weight: 600; text-align: center; outline: none; transition: border-color 0.2s; }
    .grouped-settings-box { border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; display: flex; flex-direction: column; gap: 12px; }
    .grouped-settings-box .number-input-row { margin-bottom: 0; }

   .color-picker-popover { position: absolute; top: 0; left: 0; width: 320px; background: var(--background); border-radius: 12px; box-shadow: var(--shadow-md); padding: 20px; z-index: 10; display: none; border: 1px solid var(--border); box-sizing: border-box; flex-direction: column; min-height: auto; max-height: 620px; overflow-y: auto; }
    .mini-color-popover { position: fixed; z-index: 100; background: var(--background); border: 1px solid var(--border); box-shadow: var(--shadow-md); border-radius: 12px; padding: 12px; width: 260px; display: none; }
    .mini-color-popover { position: fixed; z-index: 100; background: var(--background); border: 1px solid var(--border); box-shadow: var(--shadow-md); border-radius: 12px; padding: 12px; width: 260px; display: none; }
    .mini-color-popover .cp-inputs-row { margin-bottom: 0; }
    .mini-color-popover .cp-sat-bright-area { height: 160px; }
    #miniSaveBtn { margin-top: 12px; width: 100%; height: 32px; font-size: 13px; }

    .cp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-weight: 600; flex-shrink: 0; }
    .cp-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 16px; flex-shrink: 0; justify-content: flex-start; gap: 8px; }
    .cp-tab { text-align: center; padding: 10px 16px; cursor: pointer; color: var(--muted-foreground); font-weight: 500; font-size: 14px; border-bottom: 2px solid transparent; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
    .cp-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .cp-tab svg path { fill: currentColor; }
    .cp-tab:not(.active) svg path { fill: var(--tab-inactive-svg) !important; }

    .cp-content-scrollable { flex: 1; overflow-y: auto; margin-bottom: 16px; padding-right: 4px; -ms-overflow-style: none; scrollbar-width: none; }
    .cp-content-scrollable::-webkit-scrollbar { display: none; }
    .cp-sat-bright-area { width: 100%; height: 200px; border-radius: 8px; position: relative; background: linear-gradient(to top, #000, transparent), linear-gradient(to right, #fff, transparent); background-color: red; cursor: crosshair; margin-bottom: 16px; flex-shrink: 0; }
    .cp-sb-selector { position: absolute; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.5); transform: translate(-8px, -8px); top: 0%; left: 100%; pointer-events: none; }
    .cp-sliders { display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px; flex-shrink: 0; }
    .cp-slider-track { width: 100%; height: 16px; border-radius: 8px; position: relative; cursor: pointer; }
    .cp-hue-slider { background: linear-gradient(to right, red, yellow, green, cyan, blue, magenta, red); }
    .cp-alpha-slider { background-image: linear-gradient(45deg, var(--cs-stripe) 25%, transparent 25%), linear-gradient(-45deg, var(--cs-stripe) 25%, transparent 25%), linear-gradient(45deg, transparent 75%, var(--cs-stripe) 75%), linear-gradient(-45deg, transparent 75%, var(--cs-stripe) 75%); background-size: 10px 10px; background-position: 0 0, 0 5px, 5px -5px, -5px 0px; }
    .cp-alpha-slider-bar { position: absolute; top:0; left:0; width: 100%; height: 100%; border-radius: 8px; background: linear-gradient(to right, transparent, red); pointer-events: none;}
    .cp-slider-thumb { position: absolute; top: 50%; width: 20px; height: 20px; background: white; border-radius: 50%; box-shadow: var(--shadow-sm); transform: translate(-10px, -50%); pointer-events: none; border: 1px solid var(--border); }
    .cp-inputs-row { display: flex; gap: 8px; margin-bottom: 16px; flex-shrink: 0; }
    .cp-input-wrapper { display: flex; align-items: center; background: var(--muted); border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px; height: 36px; box-sizing: border-box; }
    .cp-hex-wrapper span { border-right: 1px solid var(--border); padding-right: 8px; margin-right: 8px; color: var(--muted-foreground); font-size: 13px; font-weight: 500; height: 20px; display: flex; align-items: center; }
    .cp-input-field { border: none; background: transparent; outline: none; font-family: inherit; font-weight: 500; font-size: 14px; color: var(--foreground); flex: 1; width: 100%; }
    .cp-hex-wrapper { flex: 2; } .cp-alpha-wrapper { flex: 1; }
    .cp-swatches-section { flex-shrink: 0; }
    .cp-swatch-grid { display: flex; flex-wrap: wrap; gap: 10px; }
    .cp-swatch { width: 24px; height: 24px; border-radius: 6px; cursor: pointer; border: 1px solid var(--border); box-sizing: border-box; }
    
    #cpLinearContent { display: none; flex-direction: column; gap: 16px; }
    .linear-controls-row { display: flex; justify-content: space-between; align-items: center; }
    .custom-dropdown { position: relative; }
    .dropdown-trigger { border: 1px solid var(--border); border-radius: 6px; padding: 6px 12px; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px; background: var(--dropdown-bg); cursor: pointer; }
    .dropdown-content { position: absolute; top: 100%; left: 0; width: 140px; background: var(--dropdown-bg); border: 1px solid var(--border); border-radius: 6px; box-shadow: var(--shadow-md); display: none; flex-direction: column; z-index: 20; margin-top: 4px; overflow: hidden; }
    .dropdown-content.show { display: flex; }
    .dropdown-item { padding: 8px 12px; font-size: 14px; cursor: pointer; transition: background 0.2s; }
    .dropdown-item:hover { background: var(--dropdown-hover); }
    .dropdown-item.selected { background: var(--dropdown-selected); color: var(--primary); }
    .linear-actions { display: flex; gap: 4px; }

    .gradient-slider-container { position: relative; height: 120px; display: flex; align-items: center; overflow: visible; margin: 0 18px 40px 18px; cursor: crosshair; }
    .gradient-bar { width: 100%; height: 100%; border-radius: 8px; background: linear-gradient(90deg, #D966FF 0%, #823D99 100%); position: relative; }
    .gradient-handle { position: absolute; top: 100%; margin-top: 2px; width: 28px; height: 31px; cursor: grab; transform: translateX(-50%) rotate(180deg); z-index: 10; overflow: visible; }
    .gradient-handle svg { width: 100%; height: 100%; drop-shadow: 0 -2px 2px rgba(0,0,0,0.5); }
    .gradient-handle.active svg path { stroke: var(--primary) !important; stroke-width: 3px !important; z-index: 20; }
    .gradient-handle:active { cursor: grabbing; }

    .stops-section { display: flex; flex-direction: column; gap: 8px; max-height: 140px; overflow: scroll;}
    .stops-header { display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 14px; }
    .stops-list { display: flex; flex-direction: column; gap: 8px; }
    .stop-row { display: flex; align-items: center; gap: 12px; }
    .stop-row.active .stop-data-group { border-color: var(--primary); }
    .stop-pos-group { background: var(--muted); border: 1px solid var(--border); border-radius: 6px; width: 52px; padding: 0 4px 0 0; display: flex; align-items: center; justify-content: center; height: 32px; gap: 2px; }
    .stop-pos-input { width: 100%; background: transparent; border: none; outline: none; font-size: 13px; font-weight: 500; text-align: right; color: var(--foreground); padding-right: 0; }
    .stop-data-group { flex: 1; display: flex; align-items: center; gap: 8px; background: var(--muted); border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px; height: 32px; transition: border-color 0.2s; }
    .stop-swatch { width: 20px; height: 20px; border-radius: 4px; border: 1px solid var(--stop-swatch-border); cursor: pointer; }
    .stop-hex { flex: 1; background: transparent; border: none; outline: none; font-size: 13px; font-weight: 500; text-transform: uppercase; width: 50px; color: var(--foreground); }
    .stop-opacity-group { display: flex; align-items: center; gap: 2px; border-left: 1px solid var(--border); padding-left: 8px; padding-right: 8px; }
    .stop-opacity { width: 28px; background: transparent; border: none; outline: none; font-size: 13px; color: var(--foreground); }
    .stop-remove-btn { background: transparent; border: none; cursor: pointer; padding: 0; display: flex; align-items: center; color: #888; margin-left: 4px; }
    .stop-remove-btn:hover { color: var(--stop-remove-hover); }
    #cpAddConfirmBtn { flex-shrink: 0; height: 46px; min-height: 46px; font-size: 14px; font-weight: 600; flex-grow: 0; margin-top: auto; }

    /* TOAST NOTIFICATION STYLING */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background-color: #2c2c2c;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 2000;
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      pointer-events: none;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
    }
    .toast-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #4cd964;
    }
  </style>
</head>
<body>

  <div id="hiddenPickerStorage" style="display: none;"></div>
  
  <div id="miniColorPopover" class="mini-color-popover">
      <button id="miniSaveBtn" class="btn btn-primary" onclick="event.stopPropagation(); applyPickerToActive(); closeMiniPopover()">Save</button>
  </div>

  <div id="howItWorksPage" class="full-overlay">
      <div class="overlay-header">
        <div id="closeHowItWorks" class="how-it-works-link" style="color: var(--foreground);">
           <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
             <line x1="19" y1="12" x2="5" y2="12"></line>
             <polyline points="12 19 5 12 12 5"></polyline>
           </svg>
           <span>Back to Editor</span>
        </div>
      </div>
      <div class="overlay-content">
        <div class="overlay-title">How to use Confetti Animator</div>
        
        <a href="https://www.youtube.com/watch?v=UKMoAYv1oCg" target="_blank" style="text-decoration: none;">
    <div class="video-container">
      <img src="https://img.youtube.com/vi/UKMoAYv1oCg/maxresdefault.jpg" alt="Video Tutorial Thumbnail">
      <div class="play-overlay">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M8 5v14l11-7z"/>
        </svg>
      </div>
    </div>
  </a>
        <div class="instruction-step">
        <p style="margin-top: 14px; font-style: Bold"><b>Steps:</b></p>
          <h3>1. Choose Your Confetti</h3>
          <p>Select from classic shapes (Circles, Squares, Stars), choose your favorite Emojis, or use Flag SVGs. You can even draw your own path in the "Custom" editor.</p>
        </div>

        <div class="instruction-step">
          <h3>2. Customize Colors</h3>
          <p>Click "Add Color" to pick solid colors or create gradients (Linear, Radial, Angular). Toggle "Multi-color" for a vibrant random mix.</p>
        </div>

        <div class="instruction-step">
          <h3>3. Fine-Tune Physics</h3>
          <p>Adjust <b>Randomize</b> for chaos, <b>Amount</b> for density, and <b>Flutter</b> to control the spin and flip of falling particles.</p>
        </div>

        <div class="instruction-step">
          <h3>4. Generate your confetti:</h3>
          <p>Click Generate Confetti, and the plugin will create your assets instantly.</p>
        </div>

        <div class="instruction-step">
          <h3>5. Preview the animation:</h3>
          <p>Copy the first frame of your confetti component set <b>(Frame 1)</b> and drop it into your design. Switch to prototype tab to see the magic happen. Enjoy! üéâ</p>
        </div>

       <div class="instruction-step"> <p style="margin-top: 14px; font-style: italic;"><b>Tip:</b> We‚Äôve already linked the frames with Smart Animate, so your animation is ready to preview immediately.</p></div>
      </div>
  </div>

  <div class="header">
    <div id="howItWorksBtn" class="how-it-works-link">
      <span>How it works</span>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </svg>
    </div>
  </div>

  <div class="main-layout">
    <div class="settings-panel">
        <div class="tabs-list" style="margin-bottom: -4px;">
            <div class="tab-trigger" data-state="active" style="font-size: 14px; padding: 8px;">Free Fall</div>
            <div class="tab-trigger disabled" data-tooltip="Coming soon!" style="font-size: 14px; padding: 8px;">
                Impact Fall
                <svg class="premium-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.5 3C11.4183 3.00002 11.3378 3.02007 11.2656 3.0584C11.1934 3.09673 11.1318 3.15217 11.086 3.21987C11.0402 3.28757 11.0117 3.36545 11.003 3.44672C10.9943 3.52798 11.0056 3.61014 11.036 3.686L13.036 8.686C13.0732 8.77869 13.1372 8.85813 13.2199 8.91409C13.3026 8.97006 13.4002 8.99998 13.5 9H17.5C17.5885 9.00002 17.6754 8.97657 17.7518 8.93203C17.8282 8.8875 17.8915 8.82349 17.9351 8.74652C17.9787 8.66956 18.0011 8.58239 18.0001 8.49394C17.999 8.40548 17.9745 8.31889 17.929 8.243L14.929 3.243C14.8846 3.16888 14.8217 3.10753 14.7465 3.06495C14.6714 3.02236 14.5864 2.99998 14.5 3H11.5Z" fill="url(#paint0_linear_2353_132718)"/><path d="M5.50001 3C5.4136 2.99998 5.32866 3.02236 5.25348 3.06495C5.17829 3.10753 5.11543 3.16888 5.07101 3.243L2.07101 8.243C2.02554 8.31889 2.00102 8.40548 1.99995 8.49394C1.99887 8.40548 2.02129 8.66956 2.06491 8.74652C2.10852 8.82349 2.17178 8.8875 2.24822 8.93203C2.32466 8.97657 2.41155 9.00002 2.50001 9H6.50001C6.59987 8.99998 6.69743 8.97006 6.78012 8.91409C6.86282 8.85813 6.92687 8.77869 6.96401 8.686L8.96401 3.686C8.99442 3.61014 9.00576 3.52798 8.99705 3.44672C8.98834 3.36545 8.95984 3.28757 8.91405 3.21987C8.86827 3.15217 8.80658 3.09673 8.7344 3.0584C8.66222 3.02007 8.58174 3.00002 8.50001 3H5.50001Z" fill="url(#paint1_linear_2353_132718)"/><path d="M8.50001 3C8.40015 3.00002 8.30259 3.02994 8.2199 3.08591C8.1372 3.14187 8.07315 3.22131 8.03601 3.314L6.03601 8.314C6.0056 8.38986 5.99426 8.47202 6.00297 8.55328C6.01168 8.63455 6.04018 8.71243 6.08596 8.78013C6.13175 8.84783 6.19344 8.90327 6.26562 8.9416C6.3378 8.97993 6.41828 8.99998 6.50001 9H13.5C13.5817 8.99998 13.6622 8.97993 13.7344 8.9416C13.8066 8.90327 13.8683 8.84783 13.914 8.78013C13.9598 8.71243 13.9883 8.63455 13.997 8.55328C14.0058 8.47202 13.9944 8.38986 13.964 8.314L11.964 3.314C11.9269 3.22131 11.8628 3.14187 11.7801 3.08591C11.6974 3.02994 11.5999 3.00002 11.5 3H8.50001Z" fill="url(#paint2_linear_2353_132718)"/><path d="M13.5 8C13.3992 8.00002 13.3008 8.03049 13.2177 8.08741C13.1345 8.14434 13.0705 8.22506 13.034 8.319L9.53401 17.319C9.49126 17.4295 9.48915 17.5516 9.52806 17.6636C9.56697 17.7755 9.64436 17.87 9.74645 17.9301C9.84853 17.9903 9.96867 18.0123 10.0854 17.9921C10.2022 17.9719 10.308 17.9109 10.384 17.82L17.884 8.82C17.9448 8.747 17.9836 8.65818 17.9957 8.56396C18.0079 8.46973 17.9929 8.37399 17.9526 8.28795C17.9123 8.20191 17.8484 8.12913 17.7682 8.07814C17.688 8.02714 17.595 8.00004 17.5 8H13.5Z" fill="url(#paint0_linear_2353_132718)"/><path d="M2.50003 8C2.40502 8.00004 2.31199 8.02714 2.23183 8.07814C2.15167 8.12913 2.0877 8.20191 2.0474 8.28795C2.00711 8.37399 1.99217 8.46973 2.00432 8.56396C2.01647 8.65818 2.05522 8.747 2.11603 8.82L9.61603 17.82C9.69201 17.9109 9.79782 17.9719 9.91459 17.9921C10.0314 18.0123 10.1515 17.9903 10.2536 17.9301C10.3557 17.87 10.4331 17.7755 10.472 17.6636C10.5109 17.5516 10.5088 17.4295 10.466 17.319L6.96603 8.319C6.92955 8.22506 6.86553 8.14434 6.78237 8.08741C6.69922 8.03049 6.6008 8.00002 6.50003 8H2.50003Z" fill="url(#paint4_linear_2353_132718)"/><path d="M6.16 8C6.16 8 5.938 8.387 6.034 8.681L9.534 17.681C9.57052 17.7749 9.63455 17.8556 9.7177 17.9125C9.80086 17.9693 9.89925 17.9998 10 17.9998C10.1007 17.9998 10.1991 17.9693 10.2823 17.9125C10.3655 17.8556 10.4295 17.7749 10.466 17.681L13.966 8.681C14.091 8.36 13.84 8 13.84 8H6.16Z" fill="url(#paint5_linear_2353_132718)"/><path fill-rule="evenodd" clip-rule="evenodd" d="M5.07103 3.243C5.11544 3.16888 5.17831 3.10753 5.25349 3.06495C5.32868 3.02236 5.41362 2.99998 5.50003 3H14.5C14.5864 2.99998 14.6714 3.02236 14.7466 3.06495C14.8217 3.10753 14.8846 3.16888 14.929 3.243L17.925 8.236C17.9806 8.3252 18.0066 8.42963 17.9994 8.53447C17.9922 8.6393 17.9522 8.73921 17.885 8.82L10.387 17.817L10.344 17.863C10.2942 17.9103 10.2351 17.9468 10.1705 17.9703C10.1059 17.9937 10.0371 18.0036 9.9685 17.9993C9.8999 17.995 9.83293 17.9765 9.77177 17.9452C9.71061 17.9138 9.65657 17.8702 9.61302 17.817L2.11902 8.823C2.0512 8.74315 2.01018 8.644 2.00174 8.53957C1.99331 8.43514 2.0179 8.3307 2.07202 8.241L5.07103 3.243Z" fill="url(#paint6_linear_2353_132718)" fill-opacity="0.7"/><defs><linearGradient id="paint0_linear_2353_132718" x1="13.5" y1="3" x2="17.5" y2="12" gradientUnits="userSpaceOnUse"><stop stop-color="#0FAFFF"/><stop offset="1" stop-color="#102784"/></linearGradient><linearGradient id="paint1_linear_2353_132718" x1="8.00001" y1="0.5" x2="4.50001" y2="8" gradientUnits="userSpaceOnUse"><stop stop-color="#9FF0F9"/><stop offset="1" stop-color="#29C3FF"/></linearGradient><linearGradient id="paint2_linear_2353_132718" x1="10" y1="3" x2="10" y2="10.5" gradientUnits="userSpaceOnUse"><stop stop-color="#3BD5FF"/><stop offset="1" stop-color="#367AF2"/></linearGradient><linearGradient id="paint3_linear_2353_132718" x1="20" y1="3" x2="11" y2="17" gradientUnits="userSpaceOnUse"><stop stop-color="#1B44B1"/><stop offset="1" stop-color="#2052CB"/></linearGradient><linearGradient id="paint4_linear_2353_132718" x1="3.50003" y1="6" x2="9.50003" y2="18" gradientUnits="userSpaceOnUse"><stop stop-color="#0094F0"/><stop offset="1" stop-color="#6CE0FF"/></linearGradient><linearGradient id="paint5_linear_2353_132718" x1="10" y1="4.5" x2="10" y2="18" gradientUnits="userSpaceOnUse"><stop stop-color="#2052CB"/><stop offset="1" stop-color="#0FAFFF"/></linearGradient><linearGradient id="paint6_linear_2353_132718" x1="0.375024" y1="-11.125" x2="13.368" y2="19.126" gradientUnits="userSpaceOnUse"><stop offset="0.533" stop-color="#FF6CE8" stop-opacity="0"/><stop offset="1" stop-color="#FF6CE8"/></linearGradient></defs></svg>
            </div>
        </div>
        <div style="margin-bottom: 4px; margin-top: 0px;"><div class="shape-tabs"><div class="shape-tabs-triggers"><div class="shape-tab-trigger" data-target="preset" data-state="active">Shapes</div><div class="shape-tab-trigger" data-target="emoji">Emoji</div><div class="shape-tab-trigger" data-target="flag">Flag</div></div></div><div id="presetShapesContainer" style="display: block;"><div class="selector-grid id-shape-selector"><div class="selector-item" data-state="selected" data-value="rectangle" data-tooltip="Rectangle"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="7" width="18" height="10" rx="2"/></svg><div class="selector-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div></div><div class="selector-item" data-value="square" data-tooltip="Square"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2"/></svg><div class="selector-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div></div><div class="selector-item" data-state="selected" data-value="circle" data-tooltip="Circle"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/></svg><div class="selector-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div></div><div class="selector-item" data-state="selected" data-value="star" data-tooltip="Star"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg><div class="selector-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div></div><div class="selector-item" data-value="wave" data-tooltip="Wave"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16.625 18C17.6917 15.3333 16.7583 14.2667 13.825 14.8C11.1583 15.6 10.3583 14.6667 11.425 12C12.7583 9.33333 11.9583 8.4 9.025 9.2C6.09167 10 5.29167 8.93333 6.625 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg><div class="selector-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div></div><div class="vertical-divider"></div><div class="selector-item custom-shape-btn" id="customShapeBtn" data-value="custom"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_2154_386615)"><path d="M21 8.25V15.75M5.25 2.824L18.75 5.524M3 18.75V5.25M18.75 18.476L5.25 21.176M0.75 0.75H5.25V5.25H0.75V0.75ZM18.75 3.75H23.25V8.25H18.75V3.75ZM18.75 15.75H23.25V20.25H18.75V15.75ZM0.75 18.75H5.25V23.25H0.75V18.75Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></g><defs><clipPath id="clip0_2154_386615"><rect width="24" height="24" fill="white"/></clipPath></defs></svg><span>Custom</span><div class="selector-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div></div></div></div><div id="emojiShapesContainer" style="display: none;"><div class="scrollable-grid-container"><div class="emoji-grid" id="emojiGrid"></div></div></div><div id="flagShapesContainer" style="display: none;"><div class="scrollable-grid-container"><div class="emoji-grid" id="flagGrid"></div></div></div></div>
        <hr style="border: 0; border-top: 1px solid var(--border); margin: 0 0 12px 0;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;"><div><div class="label">Randomize Particles</div><div class="slider-container"><div class="slider-fill" id="randomFill" style="width: 90%;"></div><input type="text" class="slider-value-input" id="randomValueInput" value="90%"><input type="range" id="randomInput" class="slider-input" min="0" max="100" value="90"></div><div class="slider-labels-row"><span>Uniform</span><span>Chaotic</span></div></div><div><div class="label">Particle Amount</div><div class="slider-container"><div class="slider-fill" id="amountFill" style="width: 2%;"></div><input type="text" class="slider-value-input" id="amountValueInput" value="2%"><input type="range" id="amountInput" class="slider-input" min="0" max="100" value="2"></div><div class="slider-labels-row"><span>Less</span><span>More</span></div></div></div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;"><div><div class="label">Particle Size</div><div class="slider-container"><div class="slider-fill" id="zoomFill" style="width: 20%;"></div><input type="text" class="slider-value-input" id="zoomValueInput" value="x1.0"><input type="range" id="zoomInput" class="slider-input" min="0" max="50" value="10"></div><div class="slider-labels-row"><span>x0.0</span><span>x5.0</span></div></div><div><div class="label">Flutter</div><div class="slider-container"><div class="slider-fill" id="flutterFill" style="width: 100%;"></div><input type="text" class="slider-value-input" id="flutterValueInput" value="100%"><input type="range" id="flutterInput" class="slider-input" min="0" max="100" value="100"></div><div class="slider-labels-row"><span>Static</span><span>Spinny</span></div></div></div>
        
        <div class="toggle-row-container"><div class="toggle-row"><span class="toggle-label">Randomize Size</span><label class="switch"><input type="checkbox" id="checkSize" checked><span class="switch-slider"></span></label></div><div class="toggle-row"><span class="toggle-label">Randomize Rotation</span><label class="switch"><input type="checkbox" id="checkRotation" checked><span class="switch-slider"></span></label></div></div>
        <hr style="border: 0; border-top: 1px solid var(--border); margin: 8px 0 0 0;">
        <div id="particleColorSection"><div class="label" style="margin-top: 4px; margin-bottom: 24px;">Confetti Color</div><div class="color-toggle-row" style="margin-bottom: 12px;"><div class="color-toggle-label"><div class="rainbow-icon"><svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#paint0_angular_2580_64390_clip_path)" data-figma-skip-parse="true"><g transform="matrix(0 0.011 -0.011 0 11 11)"><foreignObject x="-1100" y="-1100" width="2200" height="2200"><div xmlns="http://www.w3.org/1999/xhtml" style="background:conic-gradient(from 90deg,rgba(209, 90, 168, 1) 0deg,rgba(84, 125, 253, 1) 24.3555deg,rgba(103, 225, 78, 1) 102.115deg,rgba(254, 255, 136, 1) 176.538deg,rgba(252, 206, 68, 1) 244.038deg,rgba(246, 75, 85, 1) 314.915deg,rgba(209, 90, 168, 1) 360deg);height:100%;width:100%;opacity:1"></div></foreignObject></g></g><rect width="22" height="22" rx="6" data-figma-gradient-fill="{&#34;type&#34;:&#34;GRADIENT_ANGULAR&#34;,&#34;stops&#34;:[{&#34;color&#34;:{&#34;r&#34;:0.32941177487373352,&#34;g&#34;:0.49019607901573181,&#34;b&#34;:0.99215686321258545,&#34;a&#34;:1.0},&#34;position&#34;:0.067654237151145935},{&#34;color&#34;:{&#34;r&#34;:0.40392157435417175,&#34;g&#34;:0.88235294818878174,&#34;b&#34;:0.40392157435417175,&#34;a&#34;:1.0},&#34;position&#34;:0.28365385532379150},{&#34;color&#34;:{&#34;r&#34;:0.99607843160629272,&#34;g&#34;:1.0,&#34;b&#34;:0.53333336114883423,&#34;a&#34;:1.0},&#34;position&#34;:0.49038460850715637},{&#34;color&#34;:{&#34;r&#34;:0.98823529481887817,&#34;g&#34;:0.80784314870834351,&#34;b&#34;:0.26666668057441711,&#34;a&#34;:1.0},&#34;position&#34;:0.67788463830947876},{&#34;color&#34;:{&#34;r&#34;:0.96470588445663452,&#34;g&#34;:0.29411765933036804,&#34;b&#34;:0.33333334326744080,&#34;a&#34;:1.0},&#34;position&#34;:0.87476503849029541},{&#34;color&#34;:{&#34;r&#34;:0.81960785388946533,&#34;g&#34;:0.35294118523597717,&#34;b&#34;:0.65882354974746704,&#34;a&#34;:1.0},&#34;position&#34;:1.0}],&#34;stopsVar&#34;:[{&#34;color&#34;:{&#34;r&#34;:0.32941177487373352,&#34;g&#34;:0.49019607901573181,&#34;b&#34;:0.99215686321258545,&#34;a&#34;:1.0},&#34;position&#34;:0.067654237151145935},{&#34;color&#34;:{&#34;r&#34;:0.40392157435417175,&#34;g&#34;:0.88235294818878174,&#34;b&#34;:0.40392157435417175,&#34;a&#34;:1.0},&#34;position&#34;:0.28365385532379150},{&#34;color&#34;:{&#34;r&#34;:0.99607843160629272,&#34;g&#34;:1.0,&#34;b&#34;:0.53333336114883423,&#34;a&#34;:1.0},&#34;position&#34;:0.49038460850715637},{&#34;color&#34;:{&#34;r&#34;:0.98823529481887817,&#34;g&#34;:0.80784314870834351,&#34;b&#34;:0.26666668057441711,&#34;a&#34;:1.0},&#34;position&#34;:0.67788463830947876},{&#34;color&#34;:{&#34;r&#34;:0.96470588445663452,&#34;g&#34;:0.29411765933036804,&#34;b&#34;:0.33333334326744080,&#34;a&#34;:1.0},&#34;position&#34;:0.87476503849029541},{&#34;color&#34;:{&#34;r&#34;:0.81960785388946533,&#34;g&#34;:0.35294118523597717,&#34;b&#34;:0.65882354974746704,&#34;a&#34;:1.0},&#34;position&#34;:1.0}],&#34;transform&#34;:{&#34;m00&#34;:1.3471115643134642e-15,&#34;m01&#34;:-22.0,&#34;m02&#34;:22.0,&#34;m10&#34;:22.0,&#34;m11&#34;:2.5772017576671316e-14,&#34;m12&#34;:-1.3559564305794594e-14},&#34;opacity&#34;:1.0,&#34;blendMode&#34;:&#34;NORMAL&#34;,&#34;visible&#34;:true}"/><g filter="url(#filter0_f_2580_64390)"><circle cx="11.5" cy="11.5" r="3.5" fill="white"/></g><defs><clipPath id="paint0_angular_2580_64390_clip_path"><rect width="22" height="22" rx="6"/></clipPath><filter id="filter0_f_2580_64390" x="4" y="4" width="15" height="15" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB"><feFlood flood-opacity="0" result="BackgroundImageFix"/><feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape"/><feGaussianBlur stdDeviation="2" result="effect1_foregroundBlur_2580_64390"/></filter></defs></svg></div><span>Multi-color</span></div><label class="switch"><input type="checkbox" id="multiColorSwitch"><span class="switch-slider"></span></label></div><div class="color-header-box"><span class="color-count-text" id="colorCounter">0 Colors</span><button class="icon-btn-flat" id="addColorBtn"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button></div><div class="color-list-container"><div class="scrollable-grid-container"><div id="colorRowsContainer" style="display: flex; flex-direction: column; gap: 8px;"></div></div></div></div>
        <hr style="border: 0; border-top: 1px solid var(--border); margin: 8px 0 0 0;">
        <div id="animationSettingsSection">
            <div class="label" style="margin-top: 8px; margin-bottom: 24px;">Animation Settings <span class="recommended-tag">Recommended</span></div>
            <div class="grouped-settings-box" style="padding: 10px; gap: 8px;">
                <div class="number-input-row"><span class="toggle-label">Animation Delay (ms)</span><input type="number" id="frameDelayInput" class="number-input-field" value="100" min="1"></div>
                <div class="number-input-row"><span class="toggle-label">Frame Count (Min 1)</span><input type="number" id="frameCountInput" class="number-input-field" value="20" min="1"></div>
            </div>
        </div>
        <hr class="section-divider"><div class="footer"><button id="resetBtn" class="btn btn-outline">Reset</button></div>

        <div class="attribution-bottom">
          <span style="font-size: 12px; color: var(--muted-foreground); pointer-events: none;">v1.1.0</span>
          <a href="https://toolshq.com" target="_blank" class="credit-link">Made with ‚ô•Ô∏è by ToolsHQ</a>
        </div>
    </div>
    
    <div class="preview-panel">
        <div class="preview-title">Preview</div>
        <div class="preview-canvas">
            <div id="panzoomContainer">
                 <svg id="previewSvg" width="100%" height="100%" viewBox="0 0 1440 1080" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet"></svg>
            </div>
        </div>
        <div class="preview-footer">
            <button id="generateBtn" class="btn btn-primary">
                <span id="generateBtnText">Generate Confetti</span>
                <div class="loader" id="generateLoader"></div>
            </button>
        </div>
    </div>
  </div> 
  
  <div id="colorPickerPopover" class="color-picker-popover">
      <div class="cp-header">
          <span id="cpHeaderTitle">Add Color</span>
          <button id="cpCloseBtn" class="icon-btn-flat">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
      </div>
      
      <div class="cp-tabs">
          <div class="cp-tab active" data-tab="solid" onclick="switchColorTab('solid')">
              <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M16.2256 0C19.1111 0.000212547 21.4502 2.34101 21.4502 5.22656V16.2266C21.4497 19.1117 19.1108 21.451 16.2256 21.4512H5.22559C2.34037 21.451 0.000475279 19.1117 0 16.2266V5.22656C0 2.34101 2.34008 0.000214432 5.22559 0H16.2256ZM5.22559 1.65137C3.25135 1.65158 1.65039 3.25228 1.65039 5.22656V16.2266C1.65087 18.2004 3.25164 19.8006 5.22559 19.8008H16.2256C18.1995 19.8006 19.7993 18.2004 19.7998 16.2266V5.22656C19.7998 3.25228 18.1998 1.65158 16.2256 1.65137H5.22559ZM16.2256 3.02539C17.4406 3.0254 18.4258 4.01056 18.4258 5.22559V16.2266C18.4258 17.4406 17.4406 18.4258 16.2256 18.4258H5.22559C4.01056 18.4258 3.0254 17.4406 3.02539 16.2256V5.22559C3.02539 4.01056 4.01056 3.02539 5.22559 3.02539H16.2256Z" fill="#007AFF"/>
              </svg>
              <span>Solid</span>
          </div>
          <div class="cp-tab" data-tab="linear" onclick="switchColorTab('linear')">
              <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_2349_132709)"><path d="M4 14.5C4.43333 14.5 4.79167 14.3583 5.075 14.075C5.35833 13.7917 5.5 13.4333 5.5 13C5.5 12.5667 5.35833 12.2083 5.075 11.925C4.79167 11.6417 4.43333 11.5 4 11.5C3.56667 11.5 3.20833 11.6417 2.925 11.925C2.64167 12.2083 2.5 12.5667 2.5 13C2.5 13.4333 2.64167 13.7917 2.925 14.075C3.20833 14.3583 3.56667 14.5 4 14.5ZM8 10C8.28333 10 8.521 9.904 8.713 9.712C8.905 9.52 9.00067 9.28267 9 5C8.99933 8.71733 8.90333 8.48 8.712 8.288C8.52067 8.096 8.28333 8 8 8C7.71667 8 7.47933 8.096 7.288 8.288C7.09667 8.48 7.00067 8.71733 7 9C6.99933 9.28267 7.09533 9.52033 7.288 9.713C7.48067 9.90567 7.718 10.0013 8 10ZM8 6C8.28333 6 8.521 5.904 8.713 5.712C8.905 5.52 9.00067 5.28267 9 5C8.99933 4.71733 8.90333 4.48 8.712 4.288C8.52067 4.096 8.28333 4 8 4C7.71667 4 7.47933 4.096 7.288 4.288C7.09667 4.48 7.00067 4.71733 7 5C6.99933 5.28267 7.09533 5.52033 7.288 5.713C7.48067 5.90567 7.718 6.00133 8 6ZM4 6.5C4.43333 6.5 4.79167 6.35833 5.075 6.075C5.35833 5.79167 5.5 5.43333 5.5 5C5.5 4.56667 5.35833 4.20833 5.075 3.925C4.79167 3.64167 4.43333 3.5 4 3.5C3.56667 3.5 3.20833 3.64167 2.925 3.925C2.64167 4.20833 2.5 4.56667 2.5 5C2.5 5.43333 2.64167 5.79167 2.925 6.075C3.20833 6.35833 3.56667 6.5 4 6.5ZM4 10.5C4.43333 10.5 4.79167 10.3583 5.075 10.075C5.35833 9.79167 5.5 9.43333 5.5 9C5.5 8.56667 5.35833 8.20833 5.075 7.925C4.79167 7.64167 4.43333 7.5 4 7.5C3.56667 7.5 3.20833 7.64167 2.925 7.925C2.64167 8.20833 2.5 8.56667 2.5 9C2.5 9.43333 2.64167 9.79167 2.925 10.075C3.20833 10.3583 3.56667 10.5 4 10.5ZM8 14C8.28333 14 8.521 13.904 8.713 13.712C8.905 13.52 9.00067 13.2827 9 13C8.99933 12.7173 8.90333 12.48 8.712 12.288C8.52067 12.096 8.28333 12 8 12C7.71667 12 7.47933 12.096 7.288 12.288C7.09667 12.48 7.00067 12.7173 7 13C6.99933 13.2827 7.09533 13.5203 7.288 13.713C7.48067 13.9057 7.718 14.0013 8 14ZM15 13.5C15.15 13.5 15.271 13.4543 15.363 13.363C15.455 13.2717 15.5007 13.1507 15.5 13C15.4993 12.8493 15.4537 12.7283 15.363 12.637C15.2723 12.5457 15.1513 12.5 15 12.5C14.8487 12.5 14.7277 12.546 14.637 12.638C14.5463 12.73 14.5007 12.8507 14.5 13C14.4993 13.1493 14.5453 13.2703 14.638 13.363C14.7307 13.4557 14.8513 13.5013 15 13.5ZM15 5.5C15.15 5.5 15.271 5.45433 15.363 5.363C15.455 5.27167 15.5007 5.15067 15.5 5C15.4993 4.84933 15.4537 4.72833 15.363 4.637C15.2723 4.54567 15.1513 4.5 15 4.5C14.8487 4.5 14.7277 4.546 14.637 4.638C14.5463 4.73 14.5007 4.85067 14.5 5C14.4993 5.14933 14.5453 5.27033 14.638 5.363C14.7307 5.45567 14.8513 5.50133 15 5.5ZM15 9.5C15.15 9.5 15.271 9.45433 15.363 9.363C15.455 9.27167 15.5007 9.15067 15.5 9C15.4993 8.84933 15.4537 8.72833 15.363 8.637C15.2723 8.54567 15.1513 8.5 15 8.5C14.8487 8.5 14.7277 8.546 14.637 8.638C14.5463 8.73 14.5007 8.85067 14.5 9C14.4993 9.14933 14.5453 9.27033 14.638 9.363C14.7307 9.45567 14.8513 9.50133 15 9.5ZM12 6C12.2833 6 12.521 5.904 12.713 5.712C12.905 5.52 13.0007 5.28267 13 5C12.9993 4.71733 12.9033 4.48 12.712 4.288C12.5207 4.096 12.2833 4 12 4C11.7167 4 11.4793 4.096 11.288 4.288C11.0967 4.48 11.0007 4.71733 11 5C10.9993 5.28267 11.0953 5.52033 11.288 5.713C11.4807 5.90567 11.718 6.00133 12 6ZM12 10C12.2833 10 12.521 9.904 12.713 9.712C12.905 9.52 13.0007 9.28267 13 9C12.9993 8.71733 12.9033 8.48 12.712 8.288C12.5207 8.096 12.2833 8 12 8C11.7167 8 11.4793 8.096 11.288 8.288C11.0967 8.48 11.0007 8.71733 11 9C10.9993 9.28267 11.0953 9.52033 11.288 9.713C11.4807 9.90567 11.718 10.0013 12 10ZM12 14C12.2833 14 12.521 13.904 12.713 13.712C12.905 13.52 13.0007 13.2827 13 13C12.9993 12.7173 12.9033 12.48 12.712 12.288C12.5207 12.096 12.2833 12 12 12C11.7167 12 11.4793 12.096 11.288 12.288C11.0967 12.48 11.0007 12.7173 11 13C10.9993 13.2827 11.0953 13.5203 11.288 13.713C11.4807 13.9057 11.718 14.0013 12 14ZM18 1V17C18 17.2833 17.904 17.521 17.712 17.713C17.52 17.905 17.2827 18.0007 17 18H1C0.716667 18 0.479333 17.904 0.288 17.712C0.0966668 17.52 0.000666667 17.2827 0 17V1C0 0.716667 0.0960001 0.479333 0.288 0.288C0.48 0.0966668 0.717333 0.000666667 1 0H17C17.2833 0 17.521 0.0960001 17.713 0.288C17.905 0.48 18.0007 0.717333 18 1Z" fill="#292D32"/></g><defs><clipPath id="clip0_2349_132709"><rect width="18" height="18" rx="5" fill="white"/></clipPath></defs></svg>
              <span>Linear</span>
          </div>
      </div>

      <div class="cp-content-scrollable">
          
          <div id="cpSolidContent">
              <div id="sharedPicker">
                  <div class="cp-sat-bright-area" id="cpSatBrightArea"><div class="cp-sb-selector" id="cpSbSelector"></div></div>
                  <div class="cp-sliders">
                      <div class="cp-slider-track cp-hue-slider" id="cpHueSlider"><div class="cp-slider-thumb" id="cpHueThumb"></div></div>
                      <div class="cp-slider-track cp-alpha-slider" id="cpAlphaSlider"><div class="cp-slider-track cp-alpha-slider-bar" id="cpAlphaBar"></div><div class="cp-slider-thumb" id="cpAlphaThumb"></div></div>
                  </div>
                  <div class="cp-inputs-row"><div class="cp-input-wrapper cp-hex-wrapper"><span>Hex</span><input type="text" id="cpHexInput" class="cp-input-field" value="FF0000" maxlength="6"></div><div class="cp-input-wrapper cp-alpha-wrapper"><input type="number" id="cpAlphaInput" class="cp-input-field" value="100" min="0" max="100"><span>%</span></div></div>
              </div>
              <div class="cp-swatches-section"><div class="label" style="margin-bottom: 8px;">Preset Colors</div><div class="cp-swatch-grid" id="cpSwatchGrid"></div></div>
          </div>

          <div id="cpLinearContent">
              <div class="linear-controls-row">
                  <div class="custom-dropdown" id="linearTypeDropdown">
                      <div class="dropdown-trigger" onclick="event.stopPropagation(); toggleLinearDropdown()">
                          <span id="linearTypeLabel">Linear</span> 
                          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                      </div>
                      <div class="dropdown-content" id="linearDropdownContent">
                          <div class="dropdown-item selected" onclick="selectLinearType('Linear')">Linear</div>
                          <div class="dropdown-item" onclick="selectLinearType('Radial')">Radial</div>
                          <div class="dropdown-item" onclick="selectLinearType('Angular')">Angular</div>
                          <div class="dropdown-item" onclick="selectLinearType('Diamond')">Diamond</div>
                      </div>
                  </div>
                  <div class="linear-actions">
                      <button class="icon-btn-flat" id="flipHorizontalBtn" title="Flip Horizontal">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.28 10.45L21 6.72998L17.28 3.01001" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 6.72998H21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M6.71997 13.55L3 17.27L6.71997 20.99" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 17.27H3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                      </button>
                      <button class="icon-btn-flat" id="flipVerticalBtn" title="Flip Vertical">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.25 22H11.75C15.5 22 17 20.5 17 16.75V12.25C17 8.5 15.5 7 11.75 7H7.25C3.5 7 2 8.5 2 12.25V16.75C2 20.5 3.5 22 7.25 22Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 9C22 5.13 18.87 2 15 2L16.05 3.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                      </button>
                  </div>
              </div>
              
              <div class="gradient-slider-container" id="gradientSliderContainer">
                  <div class="gradient-bar" id="gradientBar"></div>
                  </div>

              <div class="stops-section">
                  <div class="stops-header">
                      <span>Stops</span>
                      <button class="icon-btn-flat" id="addStopBtn" title="Add Stop">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                      </button>
                  </div>
                  <div class="stops-list" id="stopsListContainer">
                      </div>
              </div>
          </div>

      </div> 
      <button id="cpAddConfirmBtn" class="btn btn-primary" style="width: 100%;">Add Color</button>
  </div>

  <div id="customShapePopover" class="custom-shape-popover">
      <div class="cp-header">
          <span>Custom Shape Editor</span>
          <div style="display: flex; gap: 8px;">
              <button id="csImportBtn" class="icon-btn-flat" title="Import SVG">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16.4405 8.8999C20.0405 9.2099 21.5105 11.0599 21.5105 15.1099V15.2399C21.5105 19.7099 19.7205 21.4999 15.2505 21.4999H8.74047C4.27047 21.4999 2.48047 19.7099 2.48047 15.2399V15.1099C2.48047 11.0899 3.93047 9.2399 7.47047 8.9099" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 2V14.88" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M15.3504 12.6499L12.0004 15.9999L8.65039 12.6499" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
              </button>
              <input type="file" id="csFileInput" accept=".svg" style="display: none;">
              <button id="csCloseBtn" class="icon-btn-flat">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
          </div>
      </div>
      <div style="font-size: 12px; color: var(--muted-foreground); margin-bottom: 8px;">Drag points to edit or import an SVG file (Max 100kb).</div>
      <div class="cs-canvas-container">
          <svg id="csEditorSvg" viewBox="0 0 320 320" xmlns="http://www.w3.org/2000/svg"></svg>
          <div id="csResetIcon" class="cs-reset-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
          </div>
      </div>
      <button id="csSaveBtn" class="btn btn-primary">Save Shape</button>
  </div>

  <div id="successToast" class="toast">
      <div class="toast-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
      </div>
      <span>Confetti generated successfully!</span>
  </div>

  <script>
    // --- GLOBALS ---
    const previewSvg = document.getElementById('previewSvg');
    const panzoomContainer = document.getElementById('panzoomContainer');
    const customShapeBtn = document.getElementById('customShapeBtn');
    const customShapePopover = document.getElementById('customShapePopover');
    const csCloseBtn = document.getElementById('csCloseBtn');
    const csSaveBtn = document.getElementById('csSaveBtn');
    const csEditorSvg = document.getElementById('csEditorSvg');
    const csResetIcon = document.getElementById('csResetIcon');
    const csImportBtn = document.getElementById('csImportBtn');
    const csFileInput = document.getElementById('csFileInput');
    const presetShapesContainer = document.getElementById('presetShapesContainer');
    const emojiShapesContainer = document.getElementById('emojiShapesContainer');
    const flagShapesContainer = document.getElementById('flagShapesContainer');
    const particleColorSection = document.getElementById('particleColorSection');
    const emojiGrid = document.getElementById('emojiGrid');
    const flagGrid = document.getElementById('flagGrid');

    let previewParticles = []; 
    let panzoomInstance; 
    let selectedEmoji = null; 
    let activeShapeTab = 'preset'; 
    let finalCustomShapePathStr = ""; 
    let finalCustomViewBox = "0 0 320 320"; 
    let csHistory = []; 
    let selectedEmojis = [];
    let selectedFlags = [];
    let flagDataCache = {};

    // --- HELPER UTILS ---
    function createSvgElement(type, attributes) { const el = document.createElementNS("http://www.w3.org/2000/svg", type); for (const key in attributes) el.setAttribute(key, attributes[key]); return el; }
    function hexToRgb(hex) { const res = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return res ? { r: parseInt(res[1], 16), g: parseInt(res[2], 16), b: parseInt(res[3], 16) } : null; }
    function rgbToHex(r, g, b) { return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase(); }
    
    // --- GRADIENT STATE ---
    let gradientStops = [
        { percent: 0, color: '#D966FF', alpha: 1 },
        { percent: 100, color: '#823D99', alpha: 1 }
    ];
    let isVerticalFlip = false; 
    let activeStopIndex = 0; 
    let pickerHSLA = { h: 0, s: 100, l: 50, a: 1 }; 

    // --- SETUP SLIDERS ---
    function setupSlider(sliderInputId, fillId, textInputId, format, regenerateOnChange = true) {
      const sliderInput = document.getElementById(sliderInputId); const fill = document.getElementById(fillId); const textInput = document.getElementById(textInputId);
      const min = parseFloat(sliderInput.min) || 0; const max = parseFloat(sliderInput.max) || 100;
      function updateFromSlider() {
        let val = parseFloat(sliderInput.value); const percent = ((val - min) / (max - min)) * 100; fill.style.width = `${percent}%`;
        if (format === 'percent') { textInput.value = `${Math.round(val)}%`; } else if (format === 'zoom') { textInput.value = `x${(val / 10).toFixed(1)}`; }
        
        let keepPositions = !regenerateOnChange;
        let type = undefined;
        
        if (sliderInputId === 'zoomInput') type = 'scale';
        if (sliderInputId === 'flutterInput') {
            type = 'flutter';
            keepPositions = true; 
        }
        
        triggerPreviewUpdate(keepPositions, type);
      }
      function updateFromText() {
          let rawValue = textInput.value; let numericValue;
          if (format === 'percent') { rawValue = rawValue.replace(/[^0-9.]/g, ''); numericValue = parseFloat(rawValue); } else if (format === 'zoom') { rawValue = rawValue.replace(/[^0-9.]/g, ''); numericValue = parseFloat(rawValue); if (!isNaN(numericValue)) { numericValue = Math.round(numericValue * 10); } }
          if (isNaN(numericValue)) { numericValue = parseFloat(sliderInput.value); } else { numericValue = Math.max(min, Math.min(max, numericValue)); }
          sliderInput.value = numericValue; updateFromSlider(); 
      }
      function triggerPreviewUpdate(keepPositions, changeType) { updatePreview(keepPositions, changeType); }
      sliderInput.addEventListener('input', updateFromSlider); textInput.addEventListener('change', updateFromText); textInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') { e.target.blur(); } });
    }
    
    setupSlider('randomInput', 'randomFill', 'randomValueInput', 'percent', true); 
    setupSlider('amountInput', 'amountFill', 'amountValueInput', 'percent', true); 
    setupSlider('zoomInput', 'zoomFill', 'zoomValueInput', 'zoom', false);
    setupSlider('flutterInput', 'flutterFill', 'flutterValueInput', 'percent', true);

    document.querySelectorAll('.tabs-list .tab-trigger:not(.disabled)').forEach(tab => { tab.addEventListener('click', () => { document.querySelectorAll('.tabs-list .tab-trigger').forEach(t => t.removeAttribute('data-state')); tab.setAttribute('data-state', 'active'); updatePreview(false); }); });
    document.getElementById('checkSize').addEventListener('change', () => updatePreview(true, 'scale')); document.getElementById('checkRotation').addEventListener('change', () => updatePreview(true, 'rotation'));

    let colorState = { isMultiColor: false, colors: [] }; let editingColorIndex = -1;
    const multiColorSwitch = document.getElementById('multiColorSwitch'); const colorRowsContainer = document.getElementById('colorRowsContainer'); const colorCounter = document.getElementById('colorCounter'); const addColorBtn = document.getElementById('addColorBtn');

    function renderColorList() {
        if (colorState.isMultiColor) { colorCounter.textContent = "Multi-color"; } else { colorCounter.textContent = `${colorState.colors.length} Colors`; }
        addColorBtn.disabled = colorState.isMultiColor; colorRowsContainer.innerHTML = '';
        colorState.colors.forEach((colorData, index) => {
            const row = document.createElement('div'); row.className = `color-item-row ${colorState.isMultiColor ? 'disabled' : ''}`;
            let hexDisplay = ""; let opacityDisplay = ""; let bgStyle = "";
            if (colorData.type === 'linear') {
                hexDisplay = colorData.subtype || "Linear Gradient";
                opacityDisplay = Math.round((colorData.a || 1.0) * 100);
                const stops = colorData.stops; const sorted = [...stops].sort((a,b)=>a.percent-b.percent);
                const angle = colorData.isVertical ? '0deg' : '90deg';
                const css = `linear-gradient(${angle}, ${sorted.map(s => `${s.color} ${s.percent}%`).join(', ')})`;
                bgStyle = `background: ${css};`;
            } else {
                hexDisplay = hslToHex(colorData.h, colorData.s, colorData.l);
                opacityDisplay = Math.round(colorData.a * 100);
                bgStyle = `background-color: ${hexDisplay}; opacity: ${colorData.a};`;
            }
            row.innerHTML = `<div class="color-preview-sq" style="${bgStyle}"></div><span class="color-hex-text">${hexDisplay}</span><div style="display: flex; align-items: center; margin-right: 8px;"><input type="number" class="color-percent-input" data-index="${index}" value="${opacityDisplay}" min="0" max="100" ${colorState.isMultiColor ? 'disabled' : ''}><span style="margin-left: 4px; color: var(--muted-foreground); font-size: 14px;">%</span></div><button class="icon-btn-flat delete-color-btn" data-index="${index}" ${colorState.isMultiColor ? 'disabled' : ''}><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg></button>`;
            
            const previewSq = row.querySelector('.color-preview-sq'); 
            previewSq.addEventListener('click', () => { if (colorState.isMultiColor) return; openPopoverToEdit(index, previewSq); });
            const percentInput = row.querySelector('.color-percent-input'); 
            percentInput.addEventListener('change', (e) => { 
                let newVal = parseInt(e.target.value); 
                if (isNaN(newVal) || newVal === null) newVal = 100; 
                newVal = Math.max(0, Math.min(100, newVal)); 
                e.target.value = newVal; 
                colorState.colors[index].a = newVal / 100; 
                renderColorList(); 
                updatePreview(true, 'color'); 
            });
            const deleteBtn = row.querySelector('.delete-color-btn'); 
            deleteBtn.addEventListener('click', () => { if (colorState.isMultiColor) return; if (editingColorIndex === index) { editingColorIndex = -1; closePopover(); } colorState.colors.splice(index, 1); renderColorList(); updatePreview(true, 'color'); });
            colorRowsContainer.prepend(row);
        });
    }
    multiColorSwitch.addEventListener('change', (e) => { colorState.isMultiColor = e.target.checked; if (colorState.isMultiColor) { closePopover(); editingColorIndex = -1; } renderColorList(); updatePreview(true, 'color'); });
    
    const popover = document.getElementById('colorPickerPopover'); const cpCloseBtn = document.getElementById('cpCloseBtn'); const cpAddConfirmBtn = document.getElementById('cpAddConfirmBtn'); const cpHeaderTitle = document.getElementById('cpHeaderTitle');
    let currentTab = 'solid';

    window.switchColorTab = function(tabName, skipAutoGradient = false) {
        const previousTab = currentTab;
        currentTab = tabName;
        document.querySelectorAll('.cp-tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.cp-tab[data-tab="${tabName}"]`).classList.add('active');
        const sharedPicker = document.getElementById('sharedPicker');
        
        if (tabName === 'solid') {
            document.getElementById('cpSolidContent').style.display = 'block';
            document.getElementById('cpLinearContent').style.display = 'none';
            document.getElementById('miniColorPopover').style.display = 'none';
            const swatchGrid = document.getElementById('cpSwatchGrid');
            if (swatchGrid && swatchGrid.parentElement) { swatchGrid.parentElement.parentElement.insertBefore(sharedPicker, swatchGrid.parentElement); }
        } else {
            document.getElementById('cpSolidContent').style.display = 'none';
            document.getElementById('cpLinearContent').style.display = 'flex';
            document.getElementById('hiddenPickerStorage').appendChild(sharedPicker);
            
            if (previousTab === 'solid' && !skipAutoGradient) {
                const startHex = hslToHex(pickerHSLA.h, pickerHSLA.s, pickerHSLA.l);
                const darkL = Math.max(0, pickerHSLA.l - 30);
                const endHex = hslToHex(pickerHSLA.h, pickerHSLA.s, darkL);
                gradientStops = [
                    { percent: 0, color: startHex, alpha: pickerHSLA.a },
                    { percent: 100, color: endHex, alpha: pickerHSLA.a }
                ];
                activeStopIndex = 0;
            }
            updateGradientVisuals(); 
        }
    }
    function toggleLinearDropdown() { document.getElementById('linearDropdownContent').classList.toggle('show'); }
    window.toggleLinearDropdown = toggleLinearDropdown;
    window.addEventListener('click', (e) => {
        const dropdown = document.getElementById('linearDropdownContent');
        const trigger = document.getElementById('linearTypeDropdown');
        if (dropdown && dropdown.classList.contains('show') && !trigger.contains(e.target)) { dropdown.classList.remove('show'); }
    });
    
    function selectLinearType(type) { 
        document.getElementById('linearTypeLabel').textContent = type; 
        document.querySelectorAll('.dropdown-item').forEach(i => {
            i.classList.remove('selected');
            if (i.textContent === type) i.classList.add('selected');
        }); 
        document.getElementById('linearDropdownContent').classList.remove('show'); 
        updateGradientVisuals();
    }
    window.selectLinearType = selectLinearType;

    const gradientSliderContainer = document.getElementById('gradientSliderContainer'); const gradientBar = document.getElementById('gradientBar'); const stopsListContainer = document.getElementById('stopsListContainer');
    let draggingHandleIndex = null;

    function renderHandles() {
        const handles = gradientSliderContainer.querySelectorAll('.gradient-handle'); handles.forEach(h => h.remove());
        gradientStops.forEach((stop, index) => {
            const handle = document.createElement('div'); handle.className = 'gradient-handle';
            if (index === activeStopIndex) handle.classList.add('active');
            handle.style.left = `${stop.percent}%`;
            handle.innerHTML = `<svg viewBox="0 0 28 31" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.5 4.5C1.5 2.84315 2.84315 1.5 4.5 1.5H23.5C25.1569 1.5 26.5 2.84315 26.5 4.5V21.5C26.5 23.1569 25.1569 24.5 23.5 24.5H20.8526C19.8857 24.5 18.978 24.9661 18.4146 25.7519L16.6805 28.1702C15.5617 29.7306 13.2856 29.8529 12.006 28.4216L9.39447 25.5005C8.82534 24.8639 8.01187 24.5 7.15794 24.5H4.5C2.84315 24.5 1.5 23.1569 1.5 21.5V4.5Z" fill="${stop.color}" stroke="${index === activeStopIndex ? '#1890FF' : 'transparent'}" stroke-width="3"/></svg>`;
            handle.addEventListener('mousedown', (e) => onHandleMouseDown(e, index));
            handle.addEventListener('click', (e) => { e.stopPropagation(); setActiveStop(index); });
            gradientSliderContainer.appendChild(handle);
        });
    }

    function updateGradientVisuals() {
        renderHandles();
        const sorted = [...gradientStops].sort((a,b) => a.percent - b.percent);
        const stopsStr = sorted.map(s => { 
            const rgb = hexToRgb(s.color); 
            return `rgba(${rgb.r},${rgb.g},${rgb.b},${s.alpha}) ${s.percent}%`; 
        }).join(', ');
        
        const subtype = document.getElementById('linearTypeLabel').textContent;
        if (subtype === 'Radial') {
            gradientBar.style.background = `radial-gradient(circle, ${stopsStr})`;
        } else if (subtype === 'Angular') {
            gradientBar.style.background = `conic-gradient(from 0deg, ${stopsStr})`;
        } else if (subtype === 'Diamond') {
            gradientBar.style.background = `radial-gradient(circle, ${stopsStr})`;
        } else {
            gradientBar.style.background = `linear-gradient(${isVerticalFlip ? '0deg' : '90deg'}, ${stopsStr})`;
        }
        renderStopsList();
    }
    function setActiveStop(index) {
        activeStopIndex = index;
        const activeStop = gradientStops[index];
        const hsl = hexToHsl(activeStop.color);
        pickerHSLA = { h: hsl.h, s: hsl.s, l: hsl.l, a: activeStop.alpha };
        updatePickerVisuals(); updateGradientVisuals();
    }
    function applyPickerToActive() {
        const isMiniOpen = document.getElementById('miniColorPopover').style.display === 'block';
        if (currentTab === 'solid' || isMiniOpen) {
            const hex = hslToHex(pickerHSLA.h, pickerHSLA.s, pickerHSLA.l);
            gradientStops[activeStopIndex].color = hex; 
            gradientStops[activeStopIndex].alpha = pickerHSLA.a;
            updateGradientVisuals();
        }
    }
    function updateStopPosition(e, index) {
        let val = parseInt(e.target.value); if (isNaN(val)) val = 0; val = Math.max(0, Math.min(100, val));
        const activeObj = gradientStops[activeStopIndex];
        gradientStops[index].percent = val; gradientStops.sort((a,b) => a.percent - b.percent);
        activeStopIndex = gradientStops.indexOf(activeObj); updateGradientVisuals();
    }

    function openMiniColorPopover(e, idx) {
        setActiveStop(idx);
        const popover = document.getElementById('miniColorPopover');
        const sharedPicker = document.getElementById('sharedPicker');
        popover.insertBefore(sharedPicker, document.getElementById('miniSaveBtn'));
        popover.style.display = 'block';
        const mainPopover = document.getElementById('colorPickerPopover'); 
        const mainRect = mainPopover.getBoundingClientRect();
        const popRect = popover.getBoundingClientRect();
        const miniWidth = popRect.width || 286;
        const miniHeight = popRect.height || 300;
        const gap = 12; const padding = 10;
        let left = mainRect.left - miniWidth - gap;
        if (left < padding) left = mainRect.right + gap;
        if (left + miniWidth > window.innerWidth - padding) { left = window.innerWidth - miniWidth - padding; }
        if (left < padding) left = padding;
        let top = mainRect.bottom - miniHeight;
        if (top + miniHeight > window.innerHeight - padding) { top = window.innerHeight - miniHeight - padding; }
        if (top < padding) top = padding;
        popover.style.top = `${top}px`; popover.style.left = `${left}px`;
        document.removeEventListener('click', closePopoverOnClickOutside);
        setTimeout(() => document.addEventListener('click', closeMiniPopoverOnClickOutside), 0);
    }

    function closeMiniPopover() {
        const popover = document.getElementById('miniColorPopover'); popover.style.display = 'none';
        document.removeEventListener('click', closeMiniPopoverOnClickOutside);
        document.getElementById('hiddenPickerStorage').appendChild(document.getElementById('sharedPicker'));
        setTimeout(() => document.addEventListener('click', closePopoverOnClickOutside), 10);
    }
    window.closeMiniPopover = closeMiniPopover;
    function closeMiniPopoverOnClickOutside(e) { const popover = document.getElementById('miniColorPopover'); if (!popover.contains(e.target) && !e.target.classList.contains('stop-swatch')) { closeMiniPopover(); } }
    function renderStopsList() {
        stopsListContainer.innerHTML = '';
        gradientStops.forEach((stop, idx) => {
            const div = document.createElement('div'); div.className = 'stop-row'; if (idx === activeStopIndex) div.classList.add('active');
            div.innerHTML = `<div class="stop-pos-group"><input class="stop-pos-input" type="number" min="0" max="100" value="${Math.round(stop.percent)}">%</div><div class="stop-data-group" onclick="setActiveStop(${idx})"><div class="stop-swatch" style="background-color: ${stop.color};"></div><input class="stop-hex" value="${stop.color.replace('#','')}" maxlength="6"><div class="stop-opacity-group"><input class="stop-opacity" type="number" min="0" max="100" value="${Math.round(stop.alpha * 100)}" data-idx="${idx}">%</div><button class="stop-remove-btn" onclick="event.stopPropagation(); removeGradientStop(${idx})"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg></button></div>`;
            const swatch = div.querySelector('.stop-swatch'); 
            swatch.addEventListener('click', (e) => { 
                const hueSlider = document.getElementById('cpHueSlider');
                if (hueSlider) hueSlider.classList.add('cp-hue-slider'); 
                e.stopPropagation(); openMiniColorPopover(e, idx); 
            });
            const posInput = div.querySelector('.stop-pos-input'); posInput.addEventListener('change', (e) => updateStopPosition(e, idx)); posInput.addEventListener('click', (e) => e.stopPropagation()); 
            const hexInput = div.querySelector('.stop-hex'); hexInput.addEventListener('change', (e) => { let val = e.target.value.trim(); if (/^[0-9A-Fa-f]{6}$/.test(val)) { gradientStops[idx].color = '#' + val.toUpperCase(); updateGradientVisuals(); if(idx === activeStopIndex) { const hsl = hexToHsl('#' + val); pickerHSLA.h = hsl.h; pickerHSLA.s = hsl.s; pickerHSLA.l = hsl.l; updatePickerVisuals(); } } else { e.target.value = gradientStops[idx].color.replace('#',''); } }); hexInput.addEventListener('click', (e) => e.stopPropagation());
            const opInput = div.querySelector('.stop-opacity'); opInput.addEventListener('change', (e) => { let val = parseInt(e.target.value); if(isNaN(val)) val = 100; val = Math.max(0, Math.min(100, val)); gradientStops[idx].alpha = val / 100; updateGradientVisuals(); if(idx === activeStopIndex) { pickerHSLA.a = val / 100; updatePickerVisuals(); } }); opInput.addEventListener('click', (e) => e.stopPropagation());
            stopsListContainer.appendChild(div);
        });
    }
    gradientSliderContainer.addEventListener('click', (e) => {
        if (e.target.closest('.gradient-handle')) return;
        const rect = gradientSliderContainer.getBoundingClientRect();
        const percent = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
        addStopAtPercent(percent);
    });
    function addStopAtPercent(percent) {
        const sorted = [...gradientStops].sort((a,b) => a.percent - b.percent);
        let start = sorted[0]; let end = sorted[sorted.length - 1];
        for (let i = 0; i < sorted.length - 1; i++) { if (percent >= sorted[i].percent && percent <= sorted[i+1].percent) { start = sorted[i]; end = sorted[i+1]; break; } }
        let newColor = '#FF0000'; let newAlpha = 1;
        if (start && end && start !== end) {
            const range = end.percent - start.percent; const ratio = range === 0 ? 0 : (percent - start.percent) / range;
            const c1 = hexToRgb(start.color); const c2 = hexToRgb(end.color);
            if (c1 && c2) { newColor = rgbToHex(Math.round(c1.r + (c2.r - c1.r) * ratio), Math.round(c1.g + (c2.g - c1.g) * ratio), Math.round(c1.b + (c2.b - c1.b) * ratio)); }
            newAlpha = start.alpha + (end.alpha - start.alpha) * ratio;
        } else if (start) { newColor = start.color; newAlpha = start.alpha; }
        const newStop = { percent: percent, color: newColor, alpha: newAlpha };
        gradientStops.push(newStop); gradientStops.sort((a,b) => a.percent - b.percent);
        activeStopIndex = gradientStops.indexOf(newStop); updateGradientVisuals(); setActiveStop(activeStopIndex);
    }
    document.getElementById('addStopBtn').addEventListener('click', () => { addStopAtPercent(50); });
    window.removeGradientStop = function(index) { if (gradientStops.length <= 2) return; gradientStops.splice(index, 1); if (activeStopIndex >= gradientStops.length) activeStopIndex = gradientStops.length - 1; updateGradientVisuals(); }
    function onHandleMouseDown(e, index) { draggingHandleIndex = index; setActiveStop(index); document.addEventListener('mousemove', onHandleDrag); document.addEventListener('mouseup', onHandleStopDrag); e.preventDefault(); }
    function onHandleDrag(e) { if (draggingHandleIndex === null) return; const rect = gradientSliderContainer.getBoundingClientRect(); const percent = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100)); gradientStops[draggingHandleIndex].percent = percent; updateGradientVisuals(); }
    function onHandleStopDrag() { draggingHandleIndex = null; document.removeEventListener('mousemove', onHandleDrag); document.removeEventListener('mouseup', onHandleStopDrag); }
    document.getElementById('flipHorizontalBtn').addEventListener('click', () => { gradientStops.forEach(stop => { stop.percent = 100 - stop.percent; }); updateGradientVisuals(); });
    document.getElementById('flipVerticalBtn').addEventListener('click', () => { isVerticalFlip = !isVerticalFlip; updateGradientVisuals(); });

    function confirmAddColor() {
        if (currentTab === 'solid') {
            const newColorData = { h: pickerHSLA.h, s: pickerHSLA.s, l: pickerHSLA.l, a: pickerHSLA.a, type: 'solid' };
            if (editingColorIndex > -1) { colorState.colors[editingColorIndex] = newColorData; } else { colorState.colors.push(newColorData); }
        } else {
            const subtype = document.getElementById('linearTypeLabel').textContent;
            const newColorData = { 
                type: 'linear', 
                subtype: subtype,
                isVertical: isVerticalFlip, 
                stops: JSON.parse(JSON.stringify(gradientStops)),
                a: editingColorIndex > -1 ? colorState.colors[editingColorIndex].a : 1.0 
            };
            if (editingColorIndex > -1) { colorState.colors[editingColorIndex] = newColorData; } else { colorState.colors.push(newColorData); }
        }
        renderColorList(); updatePreview(true, 'color'); closePopover();
    }

    const cpSatBrightArea = document.getElementById('cpSatBrightArea'); const cpSbSelector = document.getElementById('cpSbSelector'); const cpHueSlider = document.getElementById('cpHueSlider'); const cpHueThumb = document.getElementById('cpHueThumb'); const cpAlphaSlider = document.getElementById('cpAlphaSlider'); const cpAlphaThumb = document.getElementById('cpAlphaThumb'); const cpAlphaBar = document.getElementById('cpAlphaBar'); const cpHexInput = document.getElementById('cpHexInput'); const cpAlphaInput = document.getElementById('cpAlphaInput');
    let isDraggingSB = false; let isDraggingHue = false; let isDraggingAlpha = false;

    function updatePickerVisuals() {
        cpSatBrightArea.style.backgroundColor = `hsl(${pickerHSLA.h}, 100%, 50%)`;
        const hsv = hslToHsv(pickerHSLA.h, pickerHSLA.s, pickerHSLA.l);
        cpSbSelector.style.left = `${hsv.s}%`; cpSbSelector.style.top = `${100 - hsv.v}%`;
        cpHueThumb.style.left = `${(pickerHSLA.h / 360) * 100}%`;
        cpAlphaThumb.style.left = `${pickerHSLA.a * 100}%`;
        const baseHex = hslToHex(pickerHSLA.h, pickerHSLA.s, pickerHSLA.l);
        cpAlphaBar.style.background = `linear-gradient(to right, transparent, ${baseHex})`;
        cpHexInput.value = baseHex.substring(1); cpAlphaInput.value = Math.round(pickerHSLA.a * 100);
    }
    function onPickerChange() { updatePickerVisuals(); applyPickerToActive(); }
    cpSatBrightArea.addEventListener('mousedown', (e) => { isDraggingSB = true; updateSBFromEvent(e); });
    document.addEventListener('mousemove', (e) => { if(isDraggingSB) updateSBFromEvent(e); if(isDraggingHue) updateHueFromEvent(e); if(isDraggingAlpha) updateAlphaFromEvent(e); });
    document.addEventListener('mouseup', () => { isDraggingSB = false; isDraggingHue = false; isDraggingAlpha = false; });
    function updateSBFromEvent(e) { const rect = cpSatBrightArea.getBoundingClientRect(); let x = Math.max(0, Math.min(e.clientX - rect.left, rect.width)); let y = Math.max(0, Math.min(e.clientY - rect.top, rect.height)); const newHSL = hsvToHsl(pickerHSLA.h, (x / rect.width) * 100, 100 - ((y / rect.height) * 100)); pickerHSLA.s = newHSL.s; pickerHSLA.l = newHSL.l; onPickerChange(); }
    cpHueSlider.addEventListener('mousedown', (e) => { isDraggingHue = true; updateHueFromEvent(e); });
    function updateHueFromEvent(e) { const rect = cpHueSlider.getBoundingClientRect(); let x = Math.max(0, Math.min(e.clientX - rect.left, rect.width)); pickerHSLA.h = (x / rect.width) * 360; onPickerChange(); }
    cpAlphaSlider.addEventListener('mousedown', (e) => { isDraggingAlpha = true; updateAlphaFromEvent(e); });
    function updateAlphaFromEvent(e) { const rect = cpAlphaSlider.getBoundingClientRect(); let x = Math.max(0, Math.min(e.clientX - rect.left, rect.width)); pickerHSLA.a = x / rect.width; onPickerChange(); }
    cpHexInput.addEventListener('input', (e) => { hex = e.target.value; if (hex.length === 6 && /^[0-9A-Fa-f]{6}$/.test(hex)) { const hsl = hexToHsl("#" + hex); pickerHSLA.h = hsl.h; pickerHSLA.s = hsl.s; pickerHSLA.l = hsl.l; onPickerChange(); } });
    cpAlphaInput.addEventListener('input', (e) => { let val = parseInt(e.target.value); if (!isNaN(val)) { val = Math.max(0, Math.min(100, val)); pickerHSLA.a = val / 100; onPickerChange(); } });

    const presetColors = ['#FF3B30', '#FF9500', '#FFCC00', '#4CD964', '#5AC8FA', '#007AFF', '#5856D6', '#FF2D55', '#8E8E93', '#C7C7CC', '#D1D1D6', '#E5E5EA', '#F2F2F7', '#FFFFFF', '#000000'];
    const cpSwatchGrid = document.getElementById('cpSwatchGrid');
    presetColors.forEach(hex => { const swatch = document.createElement('div'); swatch.className = 'cp-swatch'; swatch.style.backgroundColor = hex; swatch.addEventListener('click', () => { setPickerColorFromHex(hex); }); cpSwatchGrid.appendChild(swatch); });
    function setPickerColorFromHex(hex) { const hsl = hexToHsl(hex); pickerHSLA.h = hsl.h; pickerHSLA.s = hsl.s; pickerHSLA.l = hsl.l; pickerHSLA.a = 1.0; onPickerChange(); }

    function openPopoverToEdit(index, triggerElement) { 
        editingColorIndex = index; const colorToEdit = colorState.colors[index]; 
        if (colorToEdit.type === 'linear') { 
            gradientStops = JSON.parse(JSON.stringify(colorToEdit.stops)); 
            isVerticalFlip = colorToEdit.isVertical; 
            activeStopIndex = 0; 
            selectLinearType(colorToEdit.subtype || 'Linear');
            switchColorTab('linear', true); 
            setActiveStop(0); 
        } else { 
            pickerHSLA = { h: colorToEdit.h, s: colorToEdit.s, l: colorToEdit.l, a: colorToEdit.a }; updatePickerVisuals(); switchColorTab('solid'); 
        }
        cpHeaderTitle.textContent = "Edit Color"; cpAddConfirmBtn.textContent = "Save Color"; openPopover(triggerElement); 
    }
    function openPopover(triggerElement = addColorBtn) { if (colorState.isMultiColor) return; popover.style.visibility = 'hidden'; popover.style.display = 'flex'; if(editingColorIndex === -1) switchColorTab('solid'); const btnRect = triggerElement.getBoundingClientRect(); const popoverRect = popover.getBoundingClientRect(); const leftPos = btnRect.right + 12; const btnCenterY = btnRect.top + (btnRect.height / 2); let topPos = btnCenterY - (popoverRect.height / 2); const padding = 10; topPos = Math.max(padding, topPos); const maxTop = window.innerHeight - popoverRect.height - padding; topPos = Math.min(topPos, maxTop); popover.style.left = `${leftPos}px`; popover.style.top = `${topPos}px`; popover.style.visibility = 'visible'; currentTriggerElement = triggerElement; document.addEventListener('click', closePopoverOnClickOutside); }
    let currentTriggerElement = null;
    function closePopover() { popover.style.display = 'none'; document.removeEventListener('click', closePopoverOnClickOutside); currentTriggerElement = null; editingColorIndex = -1; }
    function closePopoverOnClickOutside(event) { const isClickInsidePopover = popover.contains(event.target); const isClickOnTrigger = currentTriggerElement && currentTriggerElement.contains(event.target); if (!isClickInsidePopover && !isClickOnTrigger && popover.style.display === 'flex') { closePopover(); } }
    
   addColorBtn.addEventListener('click', () => { editingColorIndex = -1; pickerHSLA = { h: 0, s: 100, l: 50, a: 1 }; gradientStops = [{ percent: 0, color: '#D966FF', alpha: 1 }, { percent: 100, color: '#823D99', alpha: 1 }]; isVerticalFlip = false; activeStopIndex = 0; selectLinearType('Linear'); updatePickerVisuals(); updateGradientVisuals(); cpHeaderTitle.textContent = "Add Color"; cpAddConfirmBtn.textContent = "Add Color"; openPopover(addColorBtn); });
   cpCloseBtn.addEventListener('click', closePopover); cpAddConfirmBtn.addEventListener('click', confirmAddColor);

    function hslToHex(h, s, l) { l /= 100; const a = s * Math.min(l, 1 - l) / 100; const f = n => { const k = (n + h / 30) % 12; const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1); return Math.round(255 * color).toString(16).padStart(2, '0'); }; return `#${f(0)}${f(8)}${f(4)}`.toUpperCase(); }
    function hexToHsl(hex) { let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); if (!result) return { h: 0, s: 0, l: 0 }; let r = parseInt(result[1], 16) / 255; let g = parseInt(result[2], 16) / 255; let b = parseInt(result[3], 16) / 255; const max = Math.max(r, g, b), min = Math.min(r, g, b); let h, s, l = (max + min) / 2; if (max === min) { h = s = 0; } else { const d = max - min; s = l > 0.5 ? d / (2 - max - min) : d / (max + min); switch (max) { case r: h = (g - b) / d + (g < b ? 6 : 0); break; case g: h = (b - r) / d + 2; break; case b: h = (r - g) / d + 4; break; } h *= 60; } return { h: h, s: s * 100, l: l * 100 }; }
    function hsvToHsl(h, s, v) { s /= 100; v /= 100; let l = (2 - s) * v / 2; if (l !== 0) { if (l === 1) { s = 0; } else if (l < 0.5) { s = s * v / (l * 2); } else { s = s * v / (2 - l * 2); } } return { h: h, s: s * 100, l: l * 100 }; }
    function hslToHsv(h, s, l) { s /= 100; l /= 100; let v = l + s * Math.min(l, 1 - l); let sv = l === 0 ? 0 : 2 * (1 - l / v); return { h: h, s: sv * 100, v: v * 100 }; }

    document.querySelectorAll('.shape-tab-trigger').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.shape-tab-trigger').forEach(t => t.removeAttribute('data-state')); tab.setAttribute('data-state', 'active'); activeShapeTab = tab.getAttribute('data-target');
            if (activeShapeTab === 'preset') { 
                presetShapesContainer.style.display = 'block'; emojiShapesContainer.style.display = 'none'; flagShapesContainer.style.display = 'none'; particleColorSection.classList.remove('section-disabled'); 
            } else if (activeShapeTab === 'emoji') { 
                presetShapesContainer.style.display = 'none'; emojiShapesContainer.style.display = 'block'; flagShapesContainer.style.display = 'none'; particleColorSection.classList.add('section-disabled'); 
            } else {
                presetShapesContainer.style.display = 'none'; emojiShapesContainer.style.display = 'none'; flagShapesContainer.style.display = 'block'; particleColorSection.classList.add('section-disabled');
            }
            updatePreview(false); 
        });
    });

    document.querySelectorAll('.id-shape-selector .selector-item').forEach(item => {
       item.addEventListener('click', () => {
           const val = item.getAttribute('data-value'); if (val === 'custom') return; 
           const currentState = item.getAttribute('data-state'); item.setAttribute('data-state', currentState === 'selected' ? '' : 'selected'); updatePreview(false);
       });
    });

    const modernEmojis = [
        { char: 'üòÄ', name: 'Happy' }, { char: 'üòÉ', name: 'Grinning' }, { char: 'üòÑ', name: 'Smiling' }, { char: 'üòÅ', name: 'Beaming' },
        { char: 'üòÜ', name: 'Squinting' }, { char: 'üòÖ', name: 'Sweat Smile' }, { char: 'üòÇ', name: 'Tears of Joy' }, { char: 'ü§£', name: 'ROFL' },
        { char: 'ü•≤', name: 'Smiling Tear' }, { char: '‚ò∫Ô∏è', name: 'Calm Smile' }, { char: 'üòä', name: 'Proud' }, { char: 'üòá', name: 'Halo' },
        { char: 'üôÇ', name: 'Slightly Happy' }, { char: 'üôÉ', name: 'Upside Down' }, { char: 'üòâ', name: 'Winking' }, { char: 'üòå', name: 'Relieved' },
        { char: 'üòç', name: 'Heart Eyes' }, { char: 'ü•∞', name: 'Loving' }, { char: 'üòò', name: 'Kissing' }, { char: 'üòó', name: 'Kiss' },
        { char: 'üòô', name: 'Soft Kiss' }, { char: 'üòö', name: 'Closed Kiss' }, { char: 'üòã', name: 'Yum' }, { char: 'üòõ', name: 'Tongue Out' },
        { char: 'üòù', name: 'Squinting Tongue' }, { char: 'üòú', name: 'Wink Tongue' }, { char: 'ü§™', name: 'Zany' }, { char: 'ü§®', name: 'Raised Eyebrow' },
        { char: 'üßê', name: 'Monocle' }, { char: 'ü§ì', name: 'Nerd' }, { char: 'üòé', name: 'Cool' }, { char: 'ü•∏', name: 'Disguised' },
        { char: 'ü§©', name: 'Star Struck' }, { char: 'ü•≥', name: 'Partying' }, { char: 'üòè', name: 'Smirking' }, { char: 'üòí', name: 'Unamused' },
        { char: 'üòû', name: 'Disappointed' }, { char: 'üòî', name: 'Pensive' }, { char: 'üòü', name: 'Worried' }, { char: 'üòï', name: 'Confused' },
        { char: 'üôÅ', name: 'Slightly Frown' }, { char: '‚òπÔ∏è', name: 'Frowning' }, { char: 'üò£', name: 'Persevering' }, { char: 'üòñ', name: 'Confounded' },
        { char: 'üò´', name: 'Tired' }, { char: 'üò©', name: 'Weary' }, { char: 'ü•∫', name: 'Pleading' }, { char: 'üò¢', name: 'Crying' },
        { char: 'üò≠', name: 'Sobbing' }, { char: 'üò§', name: 'Steam Nose' }, { char: 'üò†', name: 'Angry' }, { char: 'üò°', name: 'Pouting' },
        { char: 'ü§¨', name: 'Cursing' }, { char: 'ü§Ø', name: 'Mind Blown' }, { char: 'üò≥', name: 'Flushed' }, { char: 'ü•µ', name: 'Hot' },
        { char: 'ü•∂', name: 'Cold' }, { char: 'üò±', name: 'Screaming' }, { char: 'üò®', name: 'Fearful' }, { char: 'üò∞', name: 'Anxious' },
        { char: 'üò•', name: 'Sad Relieved' }, { char: 'üòì', name: 'Downcast' }, { char: 'ü§ó', name: 'Hugging' }, { char: 'ü§î', name: 'Thinking' },
        { char: 'ü§≠', name: 'Hand Over Mouth' }, { char: 'ü§´', name: 'Shushing' }, { char: 'ü§•', name: 'Lying' }, { char: 'üò∂', name: 'No Mouth' },
        { char: 'üòê', name: 'Neutral' }, { char: 'üòë', name: 'Expressionless' }, { char: 'üò¨', name: 'Grimacing' }, { char: 'üôÑ', name: 'Rolling Eyes' },
        { char: 'üòØ', name: 'Hushed' }, { char: 'üò¶', name: 'Open Mouth Frown' }, { char: 'üòß', name: 'Anguished' }, { char: 'üòÆ', name: 'Open Mouth' },
        { char: 'üò≤', name: 'Astonished' }, { char: 'ü•±', name: 'Yawning' }, { char: 'üò¥', name: 'Sleeping' }, { char: 'ü§§', name: 'Drooling' },
        { char: 'üò™', name: 'Sleepy' }, { char: 'üòµ', name: 'Dizzy' }, { char: 'ü§ê', name: 'Zipped' }, { char: 'ü•¥', name: 'Woozy' },
        { char: 'ü§¢', name: 'Nauseated' }, { char: 'ü§Æ', name: 'Vomiting' }, { char: 'ü§ß', name: 'Sneezing' }, { char: 'üò∑', name: 'Masked' },
        { char: 'üí§', name: 'Zzz' }, { char: 'ü§í', name: 'Thermometer' }, { char: 'ü§ï', name: 'Bandaged' }, { char: 'ü§ë', name: 'Money Mouth' },
        { char: 'ü§†', name: 'Cowboy' }, { char: 'üòà', name: 'Happy Horns' }, { char: 'üëø', name: 'Angry Horns' }, { char: 'üëπ', name: 'Ogre' },
        { char: 'üë∫', name: 'Goblin' }, { char: 'ü§°', name: 'Clown' }, { char: 'üí©', name: 'Poo' }, { char: 'üëª', name: 'Ghost' },
        { char: 'üíÄ', name: 'Skull' }, { char: '‚ò†Ô∏è', name: 'Skull Cross' }, { char: 'üëΩ', name: 'Alien' }, { char: 'üëæ', name: 'Monster' },
        { char: 'ü§ñ', name: 'Robot' }, { char: 'üéÉ', name: 'Pumpkin' }, { char: 'üò∫', name: 'Cat Smile' }, { char: 'üò∏', name: 'Cat Grin' },
        { char: 'üòπ', name: 'Cat Joy' }, { char: 'üòª', name: 'Cat Hearts' }, { char: 'üòº', name: 'Cat Wry' }, { char: 'üòΩ', name: 'Cat Kiss' },
        { char: 'üôÄ', name: 'Cat Weary' }, { char: 'üòø', name: 'Cat Crying' }, { char: 'üòæ', name: 'Cat Pouting' }
    ];

    modernEmojis.forEach(emojiData => {
        const emojiItem = document.createElement('div'); emojiItem.className = 'emoji-item'; emojiItem.textContent = emojiData.char;
        emojiItem.setAttribute('data-tooltip', emojiData.name);
        emojiItem.addEventListener('click', () => {
            const index = selectedEmojis.indexOf(emojiData.char); if (index > -1) { selectedEmojis.splice(index, 1); emojiItem.removeAttribute('data-state'); } else { selectedEmojis.push(emojiData.char); emojiItem.setAttribute('data-state', 'selected'); }
            updatePreview(false);
        });
        emojiGrid.appendChild(emojiItem);
    });

    const flagNames = { 
        'us': 'United States', 'gb': 'United Kingdom', 'fr': 'France', 'de': 'Germany', 
        'jp': 'Japan', 'ca': 'Canada', 'br': 'Brazil', 'au': 'Australia', 
        'cn': 'China', 'in': 'India', 'mx': 'Mexico', 'it': 'Italy', 
        'es': 'Spain', 'kr': 'South Korea', 'se': 'Sweden', 'no': 'Norway', 
        'nl': 'Netherlands', 'be': 'Belgium', 'ch': 'Switzerland', 'at': 'Austria' 
    };

    Object.keys(flagNames).forEach(code => {
        const flagItem = document.createElement('div'); 
        flagItem.className = 'flag-item'; 
        flagItem.setAttribute('data-tooltip', flagNames[code]);
        flagItem.innerHTML = `<img src="https://flagcdn.com/${code}.svg" draggable="false">`;
        flagItem.addEventListener('click', async () => {
            const index = selectedFlags.indexOf(code);
            if (index > -1) { 
                selectedFlags.splice(index, 1); flagItem.removeAttribute('data-state'); 
            } else { 
                selectedFlags.push(code); flagItem.setAttribute('data-state', 'selected');
                if (!flagDataCache[code]) {
                    try {
                        const response = await fetch(`https://flagcdn.com/${code}.svg`);
                        const svgText = await response.text();
                        flagDataCache[code] = svgText;
                    } catch (e) { console.error("Failed to fetch flag SVG", e); }
                }
            }
            updatePreview(false);
        });
        flagGrid.appendChild(flagItem);
    });

    const initialCsState = { anchors: [{x: 60, y: 60}, {x: 260, y: 60}, {x: 260, y: 260}, {x: 60, y: 260}], controls: [{dx: 0, dy: -30}, {dx: -30, dy: 0}, {dx: 30, dy: 0}, {dx: 0, dy: -30}, {dx: 0, dy: 30}, {dx: 30, dy: 0}, {dx: -30, dy: 0}, {dx: 0, dy: 30}] };
    let csState = JSON.parse(JSON.stringify(initialCsState)); let draggingElement = null; let dragStartIndex = -1; 
    
    function renderEditorCanvas() {
        csEditorSvg.innerHTML = ''; 
        csEditorSvg.setAttribute('viewBox', finalCustomViewBox);
        const a = csState.anchors; const c = csState.controls;
        let d;
        if (finalCustomShapePathStr && csResetIcon.style.display === 'block') {
            d = finalCustomShapePathStr;
        } else {
            d = `M ${a[0].x},${a[0].y} `; d += `C ${a[0].x + c[0].dx},${a[0].y + c[0].dy} ${a[1].x + c[3].dx},${a[1].y + c[3].dy} ${a[1].x},${a[1].y} `; d += `C ${a[1].x + c[2].dx},${a[1].y + c[2].dy} ${a[2].x + c[5].dx},${a[2].y + c[5].dy} ${a[2].x},${a[2].y} `; d += `C ${a[2].x + c[4].dx},${a[2].y + c[4].dy} ${a[3].x + c[7].dx},${a[3].y + c[7].dy} ${a[3].x},${a[3].y} `; d += `C ${a[3].x + c[6].dx},${a[3].y + c[6].dy} ${a[0].x + c[1].dx},${a[0].y + c[1].dy} ${a[0].x},${a[0].y} Z`;
        }
        const pathPreview = createSvgElement('path', { d: d, class: 'cs-path-preview' }); csEditorSvg.appendChild(pathPreview);
        if (!(finalCustomShapePathStr && csResetIcon.style.display === 'block')) {
            const drawCircle = (x, y, cls, idx, type) => { const circle = createSvgElement('circle', { cx: x, cy: y, r: 6, class: cls }); circle.addEventListener('mousedown', (e) => startDrag(e, idx, type)); return circle; };
            const drawLine = (x1, y1, x2, y2) => createSvgElement('line', { x1, y1, x2, y2, class: 'cs-connector' });
            csEditorSvg.appendChild(drawLine(a[0].x, a[0].y, a[0].x + c[0].dx, a[0].y + c[0].dy)); csEditorSvg.appendChild(drawLine(a[0].x, a[0].y, a[0].x + c[1].dx, a[0].y + c[1].dy)); csEditorSvg.appendChild(drawLine(a[1].x, a[1].y, a[1].x + c[2].dx, a[1].y + c[2].dy)); csEditorSvg.appendChild(drawLine(a[1].x, a[1].y, a[1].x + c[3].dx, a[1].y + c[3].dy)); csEditorSvg.appendChild(drawLine(a[2].x, a[2].y, a[2].x + c[5].dx, a[2].y + c[5].dy)); csEditorSvg.appendChild(drawLine(a[2].x, a[2].y, a[2].x + c[5].dx, a[2].y + c[5].dy)); csEditorSvg.appendChild(drawLine(a[3].x, a[3].y, a[3].x + c[6].dx, a[3].y + c[6].dy)); csEditorSvg.appendChild(drawLine(a[3].x, a[3].y, a[3].x + c[7].dx, a[3].y + c[7].dy));
            c.forEach((ctrl, i) => { const anchorIdx = Math.floor(i / 2); const absX = a[anchorIdx].x + ctrl.dx; const absY = a[anchorIdx].y + ctrl.dy; csEditorSvg.appendChild(drawCircle(absX, absY, 'cs-control', i, 'control')); }); a.forEach((p, i) => { csEditorSvg.appendChild(drawCircle(p.x, p.y, 'cs-anchor', i, 'anchor')); });
        }
    }
    function startDrag(e, index, type) { csHistory.push(JSON.parse(JSON.stringify(csState))); draggingElement = type; dragStartIndex = index; document.addEventListener('mousemove', onDrag); document.addEventListener('mouseup', stopDrag); }
    function onDrag(e) { if (!draggingElement) return; const rect = csEditorSvg.getBoundingClientRect(); const x = Math.max(0, Math.min(320, e.clientX - rect.left)); const y = Math.max(0, Math.min(320, e.clientY - rect.top)); if (draggingElement === 'anchor') { csState.anchors[dragStartIndex] = {x, y}; } else if (draggingElement === 'control') { const anchorIdx = Math.floor(dragStartIndex / 2); const anchor = csState.anchors[anchorIdx]; csState.controls[dragStartIndex] = { dx: x - anchor.x, dy: y - anchor.y }; } renderEditorCanvas(); }
    function stopDrag() { draggingElement = null; dragStartIndex = -1; document.removeEventListener('mousemove', onDrag); document.removeEventListener('mouseup', stopDrag); }
    function undoShape() { if (csHistory.length > 0) { csState = csHistory.pop(); renderEditorCanvas(); } }
    document.addEventListener('keydown', (e) => { if (e.ctrlKey || e.metaKey) { if (e.key.toLowerCase() === 'z' && !e.shiftKey) { if (customShapePopover.style.display === 'flex') { e.preventDefault(); undoShape(); } } } });
    customShapeBtn.addEventListener('click', () => { customShapePopover.style.display = 'flex'; renderEditorCanvas(); });
    csCloseBtn.addEventListener('click', () => { customShapePopover.style.display = 'none'; });
    csSaveBtn.addEventListener('click', () => { 
        if (!(finalCustomShapePathStr && csResetIcon.style.display === 'block')) {
            const previewPath = csEditorSvg.querySelector('.cs-path-preview'); 
            if (previewPath) { finalCustomShapePathStr = previewPath.getAttribute('d'); }
        }
        customShapeBtn.setAttribute('data-state', 'selected'); 
        document.querySelectorAll('.id-shape-selector .selector-item:not(#customShapeBtn)').forEach(item => { item.removeAttribute('data-state'); }); 
        csResetIcon.style.display = 'block'; 
        customShapePopover.style.display = 'none'; 
        updatePreview(false); 
    });
    csResetIcon.addEventListener('click', () => { 
        csState = JSON.parse(JSON.stringify(initialCsState)); csHistory = []; finalCustomShapePathStr = ""; finalCustomViewBox = "0 0 320 320"; csResetIcon.style.display = 'none'; renderEditorCanvas(); customShapeBtn.removeAttribute('data-state'); updatePreview(false); 
    });

    csImportBtn.addEventListener('click', () => { csFileInput.value = ""; csFileInput.click(); });
    csFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const parser = new DOMParser(); const doc = parser.parseFromString(e.target.result, "image/svg+xml");
            const svgEl = doc.querySelector('svg'); const paths = doc.querySelectorAll('path');
            const viewBox = svgEl.getAttribute('viewBox');
            if (viewBox) { finalCustomViewBox = viewBox; } else {
                const w = svgEl.getAttribute('width') || 320; const h = svgEl.getAttribute('height') || 320; finalCustomViewBox = `0 0 ${w} ${h}`;
            }
            let pathData = ""; paths.forEach(p => { pathData += p.getAttribute('d') + " "; });
            if (pathData) { finalCustomShapePathStr = pathData.trim(); csResetIcon.style.display = 'block'; renderEditorCanvas(); }
        };
        reader.readAsText(file);
    });

    function getSettings() {
        let selectedShapes = []; let customPath = null;
        if (activeShapeTab === 'preset') { 
            selectedShapes = Array.from(document.querySelectorAll('.id-shape-selector .selector-item[data-state="selected"]:not(#customShapeBtn)')).map(el => el.getAttribute('data-value')); if (customShapeBtn.getAttribute('data-state') === 'selected') { selectedShapes.push('custom'); customPath = finalCustomShapePathStr; } 
        }
        const currentSelectedFlagsData = selectedFlags.map(code => ({ code, svg: flagDataCache[code] }));
        return {
            shapeTab: activeShapeTab, selectedShapes, selectedEmojis, selectedFlags: currentSelectedFlagsData, customShapePath: customPath, customViewBox: finalCustomViewBox,
            randomness: parseInt(document.getElementById('randomInput').value), amount: parseInt(document.getElementById('amountInput').value), zoom: parseInt(document.getElementById('zoomInput').value),
            flutter: parseInt(document.getElementById('flutterInput').value),
            randomizeSize: document.getElementById('checkSize').checked, randomizeRotation: document.getElementById('checkRotation').checked,
            colorData: { isMultiColor: colorState.isMultiColor, customColors: colorState.colors },
            frameCount: parseInt(document.getElementById('frameCountInput').value) || 1, frameDelay: parseInt(document.getElementById('frameDelayInput').value) || 50
        };
    }
    
    document.getElementById('generateBtn').addEventListener('click', (e) => { 
        const btn = e.currentTarget;
        const btnText = document.getElementById('generateBtnText');
        const settings = getSettings(); 
        btn.disabled = true; btn.classList.add('btn-loading');
        btnText.textContent = "Generating...";
        if (settings.amount === 0) { parent.postMessage({ pluginMessage: { type: 'generate-empty-frame' } }, '*'); } 
        else { parent.postMessage({ pluginMessage: { type: 'generate-confetti', settings: settings } }, '*'); } 
    });
    
    function resetPluginState() { 
        document.getElementById('randomInput').value = 90; document.getElementById('amountInput').value = 2; document.getElementById('zoomInput').value = 10; document.getElementById('flutterInput').value = 100;
        document.getElementById('checkSize').checked = true; document.getElementById('checkRotation').checked = true; colorState = { isMultiColor: false, colors: [] }; multiColorSwitch.checked = false; renderColorList(); editingColorIndex = -1; document.querySelector('.shape-tab-trigger[data-target="preset"]').click(); document.querySelectorAll('.id-shape-selector .selector-item').forEach(item => { const val = item.getAttribute('data-value'); if(val === 'rectangle' || val === 'circle' || val === 'star') { item.setAttribute('data-state', 'selected'); } else { item.removeAttribute('data-state'); } }); csState = JSON.parse(JSON.stringify(initialCsState)); customShapeBtn.removeAttribute('data-state'); finalCustomShapePathStr = ""; finalCustomViewBox = "0 0 320 320"; csResetIcon.style.display = 'none'; selectedEmojis = []; selectedFlags = []; document.querySelectorAll('.emoji-item, .flag-item').forEach(i => i.removeAttribute('data-state')); if (emojiGrid.firstChild) { selectedEmojis.push(modernEmojis[0].char); emojiGrid.firstChild.setAttribute('data-state', 'selected'); } 
        document.getElementById('frameCountInput').value = 20; 
        document.getElementById('frameDelayInput').value = 100; 
        document.getElementById('randomInput').dispatchEvent(new Event('input')); document.getElementById('amountInput').dispatchEvent(new Event('input')); document.getElementById('zoomInput').dispatchEvent(new Event('input')); document.getElementById('flutterInput').dispatchEvent(new Event('input'));
        updatePreview(false); if (panzoomInstance) panzoomInstance.reset(); 
    }
    document.getElementById('resetBtn').addEventListener('click', resetPluginState);

    // HOW IT WORKS OVERLAY CONTROLS
    document.getElementById('howItWorksBtn').addEventListener('click', () => {
      document.getElementById('howItWorksPage').classList.add('show');
    });

    document.getElementById('closeHowItWorks').addEventListener('click', () => {
      document.getElementById('howItWorksPage').classList.remove('show');
    });

    // RESTORED FLAG PREVIEW LOGIC
    function renderPreview() {
        const settings = getSettings(); 
        previewSvg.innerHTML = ''; const defs = createSvgElement('defs', {}); previewSvg.appendChild(defs); 
        const globalZoom = settings.zoom / 10; 
        const sessionSalt = Math.random().toString(36).substring(2, 7);

        previewParticles.forEach((p, index) => { 
            let el; const baseSize = 24; 
            const globalScale = p.scale * globalZoom;
            const flipScale = Math.max(0.01, Math.abs(p.flipFactor !== undefined ? p.flipFactor : 1));
            const transformStr = `translate(${p.x}, ${p.y}) rotate(${p.rotation}) scale(${globalScale}, ${globalScale * flipScale})`; 

            if (p.isEmoji) { 
                el = createSvgElement('text', { x: 0, y: 0, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': baseSize + 'px', 'font-family': '"Apple Color Emoji", "Segoe UI Emoji", NotoColorEmoji, "Noto Color Emoji", sans-serif', 'transform': transformStr }); el.textContent = p.shapeType; 
            } else if (p.shapeType === 'flag' && p.flagSvg) {
                const parser = new DOMParser(); 
                const svgDoc = parser.parseFromString(p.flagSvg, "image/svg+xml"); 
                const innerSvg = svgDoc.querySelector('svg');
                if (innerSvg) {
                    const viewBoxStr = innerSvg.getAttribute('viewBox') || `0 0 ${innerSvg.getAttribute('width') || 24} ${innerSvg.getAttribute('height') || 24}`;
                    const vb = viewBoxStr.split(' ').map(Number);
                    const w = vb[2], h = vb[3];
                    const aspectRatio = w / h;
                    const targetArea = 960;
                    const normH = Math.sqrt(targetArea / aspectRatio);
                    const normalizedScale = globalScale * (normH / 24);
                    const finalTransform = `translate(${p.x}, ${p.y}) rotate(${p.rotation}) scale(${normalizedScale}, ${normalizedScale * flipScale})`;
                    const g = createSvgElement('g', { transform: finalTransform });
                    const internalScale = 24 / Math.max(w, h); 
                    const innerG = createSvgElement('g', { transform: `scale(${internalScale * aspectRatio}) translate(${-w/2}, ${-h/2})` });
                    Array.from(innerSvg.childNodes).forEach(node => { if (node.nodeType === 1) innerG.appendChild(node.cloneNode(true)); });
                    g.appendChild(innerG); el = g;
                }
            } else { 
                let fill; let opacity = 1; 
                if (!p.color) { fill = '#CBD5E1'; } 
                else if (p.color.type === 'linear') { 
                    const gradId = `p_grad_${sessionSalt}_${index}`; 
                    let gradient; const subtype = p.color.subtype; 
                    if (subtype === 'Radial' || subtype === 'Diamond' || subtype === 'Angular') {
                        gradient = createSvgElement('radialGradient', { id: gradId, cx: '50%', cy: '50%', r: '50%' });
                    } else {
                        gradient = createSvgElement('linearGradient', { id: gradId, gradientUnits: "objectBoundingBox", x1: '0%', y1: '0%', x2: p.color.isVertical ? '0%' : '100%', y2: p.color.isVertical ? '100%' : '0%' }); 
                    }
                    p.color.gradientStops.forEach(stop => { 
                        const r = Math.round(stop.color.r * 255); const g = Math.round(stop.color.g * 255); const b = Math.round(stop.color.b * 255); 
                        const stopEl = createSvgElement('stop', { offset: `${stop.position * 100}%`, 'stop-color': `rgb(${r},${g},${b})`, 'stop-opacity': stop.color.a }); 
                        gradient.appendChild(stopEl); 
                    }); 
                    defs.appendChild(gradient); fill = `url(#${gradId})`; 
                } else { 
                    const r = Math.round(p.color.r * 255); const g = Math.round(p.color.g * 255); const b = Math.round(p.color.b * 255); 
                    fill = `rgb(${r}, ${g}, ${b})`; opacity = p.color.a !== undefined ? p.color.a : 1; 
                } 
                const commonAttrs = { fill: fill, 'fill-opacity': opacity, 'transform': transformStr }; 
                if (p.shapeType === 'custom' && p.customPathData) {
                    const vbParts = p.customViewBox.split(' ').map(Number);
                    const pathScale = baseSize / Math.max(vbParts[2], vbParts[3]); 
                    el = createSvgElement('path', { d: p.customPathData, transform: `${transformStr} scale(${pathScale}) translate(${-vbParts[0] - vbParts[2]/2}, ${-vbParts[1] - vbParts[3]/2})`, fill: fill, 'fill-opacity': opacity }); 
                } else if (p.shapeType === 'rectangle') { el = createSvgElement('rect', { x: -(baseSize * 1.33) / 2, y: -baseSize / 2, width: baseSize * 1.33, height: baseSize, rx: 2, ...commonAttrs }); } 
                else if (p.shapeType === 'square') { el = createSvgElement('rect', { x: -baseSize / 2, y: -baseSize / 2, width: baseSize, height: baseSize, rx: 2, ...commonAttrs }); } 
                else if (p.shapeType === 'circle') { el = createSvgElement('circle', { cx: 0, cy: 0, r: baseSize / 2, ...commonAttrs }); } 
                else if (p.shapeType === 'star') { const points = "0,-12 3.5,-3.5 12,-3.5 5,2.5 8,11 0,6 -8,11 -5,2.5 -12,-3.5 -3.5,-3.5"; el = createSvgElement('polygon', { points: points, ...commonAttrs }); } 
                else if (p.shapeType === 'wave') { el = createSvgElement('path', { d: "M16.625 18C17.6917 15.3333 16.7583 14.2667 13.825 14.8C11.1583 15.6 10.3583 14.6667 11.425 12C12.7583 9.33333 11.9583 8.4 9.025 9.2C6.09167 10 5.29167 8.93333 6.625 6", stroke: fill, 'stroke-width': 2, 'stroke-linecap': 'round', fill: 'none', 'fill-opacity': 0, 'stroke-opacity': opacity, transform: `${transformStr} translate(-12, -12)` }); } 
            } 
            if(el) previewSvg.appendChild(el); 
        }); 
    }

    function updatePreview(keepPositions, changeType) { const settings = getSettings(); if (settings.amount === 0) { previewParticles = []; renderPreview(); return; } parent.postMessage({ pluginMessage: { type: 'preview-confetti', settings: settings, keepPositions, changeType } }, '*'); }
    window.onmessage = (event) => { 
        const msg = event.data.pluginMessage; 
        if (msg && msg.type === 'preview-data') { previewParticles = msg.particles; renderPreview(); } 
        else if (msg && msg.type === 'generation-complete') { 
            const btn = document.getElementById('generateBtn'); 
            const btnText = document.getElementById('generateBtnText');
            btn.disabled = false; btn.classList.remove('btn-loading'); 
            btnText.textContent = "Generate Confetti";

            // SHOW SUCCESS TOAST
            const toast = document.getElementById('successToast');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    };
    panzoomInstance = Panzoom(panzoomContainer, { maxScale: 5, minScale: 0.1, contain: 'outside', startScale: 1 });
    panzoomContainer.parentElement.addEventListener('wheel', panzoomInstance.zoomWithWheel);
    if (emojiGrid.firstChild) { emojiGrid.firstChild.click(); }
    setTimeout(() => { resetPluginState(); }, 250);
  </script>
</body>
</html>