<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Confetti Animator</title>
  <style>
    /* --- CSS STYLES (Same as before) --- */
    :root {
      --primary-blue: #1890FF;
      --text-dark: #333333;
      --text-gray: #888888;
      --bg-gray: #F5F5F5;
      --border-color: #E8E8E8;
      --border-radius: 8px;
      --selected-bg-gray: #EEEEEE;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #FFFFFF; color: var(--text-dark); display: flex; height: 100vh; overflow: hidden; }
    .header { position: absolute; top: 0; left: 0; right: 0; height: 48px; display: flex; justify-content: space-between; align-items: center; padding: 0 16px; border-bottom: 1px solid var(--border-color); background: #fff; z-index: 10; }
    .title { font-weight: 600; font-size: 16px; display: flex; align-items: center; }
    .title-icon { margin-right: 8px; font-size: 20px; }
    .close-btn { cursor: pointer; padding: 4px; color: var(--text-gray); }
    .main-container { display: flex; width: 100%; margin-top: 48px; height: calc(100% - 48px); }
    .left-panel { width: 400px; padding: 24px; border-right: 1px solid var(--border-color); overflow-y: auto; flex-shrink: 0; display: flex; flex-direction: column; }
    .right-panel { flex: 1; padding: 24px; background-color: #fff; display: flex; flex-direction: column; justify-content: flex-start; }
    .control-group { margin-bottom: 24px; }
    .control-label { font-weight: 600; font-size: 14px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
    .tabs { display: flex; background-color: var(--bg-gray); border-radius: var(--border-radius); padding: 4px; margin-bottom: 24px; }
    .tab { flex: 1; text-align: center; padding: 8px 0; font-size: 14px; font-weight: 500; border-radius: 6px; cursor: pointer; color: var(--text-gray); transition: all 0.2s; }
    .tab.active { background-color: #FFFFFF; color: var(--text-dark); box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.05); }
    .slider-container { position: relative; height: 32px; border-radius: var(--border-radius); background-color: var(--bg-gray); overflow: hidden; margin-bottom: 8px; }
    .slider-progress { position: absolute; height: 100%; background-color: var(--primary-blue); border-radius: var(--border-radius); pointer-events: none; }
    .slider-value-display { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-weight: 600; font-size: 14px; color: var(--text-dark); pointer-events: none; z-index: 2; }
    input[type=range] { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; margin: 0; }
    .slider-labels { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-gray); }
    .color-input-row { display: flex; gap: 8px; margin-bottom: 16px; }
    .eyedropper-btn { width: 40px; height: 40px; border-radius: var(--border-radius); background: var(--bg-gray); display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-dark); }
    .color-value-input { flex: 1; display: flex; align-items: center; background: var(--bg-gray); border-radius: var(--border-radius); padding: 0 12px; height: 40px; }
    .color-preview { width: 24px; height: 24px; border-radius: 4px; margin-right: 12px; background: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet); }
    .color-text { flex: 1; font-size: 14px; font-weight: 500; }
    .color-percent { color: var(--text-gray); font-size: 14px; }
    .color-swatches { display: flex; gap: 12px; align-items: center; }
    .swatch { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; box-sizing: border-box; position: relative; }
    .swatch.selected::after { content: ''; position: absolute; top: -4px; right: -4px; bottom: -4px; left: -4px; border-radius: 50%; border: 2px solid var(--primary-blue); }
    .swatch.multi { background: linear-gradient(135deg, #FFD700, #FF8C00); }
    .swatch.silver { background: linear-gradient(135deg, #E0E0E0, #BDBDBD); }
    .swatch.rose { background: linear-gradient(135deg, #FF6B6B, #C44D4D); }
    .swatch.purple { background: linear-gradient(135deg, #BA55D3, #8A2BE2); }
    .swatch.blue { background: #1890FF; }
    .swatch.magenta { background: #D900D6; }
    .swatch.red { background: #D9001B; }
    .swatch.green { background: #52C41A; }
    .swatch.rainbow { background: linear-gradient(135deg, red, orange, yellow, green, blue, indigo, violet); }
    .selection-row { display: flex; gap: 16px; }
    .select-btn { width: 48px; height: 48px; border-radius: 12px; display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; color: var(--text-gray); transition: all 0.2s; border: 2px solid transparent; background: transparent; }
    .shape-selector .select-btn { border-color: var(--border-color); background: #fff; }
    .shape-selector .select-btn.disabled { background: #D9D9D9; border: none; cursor: default; }
    .shape-selector .select-btn.disabled svg { display: none; }
    .select-btn.selected { color: var(--text-dark); }
    .shape-selector .select-btn.selected { border-color: var(--primary-blue); color: var(--primary-blue); background-color: #E6F7FF; }
    .device-selector .select-btn.selected { background-color: var(--selected-bg-gray); color: var(--text-dark); }
    .select-btn svg { width: 24px; height: 24px; }
    .checkmark { position: absolute; top: -6px; right: -6px; width: 18px; height: 18px; background: var(--primary-blue); border-radius: 50%; border: 2px solid #fff; display: none; align-items: center; justify-content: center; color: white; font-size: 10px; }
    .select-btn.selected .checkmark { display: flex; }
    .footer { display: flex; gap: 16px; margin-top: auto; padding-top: 24px; }
    .btn { height: 44px; border-radius: var(--border-radius); font-weight: 600; font-size: 16px; cursor: pointer; border: none; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; }
    .btn-primary { flex: 2; background-color: var(--primary-blue); color: white; }
    .btn-primary:hover { background-color: #1480E3; }
    .btn-secondary { flex: 1; background-color: var(--bg-gray); color: var(--text-dark); }
    .btn-secondary:hover { background-color: #D9D9D9; }
    .preview-header { font-weight: 600; font-size: 16px; margin-bottom: 24px; }
    .preview-box { flex: none; height: 360px; background-color: #fff; border-radius: 16px; border: 1px solid var(--border-color); background-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect x="10" y="10" width="5" height="8" fill="%23FF5733"/><circle cx="30" cy="30" r="4" fill="%2333FF57"/><polygon points="50,10 55,25 45,25" fill="%233357FF"/><rect x="70" y="50" width="6" height="6" fill="%23FF33A8" transform="rotate(45 73 53)"/><circle cx="90" cy="80" r="3" fill="%23FFC300"/><rect x="20" y="80" width="4" height="10" fill="%2333FFF5" transform="rotate(-30 22 85)"/></svg>'); background-size: 200px 200px; margin-bottom: 24px; }
    .play-btn { height: 44px; background-color: var(--bg-gray); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 16px; color: var(--text-dark); cursor: pointer; border: none; }
    .play-btn:hover { background-color: #D9D9D9; }
    .play-icon { margin-right: 8px; }
  </style>
</head>
<body>
  <div class="header">
    <div class="title"><span class="title-icon">ðŸŽ‰</span>Confetti Animator</div>
    <div class="close-btn" id="closeBtn">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 1L1 13M1 1L13 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </div>
  </div>

  <div class="main-container">
    <div class="left-panel">
      <div class="tabs">
        <div class="tab active">Free fall</div>
        <div class="tab">Impact Fall</div>
      </div>
      <div class="control-group">
        <div class="control-label">Fall Speed</div>
        <div class="slider-container">
          <div class="slider-progress" style="width: 60%;"></div><span class="slider-value-display">60%</span>
          <input type="range" id="speedInput" min="0" max="100" value="60">
        </div>
        <div class="slider-labels"><span>Slow</span><span>Fast</span></div>
      </div>
      <div class="control-group">
        <div class="control-label">Particle Randomness</div>
        <div class="slider-container">
          <div class="slider-progress" style="width: 60%;"></div><span class="slider-value-display">60%</span>
          <input type="range" id="randomInput" min="0" max="100" value="60">
        </div>
        <div class="slider-labels"><span>Uniform</span><span>Chaotic</span></div>
      </div>
      <div class="control-group">
        <div class="control-label">Zoom</div>
        <div class="slider-container">
          <div class="slider-progress" style="width: 10%;"></div><span class="slider-value-display">x1.0</span>
          <input type="range" id="zoomInput" min="10" max="100" value="20">
        </div>
        <div class="slider-labels"><span>x0.5</span><span>x5.0</span></div>
      </div>
      <div class="control-group">
        <div class="control-label">Color</div>
        <div class="color-input-row">
            <div class="eyedropper-btn"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 5.5L18.5 9.5L9.5 18.5C9 19 8.33333 19.3333 7.5 19.5L4 20L4.5 16.5C4.66667 15.6667 5 15 5.5 14.5L14.5 5.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M13.5 6.5L17.5 10.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
            <div class="color-value-input"><div class="color-preview"></div><div class="color-text">Multi-color</div><div class="color-percent">100%</div></div>
        </div>
        <div class="color-swatches">
          <div class="swatch multi"></div><div class="swatch silver"></div><div class="swatch rose"></div><div class="swatch purple"></div><div class="swatch blue"></div><div class="swatch magenta"></div><div class="swatch red"></div><div class="swatch green"></div><div class="swatch rainbow selected"></div>
        </div>
      </div>
      <div class="control-group">
        <div class="control-label">Shape</div>
        <div class="selection-row shape-selector">
          <div class="select-btn selected" data-group="shape" data-value="rectangle"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" stroke-width="2"/></svg><div class="checkmark">âœ“</div></div>
          <div class="select-btn disabled"></div>
          <div class="select-btn selected" data-group="shape" data-value="circle"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/></svg><div class="checkmark">âœ“</div></div>
          <div class="select-btn selected" data-group="shape" data-value="star"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><div class="checkmark">âœ“</div></div>
        </div>
      </div>
      <div class="control-group">
        <div class="control-label">Size</div>
        <div class="selection-row device-selector">
          <div class="select-btn selected" data-group="device" data-value="desktop"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="3" width="20" height="14" rx="2" stroke="currentColor" stroke-width="2"/><path d="M8 21H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M12 17V21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg><div class="checkmark">âœ“</div></div>
          <div class="select-btn" data-group="device" data-value="tablet"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="2" width="16" height="20" rx="2" stroke="currentColor" stroke-width="2"/><path d="M11 19H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></div>
          <div class="select-btn" data-group="device" data-value="mobile"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="2" width="12" height="20" rx="2" stroke="currentColor" stroke-width="2"/><path d="M11 19H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></div>
        </div>
      </div>
      <div class="footer">
        <button id="generateBtn" class="btn btn-primary">Generate Confetti</button>
        <button id="resetBtn" class="btn btn-secondary">Reset</button>
      </div>
    </div>
    <div class="right-panel">
      <div class="preview-header">Preview</div>
      <div class="preview-box"></div>
      <button id="playBtn" class="play-btn"><svg class="play-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 3L19 12L5 21V3Z" fill="currentColor"/></svg>Play</button>
    </div>
  </div>


  <script>
    // --- UI Interactions ---
    function setupSlider(inputId, valueDisplayFormat) {
      const input = document.getElementById(inputId);
      const container = input.parentElement;
      const progress = container.querySelector('.slider-progress');
      const display = container.querySelector('.slider-value-display');

      function update() {
        const value = input.value;
        const min = input.min ? input.min : 0;
        const max = input.max ? input.max : 100;
        const percentage = ((value - min) / (max - min)) * 100;
        
        progress.style.width = `${percentage}%`;
        
        if (valueDisplayFormat === 'percent') {
          display.textContent = `${value}%`;
        } else if (valueDisplayFormat === 'zoom') {
           // Map range 10-100 to x0.5 - x5.0 for display
           const zoomVal = (value / 20).toFixed(1);
           display.textContent = `x${zoomVal}`;
        }
      }
      input.addEventListener('input', update);
      update();
    }

    setupSlider('speedInput', 'percent');
    setupSlider('randomInput', 'percent');
    setupSlider('zoomInput', 'zoom');

    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => tab.addEventListener('click', () => { tabs.forEach(t => t.classList.remove('active')); tab.classList.add('active'); }));

    const swatches = document.querySelectorAll('.swatch');
    swatches.forEach(swatch => swatch.addEventListener('click', () => { swatches.forEach(s => s.classList.remove('selected')); swatch.classList.add('selected'); }));

    const selectBtns = document.querySelectorAll('.select-btn:not(.disabled)');
    selectBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const group = btn.dataset.group;
            if (group === 'device') {
                 document.querySelectorAll(`.select-btn[data-group="${group}"]`).forEach(b => b.classList.remove('selected'));
                 btn.classList.add('selected');
            } else if (group === 'shape') {
                btn.classList.toggle('selected');
            }
        });
    });

    // --- Plugin Communication ---
    function getSettings() {
      const selectedDeviceBtn = document.querySelector('.device-selector .select-btn.selected');
      // Safety check: default to desktop if nothing selected
      const device = selectedDeviceBtn ? selectedDeviceBtn.dataset.value : 'desktop';
      
      // Gather selected shapes
      let selectedShapes = Array.from(document.querySelectorAll('.shape-selector .select-btn.selected')).map(btn => btn.dataset.value);

      return {
          speed: document.getElementById('speedInput').value,
          randomness: document.getElementById('randomInput').value,
          zoom: document.getElementById('zoomInput').value,
          selectedShapes: selectedShapes,
          device: device
      };
    }
    
    // This is a comment text

    document.getElementById('closeBtn').addEventListener('click', () => parent.postMessage({ pluginMessage: { type: 'close-plugin' } }, '*'));
    document.getElementById('generateBtn').addEventListener('click', () => parent.postMessage({ pluginMessage: { type: 'generate-confetti', settings: getSettings() } }, '*'));
    // "Play" button now triggers a preview generation on canvas
    document.getElementById('playBtn').addEventListener('click', () => parent.postMessage({ pluginMessage: { type: 'preview-confetti', settings: getSettings() } }, '*'));

    document.getElementById('resetBtn').addEventListener('click', () => {
       document.getElementById('speedInput').value = 60; document.getElementById('speedInput').dispatchEvent(new Event('input'));
       document.getElementById('randomInput').value = 60; document.getElementById('randomInput').dispatchEvent(new Event('input'));
       document.getElementById('zoomInput').value = 20; document.getElementById('zoomInput').dispatchEvent(new Event('input'));
    });

  </script>
</body>
</html>